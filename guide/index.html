<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide (v47 - minor fixes pre-publishing)</title>
   <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><line x1='5' y1='50' x2='95' y2='50' stroke='%232563EB' stroke-width='18' stroke-linecap='round'/><polyline points='60 15 95 50 60 85' fill='none' stroke='%232563EB' stroke-width='18' stroke-linecap='round' stroke-linejoin='round'/><circle cx='25' cy='50' r='16' fill='white'/><circle cx='55' cy='50' r='16' fill='white'/><circle cx='85' cy='50' r='16' fill='%232563EB' stroke='white' stroke-width='3'/></svg>">
    <style>
        :root{--color-primary:#3498db;--color-primary-light:#e0e7ff;--color-secondary:#475569;--color-text:#1e293b;--color-text-secondary:#64748b;--color-background:#f4f0e9;--color-surface:#e6ded6;--color-border:#e8cbbf;--color-success:#10b981;--color-danger:#f43f5e;--color-warning:#f59e0b;--color-blocked-bg:#ffe4e6;--color-bored-bg:#fef3c7;--color-stressed-bg:#fee2e2;--color-link:#3a5973;--color-button-text:#ffffff;--color-modal-glass-bg:rgba(255, 255, 255, 0.5);--color-modal-bg:#BFDCE8}body.dark-theme{--color-primary:#3498db;--color-primary-light:rgba(79, 70, 229, 0.2);--color-secondary:#94a3b8;--color-text:#e2e8f0;--color-text-secondary:#94a3b8;--color-background:#0f172a;--color-surface:#1e293b;--color-border:#334155;--color-success:#34d399;--color-danger:#fb7185;--color-warning:#facc15;--color-blocked-bg:rgba(244, 63, 94, 0.15);--color-bored-bg:rgba(245, 158, 11, 0.15);--color-stressed-bg:rgba(239, 68, 68, 0.15);--color-link:#4dabf7;--color-button-text:#ffffff;--color-modal-glass-bg:rgba(30, 41, 59, 0.4);--color-modal-bg:#55473382}*{box-sizing:border-box;margin:0;padding:0}body,html{height:100%;overflow:hidden}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;color:var(--color-text);background-color:var(--color-background);display:flex;flex-direction:column;font-size:16px;line-height:1.6;padding:0 10px}h1,h2,h3,h4,h5,h6{color:var(--color-secondary);margin-bottom:1rem;margin-top:1.2rem;font-weight:600}h1{font-size:1.8em}h2{font-size:1.5em}h3{font-size:1.3em}a{color:var(--color-link);text-decoration:none}a:hover{text-decoration:underline}hr{border:none;border-top:1px solid var(--color-border);margin:1.5em 0}#app-footer,#app-header{background-color:var(--color-surface);padding:10px 5px;border-bottom:1px solid var(--color-border);position:sticky;z-index:100;flex-shrink:0;margin:0 -10px;padding-left:15px;padding-right:15px}#app-footer{border-bottom:none;border-top:1px solid var(--color-border)}#header-top-row{display:flex;justify-content:center;align-items:center;margin-bottom:8px;gap:10px}#header-goal-row{font-size:.9em;color:var(--color-text-secondary);text-align:center;min-height:2.5em;padding:5px 10px}#header-goal-row strong{color:var(--color-primary)}#main-content-area{flex-grow:1;overflow-y:auto;padding:15px 5px}.btn,button{display:inline-block;padding:8px 15px;font-size:.75em;font-weight:500;cursor:pointer;border:none;border-radius:8px;background-color:var(--color-primary);color:var(--color-button-text);transition:transform .1s ease,box-shadow .2s ease,background-color .2s ease;margin:5px;text-align:center;vertical-align:middle}.btn:hover:not(:disabled),button:hover:not(:disabled){opacity:.9;transform:translateY(-1px)}.btn:disabled,button:disabled{background-color:#cbd5e1;color:#64748b;cursor:not-allowed}.btn-secondary{background-color:var(--color-border);color:var(--color-secondary)}.btn-danger{background-color:var(--color-danger);color:var(--color-button-text)}.btn-success{background-color:var(--color-success);color:var(--color-button-text)}.btn-move{background-color:#94a3b8;color:#1e293b}.btn-link{background:0 0;border:none;color:var(--color-link);text-decoration:underline;padding:0 5px;margin:0 5px;font-size:.9em}.btn-icon{background:0 0;border:none;padding:8px;margin:0 5px;cursor:pointer;border-radius:50%;line-height:0}.btn-icon:hover{background-color:rgba(150,150,150,.1)}.btn-icon svg{width:22px;height:22px;stroke:var(--color-secondary);stroke-width:1.5;transition:stroke .2s ease}.btn-icon:hover svg{stroke:var(--color-primary)}#theme-toggle:hover,.back-button:hover{background:var(--color-border)}input,textarea{padding:10px;font-size:1em;border:1px solid var(--color-border);border-radius:8px;margin-bottom:10px;width:100%;background-color:var(--color-background);color:var(--color-text)}select{padding:10px;font-size:1em;border:1px solid var(--color-border);border-radius:8px;margin-bottom:10px;width:100%;background-color:var(--color-surface);color:var(--color-text)}input:focus,select:focus,textarea:focus{border-color:var(--color-primary);box-shadow:0 0 0 2px var(--color-primary-light);outline:0}textarea{min-height:150px;resize:vertical;font-family:monospace}#goal-tag-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:10px}#goal-tag-toggle input[type=checkbox]{width:auto;margin:0;cursor:pointer}#goal-tag-toggle.disabled{opacity:.5;cursor:not-allowed}#goal-tag-toggle.disabled input{cursor:not-allowed}.app-view{display:none}.app-view.active{display:block}.view-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}.view-header h2{margin-bottom:0}.goal-item,.list-item,.routine-item,.settings-section,.task-card{background-color:var(--color-surface);border:1px solid var(--color-border);border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 1px 2px rgba(0,0,0,.05)}.task-text-edit{width:100%}.task-edit-input{width:100%;padding:8px;font-size:1em;border:2px solid var(--color-primary);border-radius:8px;font-family:inherit;resize:vertical;min-height:60px}.task-edit-input:focus{outline:0;border-color:var(--color-primary);box-shadow:0 0 0 2px var(--color-primary-light)}.btn-sm{padding:4px 10px;font-size:.85em;margin:2px}.list-item{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}.item-actions{flex-shrink:0;display:flex;flex-direction:column;gap:5px;align-items:flex-end}.item-actions button{width:110px;margin:4px 0}.goal-item,.routine-item{display:flex;justify-content:space-between;align-items:center;gap:10px}.goal-item{display:grid;grid-template-columns:1fr auto}.goal-item.current-focus{border-left:4px solid var(--color-warning);background-color:var(--color-bored-bg)}.editable-content-view .view-mode{background-color:var(--color-surface);padding:15px;border-radius:12px;min-height:100px;border:1px solid var(--color-border)}#add-task-form{padding:15px;background-color:var(--color-surface);border:1px solid var(--color-border);border-radius:12px;margin-bottom:20px}#add-task-btn{font-size:1.5em;padding:0 10px;line-height:1}.task-goal-tag{font-size:.8em;font-style:italic;color:var(--color-text-secondary);display:block;margin-top:8px}.task-goal-tag a{text-decoration:none;color:var(--color-secondary)}.task-goal-tag a:hover{text-decoration:underline;color:var(--color-link)}.task-actions{display:flex;justify-content:flex-end;align-items:center;gap:5px;position:relative}.task-actions .btn-blitz{background-color:var(--color-warning);color:#1e293b;font-size:1.1em;padding:3px 8px}.btn-more{display:none}.secondary-actions-group{display:flex;gap:5px}.secondary-actions-group button{width:auto;text-align:center}.btn-label{display:none}@media (max-width:600px){.btn-more{display:inline-block}.secondary-actions-group{display:none;position:absolute;right:0;top:100%;flex-direction:column;background:var(--color-surface);border:1px solid var(--color-border);border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.2);padding:5px;z-index:100;min-width:140px}.secondary-actions-group.active{display:flex}.secondary-actions-group button{width:100%;text-align:left;margin:2px 0;padding:10px;background:0 0;color:var(--color-text);border:none;border-radius:4px}.secondary-actions-group button:hover{background-color:var(--color-border)}.btn-label{display:inline;margin-left:8px}}.task-help-suggestion{background-color:var(--color-primary-light);color:var(--color-text);border:1px solid var(--color-primary);border-radius:8px;padding:8px;margin-top:8px}.copy-button{background-color:var(--color-secondary)}.mode-selector{display:flex;justify-content:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}.mode-selector .btn{flex:1;min-width:100px;background-color:var(--color-surface);color:var(--color-text);border:1px solid var(--color-border)}.mode-selector .btn.btn-primary{background-color:var(--color-primary);color:var(--color-button-text);border-color:var(--color-primary)}.quote-box{background-color:var(--color-surface);border:1px solid var(--color-border);padding:2rem;border-radius:12px;text-align:center;margin-bottom:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.05)}.blocked-sub-view{animation:fadeIn .3s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}#blocked-view .summary{background-color:#3498db;padding:1.5rem;border-radius:8px;margin-bottom:2rem;color:#dbeafe}#stressed-view .quote-box{background-color:var(--color-stressed-bg);padding:1.5rem;border-radius:8px;margin-bottom:2rem}#stressed-view .option-btn{background-color:var(--color-secondary);color:var(--color-button-text);padding:1rem;text-align:center}#bored-view #customActionArea{padding:15px;background-color:var(--color-bored-bg);border-radius:8px;margin-top:20px;border:1px solid var(--color-warning)}#modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;display:flex;justify-content:center;align-items:center;padding:10px;background-color:rgba(15,23,42,.1);backdrop-filter:blur(4px);transition:background-color .3s ease,backdrop-filter .3s ease}#modal-overlay.hidden{background-color:rgba(15,23,42,0);backdrop-filter:blur(0px);pointer-events:none}#modal-content{max-width:90%;width:500px;border-radius:16px;padding:20px;position:relative;z-index:2;background-color:var(--color-modal-glass-bg);border:1px solid rgba(255,255,255,.1);box-shadow:0 8px 32px 0 rgba(0,0,0,.1);max-height:90vh;overflow-y:auto}#modal-content::before{content:"";position:absolute;inset:0;z-index:-1;border-radius:inherit;overflow:hidden;-webkit-backdrop-filter:blur(24px) brightness(.9);backdrop-filter:blur(24px) brightness(.9)}#modal-content>*{position:relative;z-index:1}#modal-overlay.hidden #modal-content{display:none}.hidden{display:none!important}.modal-actions{margin-top:20px;text-align:right}.modal-content{background-color:var(--color-modal-bg)}#modal-content{max-width:90%;width:500px;max-height:90vh;border-radius:16px;position:relative;z-index:2;background-color:var(--color-modal-glass-bg);border:1px solid rgba(255,255,255,.1);box-shadow:0 8px 32px 0 rgba(0,0,0,.1);display:flex;flex-direction:column}#modal-body-wrapper{flex:1;overflow-y:auto;padding:0 20px;margin:10px -20px}#modal-title{padding:20px 20px 10px 20px;margin:0;flex-shrink:0}.modal-actions{margin:0;padding:15px 20px;text-align:right;border-top:1px solid var(--color-border);flex-shrink:0;background:var(--color-modal-bg)}#toast-notification{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background-color:rgba(20,20,20,.85);color:#fff;padding:10px 20px;border-radius:8px;z-index:2000;font-size:.9em;opacity:0;transition:opacity .5s ease;pointer-events:none;box-shadow:0 4px 15px rgba(0,0,0,.2)}#toast-notification.show{opacity:1}.ai-suggestion-list{list-style-type:none;padding:0;margin:15px 0}.ai-suggestion-list li{margin-bottom:10px}.ai-suggestion-list label{display:flex;align-items:center;padding:10px;background-color:rgba(255,255,255,.5);border-radius:8px;cursor:pointer;border:1px solid transparent;transition:background-color .2s ease,border-color .2s ease}body.dark-theme .ai-suggestion-list label{background-color:rgba(0,0,0,.2)}.ai-suggestion-list label:hover{background-color:rgba(255,255,255,.8);border-color:var(--color-primary)}body.dark-theme .ai-suggestion-list label:hover{background-color:rgba(0,0,0,.4)}.ai-suggestion-list input[type=checkbox]{margin-right:12px;width:auto;transform:scale(1.2)}#theme-toggle{position:absolute;top:6px;right:6px;z-index:101}.back-button{z-index:110;position:absolute;top:6px;left:6px;color:var(--color-text-secondary)}.onboarding-wrapper{text-align:center;margin-top:20px;padding:15px;background-color:rgba(255,255,255,.2);border-radius:12px;border:1px dashed var(--color-border)}.onboarding-step-img{max-width:100%;height:auto;border:1px solid var(--color-border);border-radius:8px;margin:10px 0;background:#eee;display:flex;align-items:center;justify-content:center;min-height:150px}.brain-dump-commentary{background-color:var(--color-bored-bg);border-left:4px solid var(--color-warning);padding:10px;margin-bottom:15px;font-style:italic;font-size:.9em}.bd-task-item{display:flex;flex-direction:column;margin-bottom:10px;background:rgba(255,255,255,.3);padding:8px;border-radius:6px}.bd-task-row{display:flex;align-items:center;justify-content:space-between;width:100%}.bd-task-meta{margin-top:5px;margin-left:25px;width:90%}.bd-task-meta select{padding:4px;font-size:.8em;width:100%;margin:0}.onboarding-screen{display:none;padding:40px 20px;max-width:900px;margin:0 auto}.onboarding-screen.active{display:block}.onboarding-content h1{font-size:2.2em;text-align:center;margin-bottom:.5em;color:var(--color-text)}.subtitle{text-align:center;font-size:1.1em;color:var(--color-text-secondary);margin-bottom:3em}.philosophy-card{background:var(--color-surface);border:2px solid var(--color-border);border-radius:16px;padding:35px;margin:30px 0}.lead{font-size:1.4em;text-align:center;margin-bottom:30px;font-weight:500;color:var(--color-text)}.examples-grid{display:grid;grid-template-columns:1fr 1fr;gap:25px;margin:30px 0}.noise-example,.signal-example{padding:20px;border-radius:12px}.noise-example{background:var(--color-blocked-bg);border:2px solid var(--color-danger)}.signal-example{background:rgba(16,185,129,.1);border:2px solid var(--color-success)}.examples-grid h3{margin-top:0;font-size:1.1em;margin-bottom:15px}.examples-grid ul{list-style:none;padding:0;margin:0}.examples-grid li{padding:8px 0;font-size:.95em}.philosophy-note{background:var(--color-bored-bg);border-left:4px solid var(--color-warning);padding:20px;margin-top:30px;border-radius:8px}.philosophy-note strong{display:block;font-size:1.15em;margin-bottom:10px;color:var(--color-text)}.philosophy-note p{margin:5px 0}.btn-lg{padding:16px 50px;font-size:1.15em;display:block;margin:40px auto 0;min-width:220px}.category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:30px}.category-card{background:var(--color-surface);border:2px solid var(--color-border);border-radius:16px;padding:35px 20px;text-align:center;cursor:pointer;transition:all .2s ease}.category-card:hover{border-color:var(--color-primary);transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.1)}.category-card .icon{font-size:3.5em;display:block;margin-bottom:15px}.category-card .cat-title{font-size:1.15em;font-weight:600;margin-bottom:8px;color:var(--color-text)}.category-card .cat-subtitle{font-size:.9em;color:var(--color-text-secondary);line-height:1.4}.example-card{background:var(--color-surface);border:2px solid var(--color-border);border-radius:12px;padding:28px;margin-bottom:25px;transition:all .2s ease}.example-card:hover{border-color:var(--color-primary);box-shadow:0 4px 12px rgba(0,0,0,.08)}.example-card h3{margin-top:0;color:var(--color-primary);font-size:1.3em;margin-bottom:20px}.example-tasks{margin:20px 0}.example-tasks strong{display:block;margin-bottom:10px;font-size:.95em;color:var(--color-secondary);text-transform:uppercase;letter-spacing:.5px}.example-tasks ul{list-style:none;padding:0;margin:0}.example-tasks li{padding:7px 0;padding-left:24px;position:relative;font-size:.95em;line-height:1.5}.example-tasks li::before{content:"‚Ä¢";position:absolute;left:0;color:var(--color-primary);font-size:1.3em;line-height:1}.example-card .btn{margin-top:20px;min-width:180px}.btn-back{background:0 0;border:none;color:var(--color-link);font-size:1em;cursor:pointer;padding:8px 12px;margin-bottom:20px;transition:all .2s ease}.btn-back:hover{background:var(--color-border);border-radius:6px}@media (max-width:700px){.examples-grid{grid-template-columns:1fr}.category-grid{grid-template-columns:1fr}.onboarding-content h1{font-size:1.8em}.philosophy-card{padding:25px}}@media (max-width:600px){body{padding-left:5px;padding-right:5px}#app-footer,#app-header{margin-left:-5px;margin-right:-5px;padding-left:10px;padding-right:10px}h1{font-size:1.5em}h2{font-size:1.2em}h3{font-size:1.1em}#app-footer{flex-direction:row;align-items:center}#footer-links{flex-grow:1;justify-content:space-around;display:flex}}.goal-status-group{margin-bottom:30px}.goal-group-header{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background-color:var(--color-surface);border:1px solid var(--color-border);border-radius:8px;margin-bottom:10px;cursor:pointer}.goal-group-header h3{margin:0!important}.goal-group-header .toggle-group{background:0 0;border:none;font-size:1.2em;cursor:pointer;padding:5px 10px;margin:0}.goal-group-header .toggle-group span{display:inline-block;transition:transform .2s ease}.goals-container{max-height:2000px;overflow:hidden;transition:max-height .3s ease,opacity .3s ease;opacity:1}.goals-container.collapsed{max-height:0;opacity:0;margin-bottom:0}.goal-item .goal-actions{display:flex;flex-direction:column;gap:5px;align-items:flex-end}.goal-item .goal-actions button{min-width:100px;font-size:.85em;padding:6px 12px}#flow-mode-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--color-background);z-index:2000;display:flex;flex-direction:column;padding:20px;overflow-y:auto;transition:transform .3s ease;transform:translateY(100%)}#flow-mode-overlay.active{transform:translateY(0)}.flow-header{text-align:center;margin-bottom:30px}.flow-header h2{font-size:2em;margin-bottom:5px;color:var(--color-primary)}.flow-header p{color:var(--color-text-secondary)}.flow-tasks{max-width:600px;margin:0 auto;width:100%}.flow-task-item{display:flex;align-items:center;padding:15px;margin-bottom:10px;background:var(--color-surface);border:1px solid var(--color-border);border-radius:12px;cursor:pointer;transition:all .2s ease}.flow-task-item:hover{transform:translateX(5px);border-color:var(--color-primary)}.flow-task-item.completed{opacity:.5;background-color:var(--color-background);text-decoration:line-through}.flow-checkbox{width:24px;height:24px;border:2px solid var(--color-secondary);border-radius:50%;margin-right:15px;display:flex;align-items:center;justify-content:center;flex-shrink:0}.flow-task-item.completed .flow-checkbox{background-color:var(--color-success);border-color:var(--color-success)}.flow-task-item.completed .flow-checkbox::after{content:'‚úì';color:#fff;font-weight:700}.flow-actions{margin-top:auto;padding:20px;text-align:center;display:flex;justify-content:center;gap:20px}@keyframes pulse-animation{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(16,185,129,.7)}70%{transform:scale(1.05);box-shadow:0 0 0 10px rgba(16,185,129,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(16,185,129,0)}}.pulse{animation:pulse-animation 2s infinite}
    </style>
</head>
<body>
    <header id="app-header">
        <button id="back-to-main" class="back-button btn-icon hidden" title="Back to Main View">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
        <!-- START: New AI Insights Button -->
        <button id="nav-ai-insights" class="btn-icon" title="AI Insights" style="position: absolute; top: 6px; left: 50px; z-index: 110;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                <path d="M5 3v4"></path>
                <path d="M9 5H1"></path>
            </svg>
        </button>
        <!-- END: New AI Insights Button -->
        <button id="theme-toggle" class="btn-icon" title="Toggle Theme"></button>
        <div id="header-top-row">
            <button id="nav-blocked" class="btn btn-secondary">Blocked</button>
            <button id="nav-bored" class="btn btn-secondary">Bored</button>
            <button id="nav-stressed" class="btn btn-secondary">Stressed</button>
        </div>
        <div id="header-goal-row">
            <span id="current-goal-display">Loading goal...</span>
            <a href="#" id="see-all-goals-link">See all goals</a>
        </div>
        <div style="text-align: center; padding: 5px;">
            <button id="ai-assist-btn" class="btn btn-primary" style="background-color: var(--color-warning); color: #1e293b;">
                üéØ What should I focus on?
            </button>
        </div>
    </header>
    <main id="main-content-area">
        <!-- === Main View (Pending Tasks) === -->
        <div id="main-view" class="app-view active">
            <section id="pending-tasks-section">
                <div class="view-header">
                    <h2>Pending Today</h2>
                    <button id="add-task-btn" title="Add Task">+</button>
                </div>
                <div id="add-task-form" class="hidden">
                     <input type="text" id="new-task-input" placeholder="What needs doing?">
                     <div id="add-task-options">
                         <label id="goal-tag-toggle" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="tag-with-goal-checkbox" disabled style="width: auto; margin: 0;">
                            <span>Link to current goal?</span>
                        </label>
                         <div id="add-task-buttons"> <button id="submit-add-task" class="btn btn-success">Add</button> <button id="auto-add-task" class="btn btn-secondary" title="Add a random suggestion">Auto-Add</button> <button id="cancel-add-task" class="btn btn-secondary">Cancel</button> </div>
                     </div>
                </div>
                <div id="pending-tasks-list"></div>
                <div id="routine-loader-area" class="routine-loader">
                    <button id="load-routine-btn" class="btn btn-secondary">Load a Routine</button>
                </div>
                 <div id="empty-pending-message" class="hidden"> Clean plate! Enjoy... or add some tasks. </div>
                 <!-- NEW: Onboarding Trigger -->
                 <div id="onboarding-trigger-wrapper" class="onboarding-wrapper hidden">
                    <p style="margin-bottom:10px; font-size: 0.9em; color: var(--color-text-secondary);">New here?</p>
                    <button id="start-onboarding-btn" class="btn btn-primary">üöÄ Learn how to use Guide</button>
                 </div>
            </section>
        </div>
        <!-- === Goals View === -->
        <div id="goals-view" class="app-view">
            <div class="view-header">
                <h2>Goals</h2>
                <button id="copy-goals-btn" class="btn copy-button">Copy All (MD)</button>
            </div>
            <button id="add-new-goal-btn" class="btn-success">Add New Goal</button>
             <div id="add-goal-form" class="hidden" style="margin-top:15px; background-color: var(--color-surface); padding: 15px; border-radius: 5px;">
                 <input type="text" id="new-goal-input" placeholder="Enter new goal description">
                 <button id="submit-add-goal" class="btn btn-success">Save Goal</button> <button id="cancel-add-goal" class="btn btn-secondary">Cancel</button>
             </div>
            <div id="goals-list" style="margin-top: 20px;"> <p id="empty-goals-message" class="hidden">No goals defined yet.</p> </div>
        </div>
        <!-- === Done List View === -->
        <div id="done-list-view" class="app-view">
             <div class="view-header">
                 <h2>Done List</h2>
                 <button id="copy-done-btn" class="btn copy-button">Copy All (MD)</button>
            </div>
            <div class="filter-controls"> <label for="done-time-filter">Show:</label> <select id="done-time-filter"> <option value="all">All Time</option> <option value="7">Last 7 Days</option> <option value="30">Last 30 Days</option> </select> <label for="done-goal-filter" style="margin-left: 10px;">Goal:</label> <select id="done-goal-filter"> <option value="all">All Goals</option> </select> </div>
            <div id="done-list"> <p id="empty-done-message" class="hidden">Nothing done yet!</p> </div>
        </div>
        <!-- === Task Bowl View === -->
        <div id="task-bowl-view" class="app-view">
            <div class="view-header">
                 <h2>Task Bowl (Backlog)</h2>
                 <div style="text-align: right;"> <!-- Wrapper for right-aligned buttons -->
                    <div>
                        <button id="add-task-to-bowl-btn" title="Add Task to Bowl" class="btn btn-primary" style="padding: 0 10px; font-size: 1.5em; line-height: 1; vertical-align: middle;">+</button>
                        <button id="copy-bowl-btn" class="btn copy-button">Copy All (MD)</button>
                    </div>
                    <button id="goal-guide-btn" title="AI Guide for this Goal" class="btn btn-primary hidden" style="background-color: var(--color-warning); color: #1e293b; margin-top: 5px;">Guide Me</button>
                 </div>
             </div>
             <div class="filter-controls">
                <label for="bowl-goal-filter">Filter by Goal:</label>
                <select id="bowl-goal-filter">
                    <option value="all">All Goals</option>
                </select>
             </div>
             <hr>
             <div id="task-bowl-list"></div>
             <p id="empty-task-bowl-message" class="hidden">Task Bowl is empty.</p>
        </div>
        <!-- === Routines View === -->
        <div id="routines-view" class="app-view">
            <div class="view-header">
                <h2>Routines</h2>
            </div>
            <button id="add-new-routine-btn" class="btn-success">Add New Routine</button>
            <div id="add-routine-form" class="hidden">
                <input type="hidden" id="edit-routine-id">
                <label for="new-routine-name">Routine Name:</label>
                <input type="text" id="new-routine-name" placeholder="e.g., Morning Kickstart">
                <label for="new-routine-tasks">Tasks (one per line):</label>
                <textarea id="new-routine-tasks" placeholder="Make coffee&#10;Stretch for 5 minutes&#10;Review calendar"></textarea>
                <button id="submit-add-routine" class="btn btn-success">Save Routine</button>
                <button id="cancel-add-routine" class="btn btn-secondary">Cancel</button>
            </div>
            <div id="routines-list" style="margin-top: 20px;">
                <p id="empty-routines-message" class="hidden">No routines defined yet. Add one to get started!</p>
            </div>
        </div>
        <!-- === Brain Dump View (Formerly References) === -->
        <div id="references-view" class="app-view editable-content-view">
             <div class="view-header">
                 <h2>Brain Dump</h2>
                 <div>
                    <button id="process-braindump-btn" class="btn btn-primary" style="background-color: var(--color-warning); color: #1e293b;" title="Extract tasks from brain dump">‚ö° Process</button>
                    <button id="copy-refs-btn" class="btn copy-button">Copy (MD)</button>
                 </div>
             </div>
             <div class="view-mode"> <div id="references-content-display" class="markdown-content">Loading...</div> </div>
             <div class="edit-mode"> <textarea id="references-content-edit"></textarea> </div>
             <div class="editable-content-controls"> <button class="btn btn-edit">Edit</button> <button class="btn btn-save btn-success hidden">Save</button> <button class="btn btn-cancel btn-secondary hidden">Cancel</button> </div>
        </div>
        <!-- === Reminders View === -->
        <div id="reminders-view" class="app-view editable-content-view">
             <div class="view-header">
                 <h2>Reminders</h2>
                 <button id="copy-reminders-btn" class="btn copy-button">Copy (MD)</button>
             </div>
             <div class="view-mode"> <div id="reminders-content-display" class="markdown-content">Loading...</div> </div>
             <div class="edit-mode"> <textarea id="reminders-content-edit"></textarea> </div>
             <div class="editable-content-controls"> <button class="btn btn-edit">Edit</button> <button class="btn btn-save btn-success hidden">Save</button> <button class="btn btn-cancel btn-secondary hidden">Cancel</button> </div>
        </div>
        <!-- === Blocked View (Refactored) === -->
        <div id="blocked-view" class="app-view">
            <header>
                <h1>Productivity Playbook</h1>
                <p>Your interactive guide to overcome blocks</p>
            </header>
            <!-- Unified Mode Selector -->
            <div class="mode-selector">
                <button class="btn" id="blocked-mode-random">Random Tip</button>
                <button class="btn" id="blocked-mode-interactive">Interactive Guide</button>
                <button class="btn" id="blocked-mode-ai">AI Guidance</button>
                <button class="btn" id="blocked-mode-all">View All Tips</button>
            </div>
            <div id="blocked-mode-content">
                <!-- 1. Random Mode -->
                <div id="blocked-subview-random" class="blocked-sub-view">
                    <div class="quote-box" id="blocked-random-display">
                        <!-- Tip injected here -->
                        Loading...
                    </div>
                    <div class="text-center" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="blocked-btn-new-random">Get Another Tip</button>
                    </div>
                </div>
                <!-- 2. Interactive Diagnostic Mode -->
                <div id="blocked-subview-interactive" class="blocked-sub-view hidden">
                    <div id="blocked-diagnostic-options">
                        <h3 style="text-align: center; margin-bottom: 20px;">What's stopping you?</h3>
                        <div class="options-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <button class="blocked-option-btn btn btn-secondary" style="padding: 15px;" data-issue="overwhelm">ü§Ø Overwhelmed</button>
                            <button class="blocked-option-btn btn btn-secondary" style="padding: 15px;" data-issue="starting">üö¶ Can't Start</button>
                            <button class="blocked-option-btn btn btn-secondary" style="padding: 15px;" data-issue="focus">üêøÔ∏è No Focus</button>
                            <button class="blocked-option-btn btn btn-secondary" style="padding: 15px;" data-issue="decision">‚öñÔ∏è Indecisive</button>
                            <button class="blocked-option-btn btn btn-secondary" style="padding: 15px;" data-issue="shipping">üì¶ Can't Ship</button>
                            <button class="blocked-option-btn btn btn-secondary" style="padding: 15px;" data-issue="motivation">üîã Low Energy</button>
                        </div>
                    </div>
                    <div id="blocked-diagnostic-results" class="hidden">
                        <h3 id="blocked-diagnostic-title">Try this:</h3>
                        <div id="blocked-diagnostic-tips" class="tips-container"></div>
                        <button class="btn btn-secondary" id="blocked-btn-reset-diagnostic" style="margin-top: 15px;">‚Üê Pick a different issue</button>
                    </div>
                </div>
                <!-- 3. AI Mode -->
                <div id="blocked-subview-ai" class="blocked-sub-view hidden">
                    <div class="settings-section" style="border: 1px solid var(--color-warning);">
                        <h3>AI Unblocker</h3>
                        <p style="font-size: 0.9em; margin-bottom: 15px;">Describe specifically why you are stuck. The AI will cross-reference your situation with your Playbook strategies.</p>
                        <textarea id="blocked-ai-input" rows="4" placeholder="e.g., I have 3 big tasks (A, B, C) and I'm scared to start A because..." style="width: 100%; margin-bottom: 10px;"></textarea>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="blocked-btn-get-ai" class="btn btn-primary">Get Guidance</button>
                        </div>
                        <div id="blocked-ai-result" class="task-help-suggestion hidden" style="margin-top: 20px;"></div>
                    </div>
                </div>
                <!-- 4. All Tips Mode -->
                <div id="blocked-subview-all" class="blocked-sub-view hidden">
                    <h2>Complete Playbook</h2>
                    <div class="tip-section"><h3>Core Principles</h3><div id="blocked-all-principles"></div></div>
                    <div class="tip-section"><h3>Action Framework</h3><div id="blocked-all-framework"></div></div>
                    <div class="tip-section"><h3>Task Management</h3><div id="blocked-all-management"></div></div>
                </div>
            </div>
        </div>
        <!-- === Bored View === -->
        <div id="bored-view" class="app-view">
             <h1>Take a break.</h1> <button id="surpriseBtn">Surprise Me!</button> <button id="elseBtn" style="display:none;">Something Else</button>
             <div id="suggestion"></div> <div id="timerDisplay"> <div id="timerText"></div> <div id="progressBarContainer"> <div id="progressBarFill"></div> </div> </div>
             <div id="customActionArea"> <input type="text" id="customActionInput" placeholder="Enter your own quick task..."> <button id="addActionBtn" class="btn-success">Add Task for a Surprise Pick!</button> </div>
        </div>
        <!-- === Stressed View === -->
        <div id="stressed-view" class="app-view">
             <header> <h1>Stress-Coping Playbook</h1> <p>Interactive guide to help you navigate stress</p> </header>
             <div class="mode-selector"> <button class="btn" id="random-mode-btn-stressed">Random Tip</button> <button class="btn" id="interactive-mode-btn-stressed">Interactive Guide</button> <button id="get-stressed-ai-help" class="btn">AI Guidance</button> <button class="btn" id="all-tips-mode-btn-stressed">View All Tips</button> </div>
             <div id="stressed-mode-content">
                 <div id="random-mode-stressed" class="stressed-sub-view"> <div class="quote-box" id="random-tip-stressed">Loading...</div> <div class="text-center"><button class="btn" id="new-random-tip-stressed">Get Another Tip</button></div> </div>
                 <div id="stressed-ai-section" class="hidden" style="margin: 20px 0; padding: 15px; background-color: var(--color-stressed-bg); border-radius: 8px; border: 1px solid var(--color-danger);">
                    <h3>AI Support</h3>
                    <p style="font-size: 0.9em; margin-bottom: 10px;">Describe how you're feeling (optional but helps get better guidance):</p>
                    <textarea id="stressed-ai-input" rows="3" placeholder="e.g., Everything feels urgent and I can't focus..." style="width: 100%; margin-bottom: 10px;"></textarea>
                    <button id="get-stressed-ai-help" class="btn btn-primary">Get AI Support</button>
                    <button id="cancel-stressed-ai" class="btn btn-secondary">Cancel</button>
                    <div id="stressed-ai-result" class="task-help-suggestion hidden" style="margin-top: 15px;"></div>
                </div>
                 <div id="interactive-mode-stressed" class="stressed-sub-view hidden">
                     <div class="question-box" id="question-container-stressed"> <h2>How are you feeling?</h2> <div class="options"> <button class="option-btn" data-feeling="rudderless">Rudderless</button> <button class="option-btn" data-feeling="overwhelmed">Overwhelmed</button> <button class="option-btn" data-feeling="cluttered">Cluttered</button> <button class="option-btn" data-feeling="control">Lacking Control</button> <button class="option-btn" data-feeling="uncertain">Uncertain</button> <button class="btn" id="ai-mode-btn-stressed">AI Support</button> </div> </div>
                     <div class="tips-container hidden" id="tips-result-stressed"> <h3 id="feeling-title-stressed">Tips for <span id="feeling-type-stressed"></span></h3> <div id="feeling-tips-stressed"></div> <button class="btn" id="back-to-feelings-stressed">Try Different</button> </div>
                 </div>
                 <div id="all-tips-mode-stressed" class="stressed-sub-view hidden">
                     <h2>Complete Playbook</h2> <div class="tip-category"><h3>Rudderless</h3><ul id="all-rudderless"></ul></div> <div class="tip-category"><h3>Overwhelmed</h3><ul id="all-overwhelmed"></ul></div> <div class="tip-category"><h3>Cluttered</h3><ul id="all-cluttered"></ul></div> <div class="tip-category"><h3>Lacking Control</h3><ul id="all-control"></ul></div> <div class="tip-category"><h3>Uncertain</h3><ul id="all-uncertain"></ul></div> <div class="tip-category"><h3>Generic</h3><ul id="all-generic"></ul></div>
                 </div>
              </div>
        </div>
        <!-- === Settings View === -->
        <div id="settings-view" class="app-view">
            <div class="view-header" style="align-items: center;">
                <h2>Settings</h2>
                <button id="settings-onboarding-btn" class="btn btn-primary" style="margin: 0;">üöÄ Learn how to use Guide</button>
            </div>
            <section class="settings-section">
                <h3>Backup & Restore</h3>
                <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">Save all your tasks, goals, notes, and custom playbooks to a single file. You can restore from this file on any device.</p>
                <div class="settings-actions">
                    <button id="export-full-backup-btn" class="btn btn-success">Export Full Backup</button>
                    <button id="edit-full-backup-btn" class="btn">View / Edit Backup</button>
                    <button id="import-backup-btn" class="btn btn-danger">Import from Backup...</button>
                    <input type="file" id="import-full-backup-input" accept=".json" style="display: none;">
                </div>
            </section>
            <section class="settings-section">
                <h3>AI Provider Settings</h3>
                <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">Choose your preferred AI provider and enter the corresponding API key. The selected provider will be used for all AI features.</p>
                <label for="ai-provider-select">Active AI Provider:</label>
                <select id="ai-provider-select">
                    <option value="gemini">Google Gemini</option>
                    <option value="openai">OpenAI</option>
                    <option value="claude">Anthropic Claude</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
                <label for="ai-model-select">Model:</label>
                    <select id="ai-model-select">
                        <!-- Options populated dynamically -->
                    </select>
                <div id="gemini-key-section" class="api-key-section">
                    <label for="gemini-key-input">Google Gemini API Key:</label>
                    <input type="password" id="gemini-key-input" placeholder="Enter Gemini Key">
                </div>
                <div id="openai-key-section" class="api-key-section" style="display: none;">
                    <label for="openai-key-input">OpenAI API Key:</label>
                    <input type="password" id="openai-key-input" placeholder="Enter OpenAI Key (e.g., sk-...)">
                </div>
                <div id="claude-key-section" class="api-key-section" style="display: none;">
                    <label for="claude-key-input">Anthropic Claude API Key:</label>
                    <input type="password" id="claude-key-input" placeholder="Enter Claude Key (e.g., sk-ant-...)">
                </div>
                <div id="deepseek-key-section" class="api-key-section" style="display: none;">
                    <label for="deepseek-key-input">DeepSeek API Key:</label>
                    <input type="password" id="deepseek-key-input" placeholder="Enter DeepSeek Key (e.g., ds-...)">
                </div>
                <div class="settings-actions">
                    <button id="save-ai-settings-btn" class="btn btn-success">Save AI Settings</button>
                </div>
            </section>
            <section class="settings-section">
                <h3>Blocked Playbook Data</h3>
                <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">Customize the tips shown in the "Blocked" view.</p>
                <div class="settings-actions">
                     <button id="edit-blocked-data-btn" class="btn">View / Edit Data</button>
                     <button id="export-blocked-data-btn" class="btn btn-secondary">Export to JSON</button>
                     <button id="import-blocked-data-btn" class="btn btn-secondary">Import from JSON...</button>
                     <input type="file" id="import-blocked-data-input" accept=".json" style="display: none;">
                    </label>
                </div>
            </section>
            <section class="settings-section">
                <h3>Stressed Playbook Data</h3>
                 <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">Customize the tips and quotes shown in the "Stressed" view.</p>
                 <div class="settings-actions">
                     <button id="edit-stressed-data-btn" class="btn">View / Edit Data</button>
                     <button id="export-stressed-data-btn" class="btn btn-secondary">Export to JSON</button>
                     <button id="import-stressed-data-btn" class="btn btn-secondary">Import from JSON...</button>
                     <input type="file" id="import-stressed-data-input" accept=".json" style="display: none;">
                    </label>
                </div>
            </section>
            <section class="settings-section">
                <h3>Bored Actions Data</h3>
                 <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">Customize the suggestions for the "Bored" view.</p>
                 <div class="settings-actions">
                     <button id="edit-bored-data-btn" class="btn">View / Edit Data</button>
                     <button id="export-bored-data-btn" class="btn btn-secondary">Export to JSON</button>
                      <button id="import-bored-data-btn" class="btn btn-secondary">Import from JSON...</button>
                      <input type="file" id="import-bored-data-input" accept=".json" style="display: none;">
                    </label>
                </div>
            </section>
            <section class="settings-section">
                <h3 style="color: var(--color-danger);">Danger Zone</h3>
                <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">This action is irreversible. It will delete all your tasks, goals, notes, routines, and custom playbook settings from this browser.</p>
                <div class="settings-actions">
                    <button id="reset-app-btn" class="btn btn-danger">Reset All Application Data</button>
                    <button id="reset-onboarding-btn" class="btn btn-secondary" style="margin-top: 10px;"> See Onboarding Again </button>
                </div>
            </section>
        </div>
        <!--  ===  Onboarding View  === -->
        <div id="onboarding-view" class="app-view">
            <!-- Screen 1: Philosophy -->
            <div id="onboarding-philosophy" class="onboarding-screen active">
                <div class="onboarding-content">
                    <h1>Guide is NOT another to-do app</h1>
                    <div class="philosophy-card">
                        <p class="lead">Most apps treat all tasks equally. They aren't.</p>
                        <div class="examples-grid">
                            <div class="noise-example">
                                <h3>‚ùå The Chores (Other Apps)</h3>
                                <ul>
                                    <li>Buy cat food</li>
                                    <li>Respond to 5 emails</li>
                                    <li>Update Jira ticket #429</li>
                                    <li>Pay electricity bill</li>
                                </ul>
                            </div>
                            <div class="signal-example">
                                <h3>‚úÖ The Goals (Guide)</h3>
                                <ul>
                                    <li>Draft Q4 Promotion Docket</li>
                                    <li>Write Chapter 1 of Book</li>
                                    <li>Code MVP for Side Project</li>
                                    <li>Research Home Loan rates</li>
                                </ul>
                            </div>
                        </div>
                        <div class="philosophy-note">
                            <strong>Guide enforces a strict 3-task daily limit.</strong>
                            <p>This forces you to focus on what truly matters - your career and personal growth.</p>
                            <p style="margin-top: 10px; font-size: 0.9em; color: var(--color-text-secondary);">
                                Keep groceries in Keep. Keep bug tickets in Jira.
                                Use Guide for <b><u>deep work</u></b>.
                            </p>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-lg" id="understand-btn">
                        Okay. How does it work? ‚Üí
                    </button>
                </div>
            </div>
            <!-- Screen 2: Category Selection -->
            <div id="onboarding-category" class="onboarding-screen">
                <div class="onboarding-content">
                    <h1>What do you want to achieve?</h1>
                    <p class="subtitle">Pick one area to focus on (you can add more later)</p>
                    <div class="category-grid" id="category-grid">
                        <!-- Categories inserted by JS -->
                    </div>
                    <button class="btn btn-link" id="explore-demo-btn" style="display: block; margin: 30px auto 0;">
                        üîç Just exploring - show me examples
                    </button>
                </div>
            </div>
            <!-- Screen 3: Example Selection -->
            <div id="onboarding-example" class="onboarding-screen">
                <div class="onboarding-content">
                    <button class="btn-back" id="back-to-categories">‚Üê Back</button>
                    <h1 id="example-category-title">Choose a starting point</h1>
                    <div id="examples-container">
                        <!-- Examples inserted by JS -->
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-link" id="start-fresh-btn">
                            Or start with an empty slate ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- === AI Insights View === -->
        <div id="ai-insights-view" class="app-view">
            <div class="view-header">
                <h2>AI Insights</h2>
            </div>
            <!-- 1. Summarization Section -->
            <section class="settings-section">
                <h3>Activity Summary</h3>
                <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">
                    Get an AI-powered summary of your completed tasks over a specific period.
                </p>
                <div class="settings-actions" style="display: flex; align-items: center; gap: 10px;">
                    <label for="summary-weeks-input">Summarize last</label>
                    <input type="number" id="summary-weeks-input" value="1" min="1" max="52" style="width: 60px; margin-bottom: 0;">
                    <label for="summary-weeks-input">week(s).</label>
                    <button id="generate-summary-btn" class="btn btn-primary">Generate</button>
                </div>
                <div id="summary-result-wrapper" class="task-help-suggestion" style="margin-top: 15px; display: none; position: relative; min-height: 80px;">
                    <button id="copy-summary-btn" class="btn copy-button" style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                        Copy All (MD)
                    </button>
                    <div id="summary-text-content" style="padding-top: 40px;"></div>
                </div>
            </section>
            <!-- 2. Fallen Through Items Section -->
            <section class="settings-section">
                <h3>Identify Forgotten Tasks</h3>
                <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">
                    Let AI analyze your goals and backlog to find important tasks that might have fallen through the cracks.
                </p>
                <div class="settings-actions">
                    <button id="analyze-fallen-btn" class="btn btn-primary">Analyze Now</button>
                </div>
                <!-- Updated Wrapper with Copy Button -->
                <div id="fallen-result-wrapper" class="task-help-suggestion" style="margin-top: 15px; display: none; position: relative; min-height: 80px;">
                    <button id="copy-fallen-btn" class="btn copy-button" style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                        Copy (MD)
                    </button>
                    <div id="fallen-text-content" style="padding-top: 40px;"></div>
                </div>
            </section>
            <!-- 3. General Q&A Section -->
            <section class="settings-section">
                <h3>Ask a Question</h3>
                <p style="font-size:0.9em; color:var(--color-text-secondary); margin-bottom:15px;">
                    Ask anything about your productivity, goals, or tasks. The AI will answer based on your complete application data.
                </p>
                <!-- RESULT MOVED ABOVE INPUT -->
                <div id="ai-question-result-wrapper" class="task-help-suggestion" style="margin-top: 15px; margin-bottom: 15px; display: none; position: relative; min-height: 80px;">
                    <button id="copy-question-btn" class="btn copy-button" style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                        Copy (MD)
                    </button>
                    <div id="ai-question-text-content" style="padding-top: 40px;"></div>
                </div>
                <textarea id="ai-question-input" placeholder="e.g., Which goal has the most overdue tasks?"></textarea>
                <div class="settings-actions">
                    <button id="submit-ai-question-btn" class="btn btn-success">Ask AI</button>
                    <button id="reset-chat-btn" class="btn btn-secondary" title="Forget previous context">Reset Context</button>
                </div>
            </section>
        </div>
    </main>
    <footer id="app-footer">
        <div id="footer-links">
            <button id="nav-done" class="btn btn-link">Done List</button>
            <button id="nav-bowl" class="btn btn-link">Task Bowl</button>
            <button id="nav-routines" class="btn btn-link">Routines</button>
            <button id="nav-refs" class="btn btn-link">Brain Dump</button>
            <button id="nav-reminders" class="btn btn-link">Reminders</button>
            <button id="nav-settings" class="btn-icon" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        </button>
        </div>
    </footer>
    <div id="modal-overlay" class="hidden">
        <div id="modal-content">
            <h3 id="modal-title">Confirmation</h3>
            <div id="modal-body-wrapper">
                <div id="modal-body"></div>
            </div>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="modal-confirm-btn" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
    <!-- Flow Mode Overlay -->
    <div id="flow-mode-overlay">
        <div class="flow-header">
            <h2 id="flow-routine-name">Morning Flow</h2>
            <p>Momentum builder. No records kept.</p>
        </div>
        <div id="flow-tasks-container" class="flow-tasks">
            <!-- Tasks go here -->
        </div>
        <div class="flow-actions">
            <button id="flow-skip-btn" class="btn btn-secondary" style="font-size: 1.1em; padding: 10px 20px;">Skip to Pending</button>
            <button id="flow-finish-btn" class="btn btn-success" style="font-size: 1.1em; padding: 10px 20px;">Mark All Done</button>
        </div>
    </div>
    <div id="toast-notification"></div>
    <script>
        (function(){const PROMPT_FRAGMENTS={userStyle:`\n                ## How to Communicate with Me\n                I respond to:\n                - Objective honesty without sugarcoating\n                - Being called on my bullshit when I'm hedging\n                - Specific concrete examples over abstract theory\n                - Direct assessment of what's working vs what isn't\n                I'm annoyed by:\n                - Sycophantic praise or cheerleading\n                - Generic advice without grounding in my actual situation\n                - Force-fitting examples that don't actually connect\n                - Being told what I "should" do without understanding my context\n                As a collaborator:\n                - Push back when something feels thin or force-fit\n                - Call out when I'm hedging or avoiding\n                - Ask "is this YOUR story or a concept?" when it gets abstract\n                - Be willing to say "this doesn't work" with clear reasoning\n                `,goalStatusContext:`\n                ## About Goal Statuses\n                Goals in my system have lifecycle states:\n                - **active**: Working on it, but not currently my primary focus\n                - **focused**: My current primary goal (only one at a time, has a focus end date)\n                - **on_hold**: Paused temporarily\n                - **completed**: Successfully finished\n                - **abandoned**: Decided not to pursue\n                When analyzing priorities:\n                - Focused goals should get primary attention\n                - Active goals are secondary priorities\n                - On-hold goals may need revisiting\n                - Completed/abandoned goals show past priorities but shouldn't drive new work\n                `,taskPreferences:`\n                ## My Task Preferences\n                When suggesting tasks:\n                - Action-oriented with clear definition of done\n                - Completable within 1-2 hours max (prefer 30-60 min)\n                - Concrete next steps, not project-level abstractions\n                - Build momentum through small wins\n                - Support flow state, not constant context-switching\n                Key mindsets:\n                - "Dailyish is consistent" - 3-4x/week matters more than perfection\n                - Fast decisions using "hat/haircut/tattoo" framework\n                - Action over analysis (though periodic review is important)\n                - Novel experiences prevent years from blurring\n                - Mild obsession often leads to skill development\n                `,dataContext:`\n                ## Data Context Notes\n                - createdAt on tasks might mean "planned ahead" not "forgotten"\n                (e.g., a series of blog post tasks created upfront)\n                - focusEndDate is when I'm supposed to focus until, NOT a hard deadline\n                - Task counts: pending (today's work), bowl (backlog), done (completed)\n                - Some tasks may have deadlines independent of goals - prioritize these\n                `};const MAX_PENDING_TASKS=3;let GEMINI_API_KEY="YOUR_API_KEY_HERE";const AI_MODELS={gemini:[{id:"gemini-2.5-flash",label:"Gemini 2.5 Flash (Decent for daily driver)"},{id:"gemini-3-flash-preview",label:"Gemini 3 Flash (Balanced)"},{id:"gemini-3-pro-preview",label:"Gemini 3 Pro  (Smartest)"}],claude:[{id:"claude-haiku-4-5",label:"Claude 4.5 Haiku (Fastest)"},{id:"claude-sonnet-4-5",label:"Claude 4 Sonnet (Balanced)"},{id:"claude-opus-4-5",label:"Claude 4 Opus (Smartest)"}],openai:[{id:"gpt-3.5-turbo",label:"GPT-3.5 Turbo (Cheapest)"},{id:"gpt-4-turbo",label:"GPT-4 Turbo (Fast)"},{id:"gpt-4o",label:"GPT-4o (Latest)"}],deepseek:[{id:"deepseek-chat",label:"DeepSeek Chat (Default)"}]};const DEFAULT_MODELS={gemini:"gemini-2.5-flash",claude:"claude-haiku-4-5",openai:"gpt-4-turbo",deepseek:"deepseek-chat"};const LS_PREFIX="guideApp_";const LS_KEYS={pending:LS_PREFIX+"pendingTasks",done:LS_PREFIX+"doneTasks",bowl:LS_PREFIX+"taskBowl",goals:LS_PREFIX+"goals",currentGoal:LS_PREFIX+"currentGoal",boredState:LS_PREFIX+"boredState",references:LS_PREFIX+"referencesContent",reminders:LS_PREFIX+"remindersContent",geminiApiKey:LS_PREFIX+"geminiApiKey",routines:LS_PREFIX+"routines",lastOpenedDate:LS_PREFIX+"lastOpenedDate",blockedTips:LS_PREFIX+"blockedTips",stressedTips:LS_PREFIX+"stressedTips",boredActions:LS_PREFIX+"boredActions",theme:LS_PREFIX+"theme",aiSettings:LS_PREFIX+"aiSettings",aiSummaryLast:LS_PREFIX+"aiSummaryLast",aiForgottenLast:LS_PREFIX+"aiForgottenLast",aiChatLast:LS_PREFIX+"aiChatLast"};const GOAL_STATUS={ACTIVE:"active",FOCUSED:"focused",ON_HOLD:"on_hold",COMPLETED:"completed",ABANDONED:"abandoned"};const GOAL_STATUS_CONFIG={active:{label:"üìã Active",color:"var(--color-primary)",emoji:"üìã",actions:["focus","pause","complete","abandon","delete"]},focused:{label:"üéØ Focused",color:"var(--color-warning)",emoji:"üéØ",actions:["unfocus","extend","pause","complete","abandon"]},on_hold:{label:"‚è∏Ô∏è On Hold",color:"var(--color-text-secondary)",emoji:"‚è∏Ô∏è",actions:["resume","complete","abandon","delete"]},completed:{label:"‚úÖ Completed",color:"var(--color-success)",emoji:"‚úÖ",actions:["reactivate","delete"]},abandoned:{label:"‚ùå Abandoned",color:"var(--color-danger)",emoji:"‚ùå",actions:["reactivate","delete"]}};const BRAINDUMP_DELIMITER="---\n## < -- Latest brain dump below this line -- >";const BRAINDUMP_HISTORY_HEADER="---\n## < -- Tasks created from previous brain dump -- >";const DEMO_DATA={version:"2.0-backup",exportedAt:(new Date).toISOString(),data:{pendingTasks:[{id:"demo_t1",text:"1. Set a Focus Goal.<br/><i>HOW: Click <b>'See all goals'</b> (top), then <b>'Set Focus'</b> on 'Learn Guide'. Pick a date.</i>",createdAt:new Date(Date.now()-16e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_t2",text:"2. Mark tasks as Done.<br/><i>HOW: Click <b>'Done'</b> on Task 1. Enter a short comment (5+ chars). Do the same for this task.</i>",createdAt:new Date(Date.now()-15e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_t3",text:"3. Move tasks from Bowl to Today.<br/><i>HOW: Click <b>'Task Bowl'</b> (bottom). Click <b>'Add to Today'</b> on tasks 4 & 5. Then mark this Done.</i>",createdAt:new Date(Date.now()-14e3).toISOString(),goalId:"demo_g1",aiHelpText:null}],taskBowl:[{id:"demo_b16",text:"16. You're ready! Guide is local & private.<br/><i>Feedback? Star us on <a href='https://github.com/nextfiveinc/guide'>GitHub</a> or email guide@nextfive.simplelogin.com.</i>",createdAt:(new Date).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b15",text:"15. Enable AI features (optional).<br/><i>HOW: Go to <b>Settings</b>. Enter your API Key under 'AI Provider Settings' and click <b>'Save'</b>.</i>",createdAt:new Date(Date.now()-2e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b14",text:"14. Backup your data.<br/><i>HOW: Go to <b>Settings</b> (bottom right). Click <b>'Export Full Backup'</b>.</i>",createdAt:new Date(Date.now()-3e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b13",text:"13. Manage stress.<br/><i>HOW: Click <b>'Stressed'</b> (top right). Try the <b>'Interactive Guide'</b>.</i>",createdAt:new Date(Date.now()-4e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b12",text:"12. Get unblocked.<br/><i>HOW: Click <b>'Blocked'</b> (top left). Use <b>'Help Me Get Unblocked'</b> for strategies.</i>",createdAt:new Date(Date.now()-5e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b11",text:"11. Store Reminders.<br/><i>HOW: Click <b>'Reminders'</b> (bottom right) to view or edit.</i>",createdAt:new Date(Date.now()-6e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b10",text:"10. Store Brain Dump (notes).<br/><i>HOW: Click <b>'Brain Dump'</b> (bottom center) to view or edit.</i>",createdAt:new Date(Date.now()-7e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b9",text:"9. Use Routines for getting in a flow. <br/><i>HOW: Click <b>'Routines'</b> (bottom). <b>'Edit'</b> 'Morning Kickstart', add a task, then <b>'Load'</b> it.</i>",createdAt:new Date(Date.now()-8e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b8",text:"8. Auto-Add a small task for momentum.<br/><i>HOW: Click <b>+</b> (in Pending or Bowl), then click <b>'Auto-Add'</b>.</i>",createdAt:new Date(Date.now()-9e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b7",text:"7. Create a new task.<br/><i>HOW: Click <b>+</b> (in Pending or Bowl). Type a task and click <b>'Add'</b>.</i>",createdAt:new Date(Date.now()-1e4).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b6",text:"6. Take a break.<br/><i>HOW: Click <b>'Bored'</b> (top center). Click <b>'Surprise Me!'</b>.</i>",createdAt:new Date(Date.now()-11e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b5",text:"5. Review completed work.<br/><i>HOW: Click <b>'Done List'</b> (bottom left). Check your progress.</i>",createdAt:new Date(Date.now()-12e3).toISOString(),goalId:"demo_g1",aiHelpText:null},{id:"demo_b4",text:"4. Set a new Goal.<br/><i>HOW: Click <b>'See all goals'</b> (top header). Click <b>'Add New Goal'</b>.</i>",createdAt:new Date(Date.now()-13e3).toISOString(),goalId:"demo_g1",aiHelpText:null}],goals:[{id:"demo_g1",text:"Learn Guide (The App)",createdAt:(new Date).toISOString(),status:"active",focusStartDate:null,focusEndDate:null,closedAt:null,closedReason:null}],doneTasks:[],currentGoal:null,boredState:null,referencesContent:"Use this space to dump thoughts. Click 'Process' to turn them into tasks.\n\n< -- Latest brain dump below this line -- >\nNeed to buy milk and call Mom.",remindersContent:"Reminders to self keep you on track. Guide helps you keep them handy. Use them your way. \n\n_Say, a reminder to what did you really wanted to focus on this year._\n\nClick the **Edit** button below to get started. \n\n---\n\n# NOTE\n- Basic **Markdown** _formatting_ supported.",routines:[{id:"demo_r1",name:"Morning Kickstart",tasks:["Go for a run","Coffee & Daily posts","<ADD-YOUR-NEXT-TASK-HERE>"]}],blockedTips:[{text:"Focus on the bigger picture",category:"Mindset",section:"Core Principles",issues:["overwhelm","focus"]},{text:"Work best one thing at a time",category:"Productivity Philosophy",section:"Core Principles",issues:["overwhelm","focus"]},{text:"Break down into small steps",category:"Getting Started",section:"Action Framework",issues:["starting","overwhelm"]}]}};const STARTER_PACKS={seniorPromotion:{id:"senior-promotion",category:"career",goal:{text:"Get promoted to Senior Engineer",status:"active"},pending:["Draft promotion document with 5 key achievements from last year","Schedule 1:1 with manager to discuss career growth timeline","Research 2 senior-level projects I could lead next quarter"],bowl:["Identify 5 technical gaps between my current and senior level","Find 3 senior engineers to ask for mentorship/advice","Document impact metrics from last 3 quarters","Create 90-day skill development roadmap","Update LinkedIn with recent technical accomplishments",'Prepare answers for "what does senior mean to you?" question',"Review company's promotion criteria and rubric"]},pmSwitch:{id:"pm-switch",category:"career",goal:{text:"Switch to Product Management",status:"active"},pending:["Talk to 3 PMs about their day-to-day and career path","Read 'Inspired' by Marty Cagan - first 3 chapters","Identify one product feature to propose at current job"],bowl:["Research PM certification courses - outline 5 options","Build case study portfolio - document 3 past projects","Network: Find and attend 1 PM meetup this month","Practice product sense - do 2 case studies this week","Set up coffee chats with 5 PMs in target companies","Update resume highlighting product thinking examples"]},sideProject:{id:"side-project",category:"creative",goal:{text:"Launch a profitable side project",status:"active"},pending:["Validate idea: Ask 5 potential users if they'd pay for it","Sketch 3 core features on paper - keep it brutally simple","Set up landing page using Carrd or Notion (no-code)"],bowl:["Research 10 competitors - how do they monetize?","Write initial pitch: what problem does this solve?","Choose tech stack (prioritize speed, not perfection)","Define MVP scope - cut everything not essential","Plan first 3 blog posts for launch announcement","Set up simple analytics to track interest","Create pricing tiers - start with one paid option"]},writeBook:{id:"write-book",category:"creative",goal:{text:"Write and publish a book",status:"active"},pending:["Write 500 words on any topic (just start writing)","Outline Chapter 1 in bullet points - brain dump ideas","Research 3 self-publishing platforms (KDP, Gumroad, Leanpub)"],bowl:["Interview 5 people for stories/content/insights","Create full book outline - all chapters with main points","Set up daily writing routine - define when and where","Find accountability partner or join writing group","Research book cover designers on Fiverr/99designs","Create content calendar - 1 chapter per week target","Build email list for launch - set up landing page"]},homeDownPayment:{id:"home-down-payment",category:"financial",goal:{text:"Save ‚Çπ15L for home down payment",status:"active"},pending:["Calculate exact target: down payment + registration + buffer","Open high-yield savings account or recurring deposit","Set up auto-transfer: 25% of monthly income starting today"],bowl:["Research mortgage pre-approval process and requirements","Track ALL expenses for 1 month (every rupee)","Identify 3 spending categories to cut by 30%","Research first-time home buyer schemes (PMAY, etc.)","Calculate monthly EMI vs current rent comparison","Visit 3 societies to understand real costs","Set up separate savings account - out of sight, out of mind"]},learnSpanish:{id:"learn-spanish",category:"personal",goal:{text:"Reach conversational Spanish in 6 months",status:"active"},pending:["Download Duolingo + complete Day 1 lessons","Find one Spanish podcast for beginners (Notes in Spanish)","Block 15 minutes daily in calendar - non-negotiable"],bowl:["Join language exchange meetup or find Tandem partner","Watch one Spanish show with English subtitles this week","Practice with ChatGPT in Spanish - 3 conversations/week","Find online tutor on italki - 1 hour per week","Set 90-day checkpoint: hold 5-min conversation","Create flashcards for 100 most common Spanish words"]}};const CATEGORIES={career:{id:"career",icon:"üöÄ",title:"Career & Growth",subtitle:"Get promoted, switch careers, learn new skills",packs:["seniorPromotion","pmSwitch"]},creative:{id:"creative",icon:"üí°",title:"Creative Projects",subtitle:"Write a book, launch a side project, build a portfolio",packs:["sideProject","writeBook"]},financial:{id:"financial",icon:"üí∞",title:"Financial Goals",subtitle:"Save money, buy a home, invest wisely",packs:["homeDownPayment"]},personal:{id:"personal",icon:"üéØ",title:"Personal Development",subtitle:"Learn languages, build habits, grow skills",packs:["learnSpanish"]}};let pendingTasks=[],doneTasks=[],taskBowl=[],goals=[],currentGoal=null,routines=[],activeBlitzes={},blitzWorker=null,boredModeState={},referencesContent="",remindersContent="",toastTimeout=null;let activeFlowTasks=[];let previousAiQ=null;let previousAiA=null;const ALARM_SOUND_URI="data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq";const views=document.querySelectorAll(".app-view");const backButton=document.getElementById("back-to-main");const currentGoalDisplay=document.getElementById("current-goal-display");const seeAllGoalsLink=document.getElementById("see-all-goals-link");const modalOverlay=document.getElementById("modal-overlay");const modalTitle=document.getElementById("modal-title");const modalBody=document.getElementById("modal-body");const toastElement=document.getElementById("toast-notification");const mainContentArea=document.getElementById("main-content-area");let pendingTasksList,addTaskBtn,addTaskForm,newTaskInput,tagWithGoalCheckbox,submitAddTaskBtn,autoAddTaskBtn,cancelAddTaskBtn,emptyPendingMessage,goalsList,addNewGoalBtn,addGoalForm,newGoalInput,submitAddGoalBtn,cancelAddGoalBtn,emptyGoalsMessage,doneListContainer,doneTimeFilter,doneGoalFilter,emptyDoneMessage,taskBowlListContainer,emptyTaskBowlMessage,referencesView,remindersView,copyGoalsBtn,copyDoneBtn,copyBowlBtn,copyRefsBtn,copyRemindersBtn,resetAppBtn,loadRoutineBtn,routinesView,routinesList,addNewRoutineBtn,addRoutineForm,newRoutineNameInput,newRoutineTasksInput,submitAddRoutineBtn,cancelAddRoutineBtn,emptyRoutinesMessage,editRoutineIdInput,routineLoaderArea,goalGuideBtn,copySummaryBtn,processBrainDumpBtn,onboardingTriggerWrapper,startOnboardingBtn;function createBlitzWorker(){const workerCode=`\n                    let timers = {}; // Store active timers by taskId\n                    self.onmessage = function(e) {\n                        const { command, taskId } = e.data;\n                        if (command === 'start') {\n                            if (timers[taskId]) {\n                                clearInterval(timers[taskId].intervalId);\n                            }\n                            let remainingTime = 5 * 60; // 5 minutes\n                            timers[taskId] = {\n                                intervalId: setInterval(() => {\n                                    remainingTime--;\n                                    self.postMessage({ event: 'tick', taskId: taskId, time: remainingTime });\n                                    if (remainingTime <= 0) {\n                                        clearInterval(timers[taskId].intervalId);\n                                        delete timers[taskId];\n                                        self.postMessage({ event: 'done', taskId: taskId });\n                                    }\n                                }, 1000)\n                            };\n                        } else if (command === 'stop') {\n                            if (timers[taskId]) {\n                                clearInterval(timers[taskId].intervalId);\n                                delete timers[taskId];\n                            }\n                        }\n                    };\n                `;const blob=new Blob([workerCode],{type:"application/javascript"});return new Worker(URL.createObjectURL(blob))}function loadFromLocalStorage(key,defaultValue=null){try{const item=localStorage.getItem(key);return item?JSON.parse(item):defaultValue}catch(error){console.error(`Error loading item "${key}" from localStorage:`,error);return defaultValue}}function saveToLocalStorage(key,data){try{localStorage.setItem(key,JSON.stringify(data))}catch(error){console.error(`Error saving item "${key}" to localStorage:`,error);showToast(`Error saving data. Storage might be full.`,"error")}}function migrateGoalsToV2(){let needsMigration=false;goals.forEach(goal=>{if(!goal.status){needsMigration=true;goal.status=goal.endDate?GOAL_STATUS.FOCUSED:GOAL_STATUS.ACTIVE;if(goal.endDate){goal.focusEndDate=goal.endDate;goal.focusStartDate=goal.createdAt;delete goal.endDate}goal.closedAt=null;goal.closedReason=null}if(!goal.focusStartDate)goal.focusStartDate=null;if(!goal.focusEndDate)goal.focusEndDate=null;if(!goal.closedAt)goal.closedAt=null;if(!goal.closedReason)goal.closedReason=null});if(needsMigration){saveToLocalStorage(LS_KEYS.goals,goals);console.log("Goals migrated to v2 lifecycle format")}return needsMigration}function getGoalTaskCounts(goalId){return{pending:pendingTasks.filter(t=>t.goalId===goalId).length,bowl:taskBowl.filter(t=>t.goalId===goalId).length,done:doneTasks.filter(t=>t.goalId===goalId).length}}function getGoalsGroupedByStatus(){const grouped={focused:[],active:[],on_hold:[],completed:[],abandoned:[]};goals.forEach(goal=>{const status=goal.status||GOAL_STATUS.ACTIVE;if(grouped[status]){grouped[status].push(goal)}});return grouped}function unlinkTasksFromGoal(goalId){let unlinkedCount=0;pendingTasks.forEach(task=>{if(task.goalId===goalId){task.goalId=null;unlinkedCount++}});taskBowl.forEach(task=>{if(task.goalId===goalId){task.goalId=null;unlinkedCount++}});saveToLocalStorage(LS_KEYS.pending,pendingTasks);saveToLocalStorage(LS_KEYS.bowl,taskBowl);return unlinkedCount}function showView(viewId){views.forEach(view=>view.classList.remove("active"));const targetView=document.getElementById(viewId);if(targetView){targetView.classList.add("active");backButton.classList.toggle("hidden",viewId==="main-view");mainContentArea.scrollTop=0;if(viewId==="bored-view")BoredMode.initDisplay();else BoredMode.cleanup();if(viewId==="stressed-view")StressedMode.initDisplay();if(viewId==="blocked-view")BlockedMode.initDisplay();if(viewId==="done-list-view")renderDoneList();if(viewId==="goals-view")renderGoals();if(viewId==="task-bowl-view")renderTaskBowl(true);if(viewId==="settings-view")loadAiSettingsUI();if(viewId==="routines-view")renderRoutines();if(viewId==="references-view")setupEditableContentView(referencesView,LS_KEYS.references);if(viewId==="reminders-view")setupEditableContentView(remindersView,LS_KEYS.reminders)}else{console.error("View not found:",viewId);showView("main-view")}}const ICONS={sun:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,moon:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`};function applyTheme(theme){const themeToggleBtn=document.getElementById("theme-toggle");if(theme==="dark"){document.body.classList.add("dark-theme");themeToggleBtn.innerHTML=ICONS.sun}else{document.body.classList.remove("dark-theme");themeToggleBtn.innerHTML=ICONS.moon}}function toggleTheme(){const isDark=document.body.classList.contains("dark-theme");const newTheme=isDark?"light":"dark";applyTheme(newTheme);saveToLocalStorage(LS_KEYS.theme,newTheme)}function showToast(message,type="info",duration=3e3){toastElement.textContent=message;toastElement.className=`toast-${type}`;toastElement.classList.add("show");if(toastTimeout)clearTimeout(toastTimeout);toastTimeout=setTimeout(()=>{toastElement.classList.remove("show");toastTimeout=null},duration)}function showModal(title,bodyContent,confirmCallback,confirmText="Confirm",cancelText="Cancel"){modalTitle.textContent=title;if(typeof bodyContent==="string"){modalBody.innerHTML=`<p>${bodyContent}</p>`}else{modalBody.innerHTML="";modalBody.appendChild(bodyContent)}const confirmBtn=document.getElementById("modal-confirm-btn");const cancelBtn=document.getElementById("modal-cancel-btn");if(!confirmBtn||!cancelBtn){console.error("Modal buttons not found!");return}confirmBtn.textContent=confirmText;cancelBtn.textContent=cancelText;confirmBtn.className="btn";if(confirmText.toLowerCase()==="delete"||confirmText.toLowerCase()==="reset"||confirmText.toLowerCase().includes("overwrite")){confirmBtn.classList.add("btn-danger")}else if(confirmText.toLowerCase().includes("save")||confirmText.toLowerCase().includes("submit")||confirmText.toLowerCase().includes("bowl")||confirmText.toLowerCase().includes("process")){confirmBtn.classList.add("btn-success")}else{confirmBtn.classList.add("btn-primary")}confirmBtn.onclick=()=>{if(confirmCallback)confirmCallback();modalOverlay.classList.add("hidden")};cancelBtn.onclick=()=>modalOverlay.classList.add("hidden");modalOverlay.classList.remove("hidden")}function promptForApiKey(provider){const providerName=provider.charAt(0).toUpperCase()+provider.slice(1);const modalBodyDiv=document.createElement("div");modalBodyDiv.innerHTML=`\n                    <p><strong>API Key Needed for ${providerName}</strong></p>\n                    <p><small>Please enter your API key below. It will be saved securely in your browser's local storage.</small></p>\n                    <label for="gemini-api-key-input">Enter ${providerName} API Key:</label>\n                    <input type="password" id="gemini-api-key-input" placeholder="Paste your key here" style="width: 100%;">`;const apiKeyInput=modalBodyDiv.querySelector("#gemini-api-key-input");const saveCallback=()=>{const enteredKey=apiKeyInput.value.trim();if(enteredKey){const settings=loadFromLocalStorage(LS_KEYS.aiSettings,{activeProvider:provider,keys:{}});settings.keys[provider]=enteredKey;saveToLocalStorage(LS_KEYS.aiSettings,settings);showToast(`${providerName} API Key saved! You can now retry the AI action.`,"success")}};showModal("API Key Required",modalBodyDiv,saveCallback,"Save Key")}function renderAIResultWithCopy(wrapperId,contentId,copyBtnId,markdownText){const wrapper=document.getElementById(wrapperId);const contentDiv=document.getElementById(contentId);const copyBtn=document.getElementById(copyBtnId);if(!wrapper||!contentDiv||!copyBtn)return;contentDiv.innerHTML=parseMarkdown(markdownText);wrapper.style.display="block";copyBtn.onclick=()=>{navigator.clipboard.writeText(markdownText);const originalText="Copy (MD)";copyBtn.textContent="Copied!";setTimeout(()=>copyBtn.textContent=originalText,2e3)}}function parseMarkdown(markdown){if(!markdown)return"";let html=markdown.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");html=html.replace(/^###### (.*$)/gm,"<h6>$1</h6>");html=html.replace(/^##### (.*$)/gm,"<h5>$1</h5>");html=html.replace(/^#### (.*$)/gm,"<h4>$1</h4>");html=html.replace(/^### (.*$)/gm,"<h3>$1</h3>");html=html.replace(/^## (.*$)/gm,"<h2>$1</h2>");html=html.replace(/^# (.*$)/gm,"<h1>$1</h1>");html=html.replace(/^\s*(?:---|---|\*\*\*)\s*$/gm,"<hr>");html=html.replace(/^> (.*$)/gm,"<blockquote>$1</blockquote>");html=html.replace(/<\/blockquote>\s*<blockquote>/g,"<br>");html=html.replace(/^\s*[*+-]\s+(.*$)/gm,"<li>$1</li>");html=html.replace(/(<li>.*<\/li>)/gms,match=>`<ul>${match}</ul>`);html=html.replace(/<\/ul>\s*<ul>/g,"");html=html.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');html=html.replace(/\*\*([^\*]+)\*\*/g,"<strong>$1</strong>");html=html.replace(/__([^_]+)__/g,"<strong>$1</strong>");html=html.replace(/\*([^\*]+)\*/g,"<em>$1</em>");html=html.replace(/_([^_]+)_/g,"<em>$1</em>");html=html.split("\n").map(line=>line.trim()).reduce((acc,line)=>{if(line===""){if(acc.inParagraph){acc.html+="</p>";acc.inParagraph=false}}else if(/^<\/?(ul|ol|li|h[1-6]|blockquote|hr)/.test(line)){if(acc.inParagraph){acc.html+="</p>";acc.inParagraph=false}acc.html+=line+"\n"}else{if(!acc.inParagraph){acc.html+="<p>";acc.inParagraph=true}else{acc.html+="<br>"}acc.html+=line}return acc},{html:"",inParagraph:false}).html;if(html.endsWith("<p>"))html=html.substring(0,html.length-3);else if(html.endsWith("<br>"))html=html.substring(0,html.length-4);return html.trim()}function generateId(){return Date.now().toString(36)+Math.random().toString(36).substring(2,7)}function formatDate(dateString){if(!dateString)return"";try{const date=new Date(dateString);const day=String(date.getDate()).padStart(2,"0");const month=String(date.getMonth()+1).padStart(2,"0");const year=date.getFullYear();return`${day}/${month}/${year}`}catch(e){return dateString}}function getCurrentTimestamp(){return(new Date).toISOString()}function getTodayDateString(){const today=new Date;const year=today.getFullYear();const month=String(today.getMonth()+1).padStart(2,"0");const day=String(today.getDate()).padStart(2,"0");return`${year}-${month}-${day}`}function truncate(str,maxLength){if(!str)return"";if(str.length<=maxLength){return str}return str.substring(0,maxLength)+"..."}function generateGoalOptionsHTML(includeArchived=true,selectedGoalId=null){const groups={current:{label:"üî• Current Focus",goals:[]},active:{label:"üìã Active & On Hold",goals:[]},archived:{label:"üóÑÔ∏è Archived",goals:[]}};goals.forEach(g=>{if(g.status==="focused"){groups.current.goals.push(g)}else if(g.status==="completed"||g.status==="abandoned"){if(includeArchived)groups.archived.goals.push(g)}else{groups.active.goals.push(g)}});let html="";const renderGroup=group=>{if(group.goals.length===0)return;html+=`<optgroup label="${group.label}">`;group.goals.forEach(g=>{const isSelected=selectedGoalId===g.id?"selected":"";html+=`<option value="${g.id}" ${isSelected}>${truncate(g.text,50)}</option>`});html+=`</optgroup>`};renderGroup(groups.current);renderGroup(groups.active);renderGroup(groups.archived);return html}function copyToClipboard(text){if(!text){showToast("Nothing to copy.","warning");return}navigator.clipboard.writeText(text).then(()=>{showToast("Copied to clipboard!","success")}).catch(err=>{console.error("Copy failed:",err);showToast("Copy failed. Please try manually.","error")})}function formatGoalsAsMarkdown(){if(goals.length===0)return"No goals defined.";let md="# Goals\n\n";goals.forEach(goal=>{md+=`- ${goal.text}`;if(currentGoal&&currentGoal.id===goal.id){md+=` **[Current Focus`;if(goal.endDate){md+=` until ${formatDate(goal.endDate)}`}md+=`]**`}md+="\n"});return md}function formatDoneListAsMarkdown(){if(doneTasks.length===0)return"No tasks completed yet.";let md="# Done List\n\n";doneTasks.forEach(task=>{const goalName=task.goalId?goals.find(g=>g.id===task.goalId)?.text||"Unknown Goal":"No Goal";md+=`- **${task.text}**\n`;md+=`  - Goal: ${goalName}\n`;md+=`  - Action: ${task.actionTaken}\n`;md+=`  - Completed: ${formatDate(task.doneAt)}\n\n`});return md}function formatTaskBowlAsMarkdown(){if(taskBowl.length===0)return"Task Bowl is empty.";let md="# Task Bowl\n\n";taskBowl.forEach(task=>{const goalName=task.goalId?goals.find(g=>g.id===task.goalId)?.text||"Unknown Goal":"No Goal";md+=`- ${task.text}\n`;md+=`  - Goal: ${goalName}\n`;md+=`  - Created: ${formatDate(task.createdAt)}\n\n`});return md}function setupEditableContentView(viewElement,storageKey){if(!viewElement)return;const displayDiv=viewElement.querySelector('[id$="-content-display"]');const editTextarea=viewElement.querySelector('[id$="-content-edit"]');const editBtn=viewElement.querySelector(".btn-edit");const saveBtn=viewElement.querySelector(".btn-save");const cancelBtn=viewElement.querySelector(".btn-cancel");if(!displayDiv||!editTextarea||!editBtn||!saveBtn||!cancelBtn){console.error("Editable content view elements missing for:",storageKey);return}const content=loadFromLocalStorage(storageKey,"");displayDiv.innerHTML=parseMarkdown(content);editTextarea.value=content;editBtn.onclick=()=>{viewElement.querySelector(".view-mode").style.display="none";viewElement.querySelector(".edit-mode").style.display="block";editBtn.classList.add("hidden");saveBtn.classList.remove("hidden");cancelBtn.classList.remove("hidden");editTextarea.focus()};saveBtn.onclick=()=>{const newContent=editTextarea.value;saveToLocalStorage(storageKey,newContent);displayDiv.innerHTML=parseMarkdown(newContent);viewElement.querySelector(".view-mode").style.display="block";viewElement.querySelector(".edit-mode").style.display="none";editBtn.classList.remove("hidden");saveBtn.classList.add("hidden");cancelBtn.classList.add("hidden");showToast("Content saved.","success")};cancelBtn.onclick=()=>{editTextarea.value=loadFromLocalStorage(storageKey,"");viewElement.querySelector(".view-mode").style.display="block";viewElement.querySelector(".edit-mode").style.display="none";editBtn.classList.remove("hidden");saveBtn.classList.add("hidden");cancelBtn.classList.add("hidden")}}async function safeAsyncCall(asyncFn,errorContext){try{return await asyncFn()}catch(error){console.error(`Error in ${errorContext}:`,error);showToast(`${errorContext} failed: ${error.message}`,"error",4e3);return null}}function updateCurrentGoalDisplay(){if(!tagWithGoalCheckbox||!currentGoalDisplay||!newTaskInput){console.warn("updateCurrentGoalDisplay called before DOM elements ready.");return}if(currentGoal&&currentGoal.text){const formattedEndDate=formatDate(currentGoal.endDate);currentGoalDisplay.innerHTML=`Current goal: <strong>${currentGoal.text}</strong>${formattedEndDate?` till ${formattedEndDate}`:""}`;tagWithGoalCheckbox.disabled=false;tagWithGoalCheckbox.parentElement.style.opacity=1}else{currentGoalDisplay.innerHTML=`No current focus set. <a href="#" id="set-goal-link">Set one?</a>`;tagWithGoalCheckbox.disabled=true;tagWithGoalCheckbox.checked=false;tagWithGoalCheckbox.parentElement.style.opacity=.5;const setGoalLink=document.getElementById("set-goal-link");if(setGoalLink)setGoalLink.onclick=e=>{e.preventDefault();showView("goals-view")}}updateAddTaskPlaceholder()}function updateAddTaskPlaceholder(){if(!newTaskInput)return;const placeholders=["What needs a decision?","What small step?","Where stuck?","Get off plate?","Cancel/delegate?","Commitment?","Add details..."];newTaskInput.placeholder=currentGoal&&currentGoal.text?`E.g. related to ${currentGoal.text}`:placeholders[Math.floor(Math.random()*placeholders.length)]}function promptStartBlitz(taskId){const task=pendingTasks.find(t=>t.id===taskId);if(!task)return;if(activeBlitzes[taskId]){showToast("Blitz already running for this task.","warning");return}const confirmCallback=()=>{startBlitz(taskId)};showModal("Start 5-Minute Blitz",`Focus intensely on: "${task.text}" for 5 minutes?`,confirmCallback,"Start Blitz")}function startBlitz(taskId){if(!blitzWorker){showToast("Blitz timer unavailable.","error");return}activeBlitzes[taskId]={startTime:Date.now(),remainingTime:5*60};blitzWorker.postMessage({command:"start",taskId:taskId});updateBlitzUI(taskId);showToast("Blitz timer started! 5 minutes of focus.","success")}function stopAndCleanUpBlitz(taskId){if(!activeBlitzes[taskId])return;if(blitzWorker){blitzWorker.postMessage({command:"stop",taskId:taskId})}delete activeBlitzes[taskId];const card=pendingTasksList?.querySelector(`[data-task-id="${taskId}"]`);if(card){const blitzBtn=card.querySelector(".btn-blitz");if(blitzBtn){blitzBtn.textContent="‚ö°";blitzBtn.disabled=false;blitzBtn.style.backgroundColor=""}}}function handleBlitzTick(taskId,remainingTime){if(!activeBlitzes[taskId])return;activeBlitzes[taskId].remainingTime=remainingTime;updateBlitzUI(taskId)}function handleBlitzDone(taskId){try{const audio=new Audio(ALARM_SOUND_URI);audio.play().catch(e=>console.log("Sound play failed:",e))}catch(e){console.log("Audio creation failed:",e)}delete activeBlitzes[taskId];showToast("‚è∞ Blitz complete! Time to mark it done?","success",5e3);updateBlitzUI(taskId)}function updateBlitzUI(taskId){const card=pendingTasksList?.querySelector(`[data-task-id="${taskId}"]`);if(!card)return;const blitzBtn=card.querySelector(".btn-blitz");if(!blitzBtn)return;const blitz=activeBlitzes[taskId];if(blitz){const mins=Math.floor(blitz.remainingTime/60);const secs=blitz.remainingTime%60;blitzBtn.textContent=`${mins}:${secs.toString().padStart(2,"0")}`;blitzBtn.disabled=true;blitzBtn.style.backgroundColor="var(--color-danger)"}else{blitzBtn.textContent="‚ö°";blitzBtn.disabled=false;blitzBtn.style.backgroundColor=""}}function checkDailyReset(){const lastDate=loadFromLocalStorage(LS_KEYS.lastOpenedDate);const today=getTodayDateString();if(lastDate&&lastDate!==today){if(pendingTasks.length>0){triggerDailyResetModal()}else{saveToLocalStorage(LS_KEYS.lastOpenedDate,today)}}else if(!lastDate){saveToLocalStorage(LS_KEYS.lastOpenedDate,today)}}function triggerDailyResetModal(){const modalBodyDiv=document.createElement("div");const taskList=pendingTasks.map(t=>`<li>${truncate(t.text,40)}</li>`).join("");modalBodyDiv.innerHTML=`\n                    <p>Welcome back! You have <strong>${pendingTasks.length} tasks</strong> pending from yesterday:</p>\n                    <ul style="margin: 10px 0 20px 20px; color: var(--color-text-secondary); font-size: 0.9em;">\n                        ${taskList}\n                    </ul>\n                    <div style="display: flex; flex-direction: column; gap: 10px;">\n                        <button id="reset-continue" class="btn btn-primary" style="padding: 12px;">‚û°Ô∏è Continue with them today</button>\n                        <button id="reset-routine" class="btn btn-success" style="padding: 12px;">üåÖ Load Routine & Bowl Others</button>\n                        <button id="reset-fresh" class="btn btn-secondary" style="padding: 12px;">üßπ Bowl All & Start Fresh</button>\n                    </div>\n                `;showModal("New Day Reset",modalBodyDiv,null,"Close"," ");const defaultActions=document.querySelector("#modal-content .modal-actions");if(defaultActions)defaultActions.style.display="none";setTimeout(()=>{document.getElementById("reset-continue").onclick=()=>{saveToLocalStorage(LS_KEYS.lastOpenedDate,getTodayDateString());showToast("Let's finish what we started.","info");closeResetModal()};document.getElementById("reset-fresh").onclick=()=>{moveAllPendingToBowl();saveToLocalStorage(LS_KEYS.lastOpenedDate,getTodayDateString());showToast("Clean slate. Make it count.","success");closeResetModal()};document.getElementById("reset-routine").onclick=()=>{moveAllPendingToBowl();saveToLocalStorage(LS_KEYS.lastOpenedDate,getTodayDateString());closeResetModal();if(routines.length===0){showToast("No routines found. Let's create one!","info");showView("routines-view")}else if(routines.length===1){startFlowMode(routines[0].id);showToast("Getting into the flow...","success")}else{showRoutineSelectorModal()}}},50)}function closeResetModal(){const defaultActions=document.querySelector("#modal-content .modal-actions");if(defaultActions)defaultActions.style.display="block";modalOverlay.classList.add("hidden")}function moveAllPendingToBowl(){if(pendingTasks.length===0)return;taskBowl=[...pendingTasks,...taskBowl];pendingTasks=[];saveToLocalStorage(LS_KEYS.pending,pendingTasks);saveToLocalStorage(LS_KEYS.bowl,taskBowl);renderPendingTasks();renderTaskBowl()}function showRoutineSelectorModal(){const modalBodyDiv=document.createElement("div");let options=routines.map(r=>`<option value="${r.id}">${r.name}</option>`).join("");modalBodyDiv.innerHTML=`\n                    <p>Select a routine to start your day:</p>\n                    <select id="reset-routine-select" style="margin-top: 10px;">${options}</select>\n                `;const confirmCallback=()=>{const select=document.getElementById("reset-routine-select");if(select&&select.value){startFlowMode(select.value);showToast("Getting into the flow...","success")}};showModal("Select Routine",modalBodyDiv,confirmCallback,"Start Routine")}function checkIfFreshInstall(){return pendingTasks.length===0&&doneTasks.length===0&&taskBowl.length===0&&goals.length===0&&routines.length===0}function showOnboardingModal(){const modalBodyDiv=document.createElement("div");modalBodyDiv.innerHTML=`\n                    <p style="margin-bottom: 20px;">\n                        Welcome to Guide! Since this is a fresh install, would you like to load some sample data?\n                    </p>\n                    <p style="margin-bottom: 20px; font-size: 0.9em; color: var(--color-text-secondary);">\n                        This will set up example Goals, Tasks, and Routines so you can see how the app works instantly.\n                    </p>\n                    <div style="text-align: center; margin: 30px 0;">\n                        <button id="load-demo-btn" class="btn btn-success" style="font-size: 1.1em; padding: 15px 30px; width: 100%;">\n                            ‚ú® Load Demo Data\n                        </button>\n                    </div>\n                `;const loadBtn=modalBodyDiv.querySelector("#load-demo-btn");loadBtn.addEventListener("click",()=>{const restoreDemoData=()=>{try{if(!DEMO_DATA.data||!DEMO_DATA.version.startsWith("2.0")){throw new Error("Internal Demo Data is corrupted.")}Object.entries(DEMO_DATA.data).forEach(([keyName,data])=>{const lsKey=LS_PREFIX+keyName;if(Object.values(LS_KEYS).includes(lsKey)){saveToLocalStorage(lsKey,data)}});showToast("Demo data loaded! Reloading...","success");setTimeout(()=>location.reload(),1e3)}catch(error){showToast(`Error loading demo: ${error.message}`,"error",5e3)}};showModal("Load Demo Data?","This will fill your lists with example tasks. You can delete them later.",restoreDemoData,"Yes, Load it")});showModal("Get Started",modalBodyDiv,null,"Close"," ");const cancelBtn=document.getElementById("modal-cancel-btn");if(cancelBtn)cancelBtn.style.display="none"}function renderPendingTasks(){pendingTasksList.innerHTML="";const hasTasks=pendingTasks.length>0;emptyPendingMessage.classList.toggle("hidden",hasTasks);routineLoaderArea.classList.toggle("hidden",hasTasks);if(!hasTasks&&checkIfFreshInstall()){onboardingTriggerWrapper.classList.remove("hidden")}else{onboardingTriggerWrapper.classList.add("hidden")}pendingTasks.forEach(task=>{const card=document.createElement("div");card.className="task-card";card.dataset.taskId=task.id;let goalText="[Add Goal]";if(task.goalId){const linkedGoal=goals.find(g=>g.id===task.goalId);if(linkedGoal){goalText=truncate(linkedGoal.text,40)}}const goalHTML=`<span class="task-goal-tag">Goal: <a href="#" class="edit-task-goal-link" data-task-id="${task.id}" data-list-name="pending">${goalText}</a></span>`;const helpHTML=task.aiHelpText?`<div class="task-help-suggestion">${task.aiHelpText}</div>`:"";card.innerHTML=`\n                        <div class="task-content">\n                            <div class="task-text-display">\n                                <span class="task-text">${task.text}</span>\n                            </div>\n                            <div class="task-text-edit hidden">\n                                <textarea class="task-edit-input" rows="2">${task.text}</textarea>\n                                <div style="margin-top: 8px;">\n                                    <button class="btn-save-edit btn-success btn-sm">Save</button>\n                                    <button class="btn-cancel-edit btn-secondary btn-sm">Cancel</button>\n                                </div>\n                            </div>\n                            ${goalHTML}\n                            ${helpHTML}\n                        </div>\n                        <div class="task-actions">\n                            \x3c!-- Primary Actions (Always Visible) --\x3e\n                            <button class="btn-done btn-success">Done</button>\n                            <button class="btn-blitz" title="Start a 5-min Blitz">‚ö°</button>\n                            \x3c!-- Mobile Menu Toggle --\x3e\n                            <button class="btn-more btn-secondary">‚ãÆ</button>\n                            \x3c!-- Secondary Actions (Row on Desktop, Dropdown on Mobile) --\x3e\n                            <div class="secondary-actions-group">\n                                <button class="btn-edit btn-secondary">üìù<span class="btn-label">Edit</span></button>\n                                <button class="btn-move-to-bowl btn-move">üì•<span class="btn-label">To Bowl</span></button>\n                                <button class="btn-help">ü§ñ<span class="btn-label">AI Help</span></button>\n                                <button class="btn-delete btn-danger">üóëÔ∏è<span class="btn-label">Delete</span></button>\n                            </div>\n                        </div>\n                    `;const moreBtn=card.querySelector(".btn-more");const menuGroup=card.querySelector(".secondary-actions-group");moreBtn.addEventListener("click",e=>{e.stopPropagation();document.querySelectorAll(".secondary-actions-group.active").forEach(el=>{if(el!==menuGroup)el.classList.remove("active")});menuGroup.classList.toggle("active")});document.addEventListener("click",e=>{if(!card.contains(e.target)){menuGroup.classList.remove("active")}});card.querySelector(".btn-done").addEventListener("click",()=>promptMarkDone(task.id));card.querySelector(".btn-blitz").addEventListener("click",()=>promptStartBlitz(task.id));card.querySelector(".btn-move-to-bowl").addEventListener("click",()=>moveTaskToBowl(task.id));card.querySelector(".btn-help").addEventListener("click",()=>getHelpForTask(task.id));card.querySelector(".btn-delete").addEventListener("click",()=>confirmDeleteTask(task.id,"pending"));card.querySelector(".btn-edit").addEventListener("click",()=>startEditingTask(task.id,"pending"));card.querySelector(".btn-save-edit").addEventListener("click",()=>saveTaskEdit(task.id,"pending"));card.querySelector(".btn-cancel-edit").addEventListener("click",()=>cancelTaskEdit(task.id,"pending"));pendingTasksList.appendChild(card)})}function handleAddTask(forceToBowl=false){const text=newTaskInput.value.trim();if(!text){showToast("Task description cannot be empty.","warning");return}const newTask={id:generateId(),text:text,createdAt:getCurrentTimestamp(),goalId:tagWithGoalCheckbox.checked&&currentGoal?currentGoal.id:null,aiHelpText:null};if(!forceToBowl&&pendingTasks.length<MAX_PENDING_TASKS){pendingTasks.push(newTask);saveToLocalStorage(LS_KEYS.pending,pendingTasks);renderPendingTasks();showToast("Task added to Pending Today.","success")}else{taskBowl.unshift(newTask);saveToLocalStorage(LS_KEYS.bowl,taskBowl);if(document.getElementById("task-bowl-view").classList.contains("active")){renderTaskBowl(false)}showToast(forceToBowl?"Task added to Bowl.":"Pending full. Task added to Bowl.","info")}newTaskInput.value="";tagWithGoalCheckbox.checked=false;addTaskForm.classList.add("hidden");document.getElementById("add-task-btn").classList.remove("hidden");document.getElementById("add-task-to-bowl-btn").classList.remove("hidden");updateAddTaskPlaceholder()}function addAutoTask(forceToBowl=false){const templates=["Close oldest browser tab.","Finish 5-min task.","Delete unused app/file.","Send 1-sentence email.","Decide dinner.","Review schedule.","Drink water.","Stretch 60s.","Write gratitude.","Tidy workspace 3min."];newTaskInput.value=templates[Math.floor(Math.random()*templates.length)];tagWithGoalCheckbox.checked=false;handleAddTask(forceToBowl)}function promptMarkDone(taskId,sourceList="pending"){const task=(sourceList==="pending"?pendingTasks:taskBowl).find(t=>t.id===taskId);if(!task)return;const modalBodyDiv=document.createElement("div");modalBodyDiv.innerHTML=`<p>Marking task as done: <strong>${task.text}</strong></p><label for="action-taken-input">Action taken: (min 5 chars)</label><textarea id="action-taken-input" rows="2" style="width: 100%; margin-top: 5px;"></textarea>`;const actionInput=modalBodyDiv.querySelector("#action-taken-input");showModal("Mark Task Done",modalBodyDiv,()=>{const actionText=actionInput.value.trim();if(actionText.length<5){showToast("Min 5 chars for action.","warning");promptMarkDone(taskId,sourceList);return}markTaskDone(taskId,actionText,sourceList)},"Submit Done");setTimeout(()=>actionInput.focus(),50)}function markTaskDone(taskId,actionText,sourceList){if(sourceList==="pending")stopAndCleanUpBlitz(taskId);let taskIndex,task,list,key;if(sourceList==="pending"){list=pendingTasks;key=LS_KEYS.pending}else{list=taskBowl;key=LS_KEYS.bowl}taskIndex=list.findIndex(t=>t.id===taskId);if(taskIndex>-1){task=list.splice(taskIndex,1)[0];saveToLocalStorage(key,list);if(sourceList==="pending")renderPendingTasks();else if(document.getElementById("task-bowl-view").classList.contains("active"))renderTaskBowl();const doneItem={...task,actionTaken:actionText,doneAt:getCurrentTimestamp()};delete doneItem.aiHelpText;doneTasks.push(doneItem);doneTasks.sort((a,b)=>new Date(b.doneAt)-new Date(a.doneAt));saveToLocalStorage(LS_KEYS.done,doneTasks);showToast("Task marked as done.","success");if(document.getElementById("done-list-view").classList.contains("active"))renderDoneList()}else{showToast("Task not found.","error")}}function confirmDeleteTask(taskId,sourceList){const taskText=(sourceList==="pending"?pendingTasks:taskBowl).find(t=>t.id===taskId)?.text;showModal("Confirm Deletion",`Delete task: "${taskText||"Unknown Task"}"?`,()=>deleteTask(taskId,sourceList),"Delete")}function deleteTask(taskId,sourceList){if(sourceList==="pending")stopAndCleanUpBlitz(taskId);let taskIndex=-1,list,key,renderFunc;if(sourceList==="pending"){list=pendingTasks;key=LS_KEYS.pending;renderFunc=renderPendingTasks}else{list=taskBowl;key=LS_KEYS.bowl;renderFunc=renderTaskBowl}taskIndex=list.findIndex(t=>t.id===taskId);if(taskIndex>-1){list.splice(taskIndex,1);saveToLocalStorage(key,list);showToast(`Task deleted from ${sourceList==="pending"?"Pending":"Task Bowl"}.`,"info");if(document.getElementById(sourceList==="pending"?"main-view":"task-bowl-view").classList.contains("active")){renderFunc()}}else{showToast("Task not found.","warning")}}function startEditingTask(taskId,listName){const list=listName==="pending"?pendingTasksList:taskBowlListContainer;const card=list.querySelector(`[data-task-id="${taskId}"]`);if(!card)return;const displayDiv=card.querySelector(".task-text-display");const editDiv=card.querySelector(".task-text-edit");const editInput=card.querySelector(".task-edit-input");const actionsDiv=card.querySelector(".task-actions");displayDiv.classList.add("hidden");editDiv.classList.remove("hidden");actionsDiv.style.display="none";editInput.focus();editInput.setSelectionRange(editInput.value.length,editInput.value.length)}function saveTaskEdit(taskId,listName){const list=listName==="pending"?pendingTasks:taskBowl;const storageKey=listName==="pending"?LS_KEYS.pending:LS_KEYS.bowl;const listElement=listName==="pending"?pendingTasksList:taskBowlListContainer;const card=listElement.querySelector(`[data-task-id="${taskId}"]`);if(!card)return;const editInput=card.querySelector(".task-edit-input");const newText=editInput.value.trim();if(!newText){showToast("Task text cannot be empty.","warning");return}const taskIndex=list.findIndex(t=>t.id===taskId);if(taskIndex>-1){list[taskIndex].text=newText;saveToLocalStorage(storageKey,list);if(listName==="pending"){renderPendingTasks()}else{renderTaskBowl(false)}showToast("Task updated.","success")}}function cancelTaskEdit(taskId,listName){const listElement=listName==="pending"?pendingTasksList:taskBowlListContainer;const card=listElement.querySelector(`[data-task-id="${taskId}"]`);if(!card)return;const displayDiv=card.querySelector(".task-text-display");const editDiv=card.querySelector(".task-text-edit");const actionsDiv=card.querySelector(".task-actions");displayDiv.classList.remove("hidden");editDiv.classList.add("hidden");actionsDiv.style.display="flex"}async function getHelpForTask(taskId){const task=pendingTasks.find(t=>t.id===taskId);if(!task)return;if(!navigator.onLine){showToast("Offline. Cannot get AI help.","warning");return}const helpButton=pendingTasksList.querySelector(`.task-card[data-task-id="${taskId}"] .btn-help`);if(helpButton){helpButton.textContent="Thinking...";helpButton.disabled=true}try{const context=task.goalId?getGoalContext(task.goalId):null;const mainPrompt=buildTaskHelpPrompt(context,task);const suggestion=await callAIProvider(mainPrompt);if(suggestion){const taskIndex=pendingTasks.findIndex(t=>t.id===taskId);if(taskIndex>-1){pendingTasks[taskIndex].aiHelpText=`<strong>Next Step:</strong> ${suggestion}`;saveToLocalStorage(LS_KEYS.pending,pendingTasks);renderPendingTasks();showToast("AI suggestion added.","success")}}else{throw new Error("AI returned an empty suggestion.")}}catch(error){console.error("getHelpForTask failed:",error);showToast(`AI Help failed: ${error.message}`,"error",4e3)}finally{if(helpButton){helpButton.textContent="Help";helpButton.disabled=false}}}function moveTaskToBowl(taskId){stopAndCleanUpBlitz(taskId);const taskIndex=pendingTasks.findIndex(t=>t.id===taskId);if(taskIndex>-1){const[task]=pendingTasks.splice(taskIndex,1);taskBowl.push(task);taskBowl.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));saveToLocalStorage(LS_KEYS.pending,pendingTasks);saveToLocalStorage(LS_KEYS.bowl,taskBowl);renderPendingTasks();if(document.getElementById("task-bowl-view").classList.contains("active")){renderTaskBowl()}showToast("Task moved to Task Bowl.","info")}else{showToast("Task not found in pending list.","warning")}}function renderGoals(){goalsList.innerHTML="";emptyGoalsMessage.classList.toggle("hidden",goals.length>0);updateAllGoalFilters();const grouped=getGoalsGroupedByStatus();renderGoalGroup(grouped.focused,"focused");renderGoalGroup(grouped.active,"active");renderGoalGroup(grouped.on_hold,"on_hold",true);renderGoalGroup(grouped.completed,"completed",true);renderGoalGroup(grouped.abandoned,"abandoned",true)}function renderGoalGroup(goalsList,status,collapsible=false){if(goalsList.length===0)return;const config=GOAL_STATUS_CONFIG[status];const groupDiv=document.createElement("div");groupDiv.className="goal-status-group";groupDiv.dataset.status=status;const headerDiv=document.createElement("div");headerDiv.className="goal-group-header";headerDiv.innerHTML=`\n                    <h3 style="color: ${config.color}; margin: 0;">\n                        ${config.emoji} ${config.label.replace(/^[^\s]+\s/,"")} (${goalsList.length})\n                    </h3>\n                    ${collapsible?'<button class="btn-icon toggle-group" title="Show/Hide"><span>‚ñº</span></button>':""}\n                `;groupDiv.appendChild(headerDiv);const goalsContainer=document.createElement("div");goalsContainer.className="goals-container";if(collapsible){goalsContainer.classList.add("collapsed")}goalsList.forEach(goal=>{const item=createGoalCard(goal,status);goalsContainer.appendChild(item)});groupDiv.appendChild(goalsContainer);if(collapsible){const toggleBtn=headerDiv.querySelector(".toggle-group");toggleBtn.addEventListener("click",()=>{goalsContainer.classList.toggle("collapsed");toggleBtn.querySelector("span").textContent=goalsContainer.classList.contains("collapsed")?"‚ñ∂":"‚ñº"})}document.getElementById("goals-list").appendChild(groupDiv)}function createGoalCard(goal,status){const item=document.createElement("div");item.className="goal-item";item.dataset.goalId=goal.id;const isFocused=status===GOAL_STATUS.FOCUSED;if(isFocused)item.classList.add("current-focus");const counts=getGoalTaskCounts(goal.id);const taskStats=`üìä ${counts.pending} pending ‚Ä¢ ${counts.bowl} bowl ‚Ä¢ ‚úì ${counts.done} done`;let focusInfo="";if(isFocused&&goal.focusEndDate){focusInfo=`<div style="font-size:0.85em; color: var(--color-text-secondary); margin-top: 4px;">\n                        Focus until: ${formatDate(goal.focusEndDate)}\n                    </div>`}let closedInfo="";if((status===GOAL_STATUS.COMPLETED||status===GOAL_STATUS.ABANDONED)&&goal.closedAt){const verb=status===GOAL_STATUS.COMPLETED?"Completed":"Abandoned";closedInfo=`<div style="font-size:0.85em; color: var(--color-text-secondary); margin-top: 4px;">\n                        ${verb}: ${formatDate(goal.closedAt)}\n                        ${goal.closedReason?`<br><em>"${goal.closedReason}"</em>`:""}\n                    </div>`}item.innerHTML=`\n                    <div class="goal-info">\n                        <span class="goal-text">${goal.text}</span>\n                        <div style="font-size:0.85em; color: var(--color-text-secondary); margin-top: 4px;">\n                            ${taskStats}\n                        </div>\n                        ${focusInfo}\n                        ${closedInfo}\n                    </div>\n                    <div class="goal-actions" id="goal-actions-${goal.id}">\n                        \x3c!-- Actions will be inserted here --\x3e\n                    </div>\n                `;const actionsDiv=item.querySelector(".goal-actions");addGoalActionButtons(actionsDiv,goal,status);return item}function addGoalActionButtons(container,goal,status){const config=GOAL_STATUS_CONFIG[status];config.actions.forEach(action=>{const btn=document.createElement("button");btn.className="btn";switch(action){case"focus":btn.textContent="Set Focus";btn.className="btn btn-primary";btn.addEventListener("click",()=>promptSetGoalFocus(goal.id,false));break;case"unfocus":btn.textContent="End Focus";btn.className="btn btn-secondary";btn.addEventListener("click",()=>endGoalFocus(goal.id));break;case"extend":btn.textContent="Extend";btn.className="btn btn-secondary";btn.addEventListener("click",()=>promptSetGoalFocus(goal.id,true));break;case"pause":btn.textContent="Pause";btn.className="btn btn-secondary";btn.addEventListener("click",()=>pauseGoal(goal.id));break;case"resume":btn.textContent="Resume";btn.className="btn btn-success";btn.addEventListener("click",()=>resumeGoal(goal.id));break;case"complete":btn.textContent="Complete";btn.className="btn btn-success";btn.addEventListener("click",()=>promptCompleteGoal(goal.id));break;case"abandon":btn.textContent="Abandon";btn.className="btn btn-secondary";btn.addEventListener("click",()=>promptAbandonGoal(goal.id));break;case"reactivate":btn.textContent="Reactivate";btn.className="btn btn-primary";btn.addEventListener("click",()=>reactivateGoal(goal.id));break;case"delete":btn.textContent="Delete";btn.className="btn btn-danger";btn.addEventListener("click",()=>confirmDeleteGoal(goal.id));break}container.appendChild(btn)})}function handleAddGoal(){const text=newGoalInput.value.trim();if(!text){showToast("Goal description empty.","warning");return}const newGoal={id:generateId(),text:text,createdAt:getCurrentTimestamp(),status:GOAL_STATUS.ACTIVE,focusStartDate:null,focusEndDate:null,closedAt:null,closedReason:null};goals.push(newGoal);goals.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));saveToLocalStorage(LS_KEYS.goals,goals);renderGoals();showToast("Goal added.","success");newGoalInput.value="";addGoalForm.classList.add("hidden");addNewGoalBtn.classList.remove("hidden")}function confirmDeleteGoal(goalId){const goal=goals.find(g=>g.id===goalId);showModal("Confirm Goal Deletion",`Delete goal: "${goal?.text||"Unknown"}"? Tasks linked will lose association.`,()=>deleteGoal(goalId),"Delete")}function deleteGoal(goalId){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex>-1){goals.splice(goalIndex,1);pendingTasks.forEach(t=>{if(t.goalId===goalId)t.goalId=null});doneTasks.forEach(t=>{if(t.goalId===goalId)t.goalId=null});taskBowl.forEach(t=>{if(t.goalId===goalId)t.goalId=null});if(currentGoal&&currentGoal.id===goalId){currentGoal=null;saveToLocalStorage(LS_KEYS.currentGoal,null);updateCurrentGoalDisplay()}saveToLocalStorage(LS_KEYS.goals,goals);saveToLocalStorage(LS_KEYS.pending,pendingTasks);saveToLocalStorage(LS_KEYS.done,doneTasks);saveToLocalStorage(LS_KEYS.bowl,taskBowl);renderGoals();renderPendingTasks();showToast("Goal deleted.","info")}}function promptSetGoalFocus(goalId,isEditing=false){const goal=goals.find(g=>g.id===goalId);if(!goal)return;const defaultEndDate=new Date;defaultEndDate.setDate(defaultEndDate.getDate()+21);const currentEndDate=isEditing&&goal.endDate?goal.endDate.substring(0,10):defaultEndDate.toISOString().substring(0,10);const modalBodyDiv=document.createElement("div");modalBodyDiv.innerHTML=`<p>Set focus on goal: <strong>${goal.text}</strong></p><label for="goal-end-date">Focus until:</label><input type="date" id="goal-end-date" value="${currentEndDate}" style="width: auto;">`;const dateInput=modalBodyDiv.querySelector("#goal-end-date");showModal(isEditing?"Edit Goal Focus":"Set Goal Focus",modalBodyDiv,()=>{const selectedDate=dateInput.value;if(!selectedDate){showToast("Select end date.","warning");promptSetGoalFocus(goalId,isEditing);return}const endDateISO=new Date(selectedDate+"T00:00:00Z").toISOString();setGoalFocus(goalId,endDateISO)},isEditing?"Update Focus":"Set Focus")}function setGoalFocus(goalId,endDate){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex===-1)return;goals[goalIndex].status=GOAL_STATUS.FOCUSED;goals[goalIndex].focusStartDate=getCurrentTimestamp();goals[goalIndex].focusEndDate=endDate;saveToLocalStorage(LS_KEYS.goals,goals);currentGoal={id:goals[goalIndex].id,text:goals[goalIndex].text,focusEndDate:endDate};saveToLocalStorage(LS_KEYS.currentGoal,currentGoal);updateCurrentGoalDisplay();renderGoals();renderPendingTasks();showToast(`Focus set on goal: ${goals[goalIndex].text}`,"success")}function endGoalFocus(goalId){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex===-1)return;goals[goalIndex].status=GOAL_STATUS.ACTIVE;goals[goalIndex].focusStartDate=null;goals[goalIndex].focusEndDate=null;saveToLocalStorage(LS_KEYS.goals,goals);currentGoal=null;saveToLocalStorage(LS_KEYS.currentGoal,null);updateCurrentGoalDisplay();renderGoals();renderPendingTasks();showToast("Goal focus ended. Goal is now active.","info")}function pauseGoal(goalId){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex===-1)return;const wasFocused=goals[goalIndex].status===GOAL_STATUS.FOCUSED;goals[goalIndex].status=GOAL_STATUS.ON_HOLD;if(wasFocused){goals[goalIndex].focusStartDate=null;goals[goalIndex].focusEndDate=null;if(currentGoal&&currentGoal.id===goalId){currentGoal=null;saveToLocalStorage(LS_KEYS.currentGoal,null);updateCurrentGoalDisplay()}}saveToLocalStorage(LS_KEYS.goals,goals);renderGoals();renderPendingTasks();showToast("Goal paused.","info")}function resumeGoal(goalId){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex===-1)return;goals[goalIndex].status=GOAL_STATUS.ACTIVE;saveToLocalStorage(LS_KEYS.goals,goals);renderGoals();showToast("Goal resumed and is now active.","success")}function promptCompleteGoal(goalId){const goal=goals.find(g=>g.id===goalId);if(!goal)return;const counts=getGoalTaskCounts(goalId);const remainingTasks=counts.pending+counts.bowl;const modalBodyDiv=document.createElement("div");if(remainingTasks>0){modalBodyDiv.innerHTML=`\n                        <p><strong>Mark goal as complete:</strong> "${goal.text}"</p>\n                        <p style="color: var(--color-warning); margin-top: 15px;">\n                            ‚ö†Ô∏è This goal has <strong>${remainingTasks} remaining task${remainingTasks>1?"s":""}</strong>\n                            (${counts.pending} pending, ${counts.bowl} in bowl).\n                        </p>\n                        <p>These tasks will be <strong>unlinked from this goal</strong> and will have no goal association.</p>\n                        <label for="complete-reason" style="margin-top: 15px; display: block;">\n                            Completion note (optional):\n                        </label>\n                        <textarea id="complete-reason" rows="2" placeholder="e.g., Launched successfully, All milestones achieved"></textarea>\n                    `}else{modalBodyDiv.innerHTML=`\n                        <p><strong>Mark goal as complete:</strong> "${goal.text}"</p>\n                        <p style="color: var(--color-success); margin-top: 10px;">\n                            ‚úÖ All tasks for this goal are complete!\n                        </p>\n                        <label for="complete-reason" style="margin-top: 15px; display: block;">\n                            Completion note (optional):\n                        </label>\n                        <textarea id="complete-reason" rows="2" placeholder="e.g., Launched successfully"></textarea>\n                    `}const reasonInput=modalBodyDiv.querySelector("#complete-reason");showModal("Complete Goal",modalBodyDiv,()=>{const reason=reasonInput.value.trim();completeGoal(goalId,reason||null)},"Mark Complete");setTimeout(()=>reasonInput.focus(),50)}function completeGoal(goalId,reason){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex===-1)return;const unlinkedCount=unlinkTasksFromGoal(goalId);goals[goalIndex].status=GOAL_STATUS.COMPLETED;goals[goalIndex].closedAt=getCurrentTimestamp();goals[goalIndex].closedReason=reason;goals[goalIndex].focusStartDate=null;goals[goalIndex].focusEndDate=null;if(currentGoal&&currentGoal.id===goalId){currentGoal=null;saveToLocalStorage(LS_KEYS.currentGoal,null);updateCurrentGoalDisplay()}saveToLocalStorage(LS_KEYS.goals,goals);renderGoals();renderPendingTasks();const message=unlinkedCount>0?`Goal completed! ${unlinkedCount} task${unlinkedCount>1?"s":""} unlinked.`:"Goal completed!";showToast(message,"success",4e3)}function promptAbandonGoal(goalId){const goal=goals.find(g=>g.id===goalId);if(!goal)return;const counts=getGoalTaskCounts(goalId);const remainingTasks=counts.pending+counts.bowl;const modalBodyDiv=document.createElement("div");modalBodyDiv.innerHTML=`\n                    <p><strong>Abandon goal:</strong> "${goal.text}"</p>\n                    ${remainingTasks>0?`\n                        <p style="color: var(--color-warning); margin-top: 15px;">\n                            ‚ö†Ô∏è This goal has <strong>${remainingTasks} remaining task${remainingTasks>1?"s":""}</strong>.\n                            They will be unlinked.\n                        </p>\n                    `:""}\n                    <label for="abandon-reason" style="margin-top: 15px; display: block;">\n                        Reason (optional):\n                    </label>\n                    <textarea id="abandon-reason" rows="2" placeholder="e.g., Priorities changed, No longer relevant"></textarea>\n                `;const reasonInput=modalBodyDiv.querySelector("#abandon-reason");showModal("Abandon Goal",modalBodyDiv,()=>{const reason=reasonInput.value.trim();abandonGoal(goalId,reason||null)},"Abandon");setTimeout(()=>reasonInput.focus(),50)}function abandonGoal(goalId,reason){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex===-1)return;const unlinkedCount=unlinkTasksFromGoal(goalId);goals[goalIndex].status=GOAL_STATUS.ABANDONED;goals[goalIndex].closedAt=getCurrentTimestamp();goals[goalIndex].closedReason=reason;goals[goalIndex].focusStartDate=null;goals[goalIndex].focusEndDate=null;if(currentGoal&&currentGoal.id===goalId){currentGoal=null;saveToLocalStorage(LS_KEYS.currentGoal,null);updateCurrentGoalDisplay()}saveToLocalStorage(LS_KEYS.goals,goals);renderGoals();renderPendingTasks();const message=unlinkedCount>0?`Goal abandoned. ${unlinkedCount} task${unlinkedCount>1?"s":""} unlinked.`:"Goal abandoned.";showToast(message,"info")}function reactivateGoal(goalId){const goalIndex=goals.findIndex(g=>g.id===goalId);if(goalIndex===-1)return;goals[goalIndex].status=GOAL_STATUS.ACTIVE;goals[goalIndex].closedAt=null;goals[goalIndex].closedReason=null;saveToLocalStorage(LS_KEYS.goals,goals);renderGoals();showToast("Goal reactivated!","success")}function renderDoneList(){const filterValue=doneTimeFilter.value;const goalFilterValue=doneGoalFilter.value;let filteredList=[...doneTasks];const now=Date.now();if(filterValue==="7")filteredList=filteredList.filter(task=>new Date(task.doneAt).getTime()>=now-7*24*60*60*1e3);else if(filterValue==="30")filteredList=filteredList.filter(task=>new Date(task.doneAt).getTime()>=now-30*24*60*60*1e3);if(goalFilterValue!=="all"){if(goalFilterValue==="none")filteredList=filteredList.filter(task=>!task.goalId);else filteredList=filteredList.filter(task=>task.goalId===goalFilterValue)}doneListContainer.innerHTML="";emptyDoneMessage.classList.toggle("hidden",filteredList.length>0);filteredList.forEach(task=>{const item=document.createElement("div");item.className="list-item";let goalText="[Add Goal]";if(task.goalId){const linkedGoal=goals.find(g=>g.id===task.goalId);if(linkedGoal)goalText=truncate(linkedGoal.text,40)}const goalHTML=`<div style="font-size:0.8em; color: var(--color-text-secondary);"><em>Goal: <a href="#" class="edit-task-goal-link" data-task-id="${task.id}" data-list-name="done">${goalText}</a></em></div>`;item.innerHTML=` <div class="item-details"> <div class="task-text">${task.text}</div> ${goalHTML} <div class="action-text">Action: ${task.actionTaken}</div> <div class="timestamp">Done: ${formatDate(task.doneAt)}</div> </div>`;doneListContainer.appendChild(item)})}function updateAllGoalFilters(){const doneSelect=document.getElementById("done-goal-filter");if(doneSelect){const currentVal=doneSelect.value;doneSelect.innerHTML=`<option value="all">All Goals</option><option value="none">No Goal</option>`;doneSelect.innerHTML+=generateGoalOptionsHTML(true,currentVal);if(doneSelect.querySelector(`option[value="${currentVal}"]`))doneSelect.value=currentVal}const bowlSelect=document.getElementById("bowl-goal-filter");if(bowlSelect){const currentVal=bowlSelect.value;bowlSelect.innerHTML=`<option value="all">All Goals</option><option value="none">No Goal</option>`;bowlSelect.innerHTML+=generateGoalOptionsHTML(true,currentVal);if(bowlSelect.querySelector(`option[value="${currentVal}"]`))bowlSelect.value=currentVal}}function renderTaskBowl(applyDefault=false){const bowlGoalFilter=document.getElementById("bowl-goal-filter");if(!bowlGoalFilter)return;if(applyDefault&&currentGoal){if(bowlGoalFilter.querySelector(`option[value="${currentGoal.id}"]`)){bowlGoalFilter.value=currentGoal.id}}const goalFilterValue=bowlGoalFilter.value;let filteredList=[...taskBowl];if(goalFilterValue!=="all"){if(goalFilterValue==="none"){filteredList=filteredList.filter(task=>!task.goalId)}else{filteredList=filteredList.filter(task=>task.goalId===goalFilterValue)}}taskBowlListContainer.innerHTML="";emptyTaskBowlMessage.classList.toggle("hidden",filteredList.length>0);filteredList.forEach(task=>{const item=document.createElement("div");item.className="list-item";item.dataset.taskId=task.id;let goalText="[Add Goal]";if(task.goalId){const linkedGoal=goals.find(g=>g.id===task.goalId);if(linkedGoal)goalText=truncate(linkedGoal.text,40)}const goalHTML=`<div style="font-size:0.8em; color: var(--color-text-secondary);"><em>Goal: <a href="#" class="edit-task-goal-link" data-task-id="${task.id}" data-list-name="bowl">${goalText}</a></em></div>`;const helpHTML=task.aiHelpText?`<div class="task-help-suggestion" style="margin-top: 5px; font-size: 0.85em; padding: 5px;">${task.aiHelpText}</div>`:"";item.innerHTML=`\n                        <div class="item-details">\n                            <div class="task-text-display">\n                                <div class="task-text">${task.text}</div>\n                            </div>\n                            <div class="task-text-edit hidden">\n                                <textarea class="task-edit-input" rows="2">${task.text}</textarea>\n                                <div style="margin-top: 8px;">\n                                    <button class="btn-save-edit btn-success btn-sm">Save</button>\n                                    <button class="btn-cancel-edit btn-secondary btn-sm">Cancel</button>\n                                </div>\n                            </div>\n                            ${goalHTML}\n                            ${helpHTML}\n                            <div class="timestamp">Added: ${formatDate(task.createdAt)}</div>\n                        </div>\n                        <div class="item-actions">\n                            <button class="btn-edit btn-secondary">üìù</button>\n                            <button class="btn-add-to-today">Add to Today</button>\n                            <button class="btn-bowl-done btn-success">Done</button>\n                            <button class="btn-bowl-delete btn-danger">Delete</button>\n                        </div>\n                    `;item.querySelector(".btn-add-to-today").addEventListener("click",()=>moveTaskToToday(task.id));item.querySelector(".btn-bowl-done").addEventListener("click",()=>promptMarkDone(task.id,"bowl"));item.querySelector(".btn-bowl-delete").addEventListener("click",()=>confirmDeleteTask(task.id,"bowl"));item.querySelector(".btn-edit").addEventListener("click",()=>startEditingTask(task.id,"bowl"));item.querySelector(".btn-save-edit").addEventListener("click",()=>saveTaskEdit(task.id,"bowl"));item.querySelector(".btn-cancel-edit").addEventListener("click",()=>cancelTaskEdit(task.id,"bowl"));taskBowlListContainer.appendChild(item)});updateGuideButtonVisibility()}function moveTaskToToday(taskId){if(pendingTasks.length>=MAX_PENDING_TASKS){showToast(`Cannot add: Pending list full (${MAX_PENDING_TASKS} max).`,"warning");return}const taskIndex=taskBowl.findIndex(t=>t.id===taskId);if(taskIndex>-1){const[task]=taskBowl.splice(taskIndex,1);pendingTasks.push(task);saveToLocalStorage(LS_KEYS.bowl,taskBowl);saveToLocalStorage(LS_KEYS.pending,pendingTasks);renderTaskBowl();renderPendingTasks();showToast("Task moved to Pending Today.","success")}}function promptEditTaskGoal(taskId,listName){let task,list;switch(listName){case"pending":list=pendingTasks;break;case"bowl":list=taskBowl;break;case"done":list=doneTasks;break;default:showToast("Error: Unknown list.","error");return}task=list.find(t=>t.id===taskId);if(!task){showToast("Error: Task not found.","error");return}const modalBodyDiv=document.createElement("div");let optionsHTML='<option value="none">-- No Goal --</option>';const currentGoalIsArchived=task.goalId&&goals.find(g=>g.id===task.goalId&&(g.status==="completed"||g.status==="abandoned"));optionsHTML+=generateGoalOptionsHTML(!currentGoalIsArchived,task.goalId);modalBodyDiv.innerHTML=`\n                    <p>Editing goal for: <strong>${truncate(task.text,100)}</strong></p>\n                    <label for="goal-select-modal">Select Goal:</label>\n                    <select id="goal-select-modal">${optionsHTML}</select>`;const saveCallback=()=>{const select=modalBodyDiv.querySelector("#goal-select-modal");const newGoalId=select.value==="none"?null:select.value;task.goalId=newGoalId;saveToLocalStorage(LS_KEYS[listName],list);showToast("Goal updated!","success");switch(listName){case"pending":renderPendingTasks();break;case"bowl":renderTaskBowl(false);break;case"done":renderDoneList();break}};showModal("Edit Task Goal",modalBodyDiv,saveCallback,"Save Goal")}function startFlowMode(routineId){const routine=routines.find(r=>r.id===routineId);if(!routine)return;activeFlowTasks=routine.tasks.map(t=>({text:t,completed:false}));renderFlowMode(routine.name);document.getElementById("flow-mode-overlay").classList.add("active")}function renderFlowMode(routineName){if(routineName)document.getElementById("flow-routine-name").textContent=routineName;const container=document.getElementById("flow-tasks-container");container.innerHTML="";activeFlowTasks.forEach((task,index)=>{const item=document.createElement("div");item.className=`flow-task-item ${task.completed?"completed":""}`;item.onclick=()=>toggleFlowTask(index);item.innerHTML=`\n                        <div class="flow-checkbox"></div>\n                        <div class="flow-text">${task.text}</div>\n                    `;container.appendChild(item)})}function toggleFlowTask(index){activeFlowTasks[index].completed=!activeFlowTasks[index].completed;renderFlowMode();if(activeFlowTasks.every(t=>t.completed)){const finishBtn=document.getElementById("flow-finish-btn");finishBtn.textContent="üéâ All Done! Close";finishBtn.classList.add("pulse")}}function closeFlowMode(allDone=false){document.getElementById("flow-mode-overlay").classList.remove("active");activeFlowTasks=[];document.getElementById("flow-finish-btn").textContent="Mark All Done";if(allDone){showToast("Flow complete! Momentum built. üöÄ","success")}else{showToast("Flow skipped. Welcome to your day.","info")}}function renderRoutines(){routinesList.innerHTML="";emptyRoutinesMessage.classList.toggle("hidden",routines.length>0);routines.forEach(routine=>{const item=document.createElement("div");item.className="routine-item";item.dataset.routineId=routine.id;const taskCount=routine.tasks.length;item.innerHTML=` <div class="routine-info"> <span class="routine-name">${routine.name}</span> <div class="routine-task-count">${taskCount} task${taskCount!==1?"s":""}</div> </div> <div class="routine-actions"> <button class="btn-load-routine btn-success">Load</button> <button class="btn-edit-routine">Edit</button> <button class="btn-delete-routine btn-danger">Delete</button> </div>`;item.querySelector(".btn-load-routine").addEventListener("click",()=>loadRoutine(routine.id));item.querySelector(".btn-edit-routine").addEventListener("click",()=>showEditRoutineForm(routine.id));item.querySelector(".btn-delete-routine").addEventListener("click",()=>confirmDeleteRoutine(routine.id));routinesList.appendChild(item)})}function handleAddOrUpdateRoutine(){const name=newRoutineNameInput.value.trim();const tasksText=newRoutineTasksInput.value.trim();const editingId=editRoutineIdInput.value;if(!name||!tasksText){showToast("Routine name and tasks cannot be empty.","warning");return}const tasks=tasksText.split("\n").map(t=>t.trim()).filter(t=>t);if(tasks.length===0){showToast("Please enter at least one task.","warning");return}if(editingId){const routineIndex=routines.findIndex(r=>r.id===editingId);if(routineIndex>-1){routines[routineIndex].name=name;routines[routineIndex].tasks=tasks;showToast("Routine updated.","success")}}else{const newRoutine={id:generateId(),name:name,tasks:tasks};routines.push(newRoutine);showToast("Routine added.","success")}saveToLocalStorage(LS_KEYS.routines,routines);renderRoutines();addRoutineForm.classList.add("hidden");addNewRoutineBtn.classList.remove("hidden")}function showEditRoutineForm(routineId){const routine=routines.find(r=>r.id===routineId);if(!routine)return;editRoutineIdInput.value=routine.id;newRoutineNameInput.value=routine.name;newRoutineTasksInput.value=routine.tasks.join("\n");addRoutineForm.classList.remove("hidden");addNewRoutineBtn.classList.add("hidden");newRoutineNameInput.focus()}function confirmDeleteRoutine(routineId){const routineName=routines.find(r=>r.id===routineId)?.name;showModal("Confirm Deletion",`Delete the routine "${routineName||"Unknown"}"?`,()=>deleteRoutine(routineId),"Delete")}function deleteRoutine(routineId){routines=routines.filter(r=>r.id!==routineId);saveToLocalStorage(LS_KEYS.routines,routines);renderRoutines();showToast("Routine deleted.","info")}function loadRoutine(routineId){startFlowMode(routineId)}async function callGemini(prompt,apiKey,model="gemini-2.5-flash-latest"){const endpoint=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;const body={contents:[{parts:[{text:prompt}]}]};const response=await fetch(endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(!response.ok)throw new Error(`Gemini API Error: ${response.status}`);const result=await response.json();return result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim()}async function callOpenAI(prompt,apiKey,endpoint,model){const body={model:model,messages:[{role:"user",content:prompt}]};const headers={"Content-Type":"application/json",Authorization:`Bearer ${apiKey}`};const response=await fetch(endpoint,{method:"POST",headers:headers,body:JSON.stringify(body)});if(!response.ok)throw new Error(`OpenAI/DeepSeek API Error: ${response.status}`);const result=await response.json();return result?.choices?.[0]?.message?.content?.trim()}async function callClaude(prompt,apiKey,model="claude-haiku-4-5"){const endpoint="https://api.anthropic.com/v1/messages";const headers={"x-api-key":apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json","anthropic-dangerous-direct-browser-access":"true"};const body={model:model,max_tokens:16384,messages:[{role:"user",content:prompt}]};try{const response=await fetch(endpoint,{method:"POST",headers:headers,body:JSON.stringify(body)});if(!response.ok){const errorText=await response.text();console.error("API Error:",response.status,errorText);throw new Error(`Claude API Error: ${response.status} - ${errorText}`)}const result=await response.json();return result?.content?.[0]?.text?.trim()}catch(error){console.error("Network error:",error);throw error}}async function callAIProvider(prompt){const aiSettings=loadFromLocalStorage(LS_KEYS.aiSettings,{activeProvider:"gemini",keys:{},selectedModels:DEFAULT_MODELS});const provider=aiSettings.activeProvider;const apiKey=aiSettings.keys[provider];const model=aiSettings.selectedModels?.[provider]||DEFAULT_MODELS[provider];if(!apiKey){promptForApiKey(provider);throw new Error(`API Key for ${provider} is missing.`)}switch(provider){case"gemini":return await callGemini(prompt,apiKey,model);case"openai":return await callOpenAI(prompt,apiKey,"https://api.openai.com/v1/chat/completions",model);case"deepseek":return await callOpenAI(prompt,apiKey,"https://api.deepseek.com/chat/completions",model);case"claude":return await callClaude(prompt,apiKey,model);default:throw new Error(`Unknown AI provider: ${provider}`)}}function getGoalContext(goalId){const goal=goals.find(g=>g.id===goalId);if(!goal)return null;return{goal:goal,done:doneTasks.filter(t=>t.goalId===goalId),pending:pendingTasks.filter(t=>t.goalId===goalId),bowl:taskBowl.filter(t=>t.goalId===goalId)}}function buildTaskHelpPrompt(context,task){if(!context){return`You're helping me break down this task into a concrete next step.\n                ${PROMPT_FRAGMENTS.taskPreferences}\n                Task: "${task.text}"\n                This task isn't linked to a goal, so I need a standalone next step.\n                Evaluate:\n                1. Is this task too broad? (Target: completable in 1-2 hours)\n                2. What's the absolute first physical action?\n                Provide ONLY the next step. One sentence. Concrete and actionable.`}const goalStatus=context.goal.status?` (${context.goal.status})`:"";const doneList=context.done.length>0?context.done.map(t=>`- "${t.text}" (Action: ${t.actionTaken})`).join("\n"):"(None)";const pendingList=context.pending.filter(t=>t.id!==task.id).length>0?context.pending.filter(t=>t.id!==task.id).map(t=>`- "${t.text}"`).join("\n"):"(None)";const bowlList=context.bowl.length>0?context.bowl.map(t=>`- "${t.text}"`).join("\n"):"(None)";return`You're helping me break down this task into a concrete next step.\n                ${PROMPT_FRAGMENTS.taskPreferences}\n                ${PROMPT_FRAGMENTS.goalStatusContext}\n                ## Goal Context\n                "${context.goal.text}"${goalStatus}\n                ### Completed for this goal:\n                ${doneList}\n                ### Other pending for this goal:\n                ${pendingList}\n                ### Backlog for this goal:\n                ${bowlList}\n                ## Task I Need Help With:\n                "${task.text}"\n                ## What I Need\n                Given the full context of this goal and where I am:\n                - What is the absolute next single physical action? (30 min max)\n                - Why is THIS the right next step based on what I've already done?\n                Provide ONLY the suggested next step. One sentence. Concrete and actionable.\n                Don't explain your reasoning unless it's non-obvious.`}function buildGoalGuidePrompt(context){const goalStatus=context.goal.status||"active";const statusWarning=goalStatus==="on_hold"?"\n‚ö†Ô∏è NOTE: This goal is currently ON HOLD. Consider if now is the right time to add tasks.\n":"";const doneList=context.done.length>0?context.done.map(t=>`- "${t.text}"`).join("\n"):"(None)";const currentPlanTasks=[...context.pending,...context.bowl];const currentPlanList=currentPlanTasks.length>0?currentPlanTasks.map(t=>`- "${t.text}"`).join("\n"):"(None)";const request=currentPlanTasks.length===0?"The plan is empty. Suggest 5-7 concrete next steps to get started.":"Review the current plan. Suggest 2-3 tasks to add that would fill gaps or maintain momentum.";return`You're helping me break down a goal into actionable tasks.\n            ${PROMPT_FRAGMENTS.taskPreferences}\n            ${PROMPT_FRAGMENTS.goalStatusContext}\n            ## Goal:\n            "${context.goal.text}" (${goalStatus})${statusWarning}\n            ### Progress So Far:\n            ${doneList}\n            ### Current Plan:\n            ${currentPlanList}\n            ## What I Need\n            ${request}\n            Each task should:\n            - Take 30-90 minutes max\n            - Be a concrete action, not a project\n            - Build on completed work when relevant\n            - Create early wins and momentum\n            Output as a simple list with one task per line:\n            - First task\n            - Second task\n            - Third task\n            No numbering, no explanations, just the task descriptions.`}function buildBlockedAIPrompt(userInput,context){const blockedTips=loadFromLocalStorage(LS_KEYS.blockedTips,[]);return`You're helping me get unstuck with a productivity challenge.\n            ${PROMPT_FRAGMENTS.userStyle}\n            ${PROMPT_FRAGMENTS.taskPreferences}\n            ## My Productivity Framework\n            I have a curated set of strategies that work for me:\n            ${JSON.stringify(blockedTips,null,2)}\n            ## My Current Situation\n            ${userInput||"I'm feeling blocked but haven't specified details"}\n            ## Relevant Context\n            Goals: ${context.allGoals?.map(g=>`"${g.text}" (${g.status})`).join(", ")||"None"}\n            Pending: ${context.pendingTasks?.length||0} tasks\n            Bowl: ${context.taskBowl?.length||0} tasks\n            Recent completions: ${context.recentDone?.length||0} in last 7 days\n            ## What I Need\n            Based on my situation and my own framework:\n            1. Which of my existing strategies are most relevant? (Reference specific tips)\n            2. What's ONE concrete action I can take in the next 30 minutes?\n            3. Be honest: Am I overthinking this?\n            Keep it short. 3-4 sentences max.`}function buildStressedAIPrompt(userInput,context){const stressedTips=loadFromLocalStorage(LS_KEYS.stressedTips,{});return`You're helping me process and respond to stress.\n            ${PROMPT_FRAGMENTS.userStyle}\n            ## My Stress Management Framework\n            I have strategies for different stress types:\n            ${JSON.stringify(stressedTips,null,2)}\n            ## How I'm Feeling\n            ${userInput||"I'm feeling stressed but haven't specified details"}\n            ## Current Load\n            Goals: ${context.allGoals?.map(g=>`"${g.text}" (${g.status})`).join(", ")||"None"}\n            Pending: ${context.pendingTasks?.length||0} tasks\n            Bowl: ${context.taskBowl?.length||0} tasks\n            ## What I Need\n            1. Based on how I'm feeling, which stress category seems most relevant?\n            2. What's ONE thing I can do right now to reduce this specific stress?\n            3. Honest check: Is this situation-stress or system-stress? (External vs how I'm working)\n            Keep it brief and direct.`}function buildMentalStatePrompt(blockedInput,stressedInput,context){return`You're helping me understand what's really going on when I'm stuck.\n            ${PROMPT_FRAGMENTS.userStyle}\n            ## What I'm Experiencing\n            Productivity challenges: ${blockedInput||"Not specified"}\n            Emotional state: ${stressedInput||"Not specified"}\n            ## My Context\n            Goals: ${context.allGoals?.map(g=>`"${g.text}" (${g.status})`).join(", ")}\n            Current workload: ${context.pendingTasks?.length} pending, ${context.taskBowl?.length} backlog\n            Recent momentum: ${context.recentDone?.length||0} completed in last 7 days\n            ## What I Need\n            Connect the dots:\n            1. What's the relationship between how I'm feeling and my work situation?\n            2. Is this a task problem or a system problem?\n            3. What's the ONE root issue to address first?\n            Be direct. If I'm overthinking it, say so.`}function updateGuideButtonVisibility(){const bowlGoalFilter=document.getElementById("bowl-goal-filter");if(!bowlGoalFilter||!goalGuideBtn)return;const selectedGoal=bowlGoalFilter.value;const isSpecificGoal=selectedGoal!=="all"&&selectedGoal!=="none";goalGuideBtn.classList.toggle("hidden",!isSpecificGoal)}async function startGoalGuide(){const goalId=document.getElementById("bowl-goal-filter").value;if(!goalId||goalId==="all"||goalId==="none")return;if(!navigator.onLine){showToast("Offline. Cannot get AI help.","warning");return}goalGuideBtn.textContent="Thinking...";goalGuideBtn.disabled=true;try{const context=getGoalContext(goalId);if(!context)throw new Error("Could not find goal context.");const prompt=buildGoalGuidePrompt(context);const suggestionText=await callAIProvider(prompt);if(suggestionText){const suggestions=suggestionText.split("\n").map(s=>s.replace(/^- /,"").trim()).filter(s=>s);showGoalGuideModal(suggestions,goalId)}else{throw new Error("AI returned no suggestions.")}}catch(error){console.error("Goal Guide failed:",error);showToast(`Goal Guide failed: ${error.message}`,"error",4e3)}finally{goalGuideBtn.textContent="Guide Me";goalGuideBtn.disabled=false}}function showGoalGuideModal(suggestions,goalId){const modalBodyDiv=document.createElement("div");const suggestionsHTML=suggestions.map((s,index)=>`\n                    <li>\n                        <label for="suggestion-${index}">\n                            <input type="checkbox" id="suggestion-${index}" value="${s}" checked>\n                            <span>${s}</span>\n                        </label>\n                    </li>\n                `).join("");modalBodyDiv.innerHTML=`\n                    <p>Here are some suggested next steps. Select which ones you'd like to add to your Task Bowl.</p>\n                    <ul class="ai-suggestion-list">${suggestionsHTML}</ul>\n                `;const updateConfirmButtonText=()=>{const checkedCount=modalBodyDiv.querySelectorAll('input[type="checkbox"]:checked').length;const confirmBtn=document.getElementById("modal-confirm-btn");if(confirmBtn){confirmBtn.textContent=`Add ${checkedCount} Selected to Bowl`;confirmBtn.disabled=checkedCount===0}};modalBodyDiv.addEventListener("change",updateConfirmButtonText);const confirmCallback=()=>{const checkboxes=modalBodyDiv.querySelectorAll('input[type="checkbox"]:checked');if(checkboxes.length>0){let tasksAddedCount=0;checkboxes.forEach(cb=>{const newTask={id:generateId(),text:cb.value,createdAt:getCurrentTimestamp(),goalId:goalId,aiHelpText:null};taskBowl.unshift(newTask);tasksAddedCount++});saveToLocalStorage(LS_KEYS.bowl,taskBowl);renderTaskBowl();showToast(`${tasksAddedCount} task${tasksAddedCount>1?"s":""} added to Bowl.`,"success")}};showModal("AI-Suggested Tasks",modalBodyDiv,confirmCallback,`Add ${suggestions.length} Selected to Bowl`);updateConfirmButtonText()}async function handleProcessBrainDump(){if(!navigator.onLine){showToast("Offline. Cannot process brain dump.","warning");return}const rawText=loadFromLocalStorage(LS_KEYS.references,"");let textToProcess=rawText;const delimiterIndex=rawText.indexOf(BRAINDUMP_DELIMITER);if(delimiterIndex!==-1){textToProcess=rawText.substring(delimiterIndex+BRAINDUMP_DELIMITER.length).trim()}if(!textToProcess||textToProcess.length<5){showToast("Brain dump is empty or too short to process.","warning");return}processBrainDumpBtn.textContent="Processing...";processBrainDumpBtn.disabled=true;try{const goalListForPrompt=goals.map(g=>({id:g.id,text:g.text}));const prompt=`You are a productivity assistant. Your job is to parse unstructured thoughts into actionable tasks.\nCONTEXT:\n1. User's Brain Dump:\n"""\n${textToProcess}\n"""\n2. User's Active Goals: ${JSON.stringify(goalListForPrompt)}\nINSTRUCTIONS:\n1. Analyze the Brain Dump and break it down into atomic tasks.\n2. CONSTRAINT: No task should take longer than 1 hour. If a task implies a larger effort, break it down into the first small step.\n3. Match each task to the "Best Fit" goal from the provided list based on ID. If no goal fits clearly, assign "goal_id": null.\n4. Generate a brief (1-2 sentences) commentary identifying risks, concerns, or encouragement based on the new tasks vs. workload.\nOUTPUT FORMAT (JSON ONLY - No Markdown, No Explanation):\n{\n  "commentary": "Your observation here...",\n  "tasks": [\n    {\n      "task_name": "Task title",\n      "goal_id": "Matched Goal ID or null",\n      "duration": "estimated time (e.g. 30m, 45m)"\n    }\n  ]\n}`;const jsonResponse=await callAIProvider(prompt);const cleanJson=jsonResponse.replace(/```json/g,"").replace(/```/g,"").trim();const data=JSON.parse(cleanJson);showBrainDumpResultsModal(data,rawText)}catch(error){console.error("Brain Dump Processing Error:",error);showToast(`Processing failed: ${error.message}`,"error",4e3)}finally{processBrainDumpBtn.textContent="‚ö° Process";processBrainDumpBtn.disabled=false}}function showBrainDumpResultsModal(data,originalFullText){const modalBodyDiv=document.createElement("div");let goalOptions='<option value="">-- No Goal --</option>';goalOptions+=generateGoalOptionsHTML(false);const tasksHtml=data.tasks.map((t,index)=>{const selectedGoal=t.goal_id&&goals.find(g=>g.id===t.goal_id)?t.goal_id:"";const specificOptions=goalOptions.replace(`value="${selectedGoal}"`,`value="${selectedGoal}" selected`);return`\n                    <div class="bd-task-item">\n                        <div class="bd-task-row">\n                            <label style="display:flex; align-items:center; flex-grow:1; cursor:pointer;">\n                                <input type="checkbox" class="bd-task-checkbox" data-index="${index}" checked style="width:auto; margin-right:10px;">\n                                <strong>${t.task_name}</strong>\n                                <span style="font-size:0.8em; color:var(--color-text-secondary); margin-left:8px;">(${t.duration})</span>\n                            </label>\n                        </div>\n                        <div class="bd-task-meta">\n                            <select class="bd-task-goal-select" data-index="${index}">${specificOptions}</select>\n                        </div>\n                    </div>`}).join("");modalBodyDiv.innerHTML=`\n                    <div class="brain-dump-commentary">AI: "${data.commentary}"</div>\n                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--color-border); padding: 10px; border-radius: 8px;">\n                        ${tasksHtml}\n                    </div>\n                `;const confirmCallback=()=>{const checkboxes=modalBodyDiv.querySelectorAll(".bd-task-checkbox:checked");if(checkboxes.length===0)return;const tasksToAdd=[];checkboxes.forEach(cb=>{const index=cb.dataset.index;const originalTask=data.tasks[index];const selectedGoalId=modalBodyDiv.querySelector(`.bd-task-goal-select[data-index="${index}"]`).value;tasksToAdd.push({text:originalTask.task_name,goalId:selectedGoalId||null,duration:originalTask.duration})});finalizeBrainDumpProcess(tasksToAdd,originalFullText)};showModal("Brain Dump Analysis",modalBodyDiv,confirmCallback,"Add to Bowl")}function finalizeBrainDumpProcess(newTasks,originalFullText){newTasks.forEach(t=>{taskBowl.unshift({id:generateId(),text:`${t.text} (${t.duration})`,createdAt:getCurrentTimestamp(),goalId:t.goalId,aiHelpText:null})});saveToLocalStorage(LS_KEYS.bowl,taskBowl);if(document.getElementById("task-bowl-view").classList.contains("active")){renderTaskBowl()}const taskLog=newTasks.map(t=>{const goalName=t.goalId?goals.find(g=>g.id===t.goalId)?.text:"No Goal";return`- ${t.text} [${goalName}]`}).join("\n");const historyBlock=`\n\n${BRAINDUMP_HISTORY_HEADER}\n${taskLog}\n\n${BRAINDUMP_DELIMITER}\n`;let newContent;const delimiterIndex=originalFullText.indexOf(BRAINDUMP_DELIMITER);if(delimiterIndex!==-1){newContent=originalFullText.trim()+historyBlock}else{newContent=originalFullText.trim()+historyBlock}saveToLocalStorage(LS_KEYS.references,newContent);if(document.getElementById("references-view").classList.contains("active")){setupEditableContentView(referencesView,LS_KEYS.references)}showToast(`${newTasks.length} tasks added to Bowl & Brain Dump updated.`,"success")}async function runAIAssist(){if(!navigator.onLine){showToast("Offline. Cannot get AI assist.","warning");return}const assistBtn=document.getElementById("ai-assist-btn");assistBtn.textContent="Thinking...";assistBtn.disabled=true;try{const context=buildFullContext();const prompt=buildAssistPrompt(context);const response=await callAIProvider(prompt);if(response){showAssistResults(response)}else{throw new Error("AI returned no suggestions.")}}catch(error){console.error("AI Assist failed:",error);showToast(`AI Assist failed: ${error.message}`,"error",4e3)}finally{assistBtn.textContent="üéØ What should I focus on?";assistBtn.disabled=false}}function getFullAppContextForAI(){const weekAgo=Date.now()-7*24*60*60*1e3;const recentDone=doneTasks.filter(t=>new Date(t.doneAt).getTime()>=weekAgo);return{timestamp:getCurrentTimestamp(),currentGoal:currentGoal,allGoals:goals.map(g=>({text:g.text,focusEndDate:g.endDate})),pendingTasks:pendingTasks.map(t=>({text:t.text,goalId:t.goalId})),taskBowl:taskBowl.map(t=>({text:t.text,goalId:t.goalId,createdAt:t.createdAt})),doneTasks:doneTasks.map(t=>({text:t.text,goalId:t.goalId,actionTaken:t.actionTaken,doneAt:t.doneAt})),reminders:loadFromLocalStorage(LS_KEYS.reminders,""),references:loadFromLocalStorage(LS_KEYS.references,"")}}function buildFullContext(){const weekAgo=Date.now()-7*24*60*60*1e3;const recentDone=doneTasks.filter(t=>new Date(t.doneAt).getTime()>=weekAgo).slice(0,20);return{currentGoal:currentGoal,pendingTasks:pendingTasks,taskBowl:taskBowl.slice(0,60),recentDone:recentDone,goals:goals,todayDate:getTodayDateString()}}function buildSummaryPrompt(tasksToSummarize){if(tasksToSummarize.length===0){return"No tasks were completed in this period."}const taskList=tasksToSummarize.map(t=>{const goalName=t.goalId&&goals.find(g=>g.id===t.goalId)?.text;return`- "${t.text}" ${goalName?`[${goalName}]`:""} (Action: ${t.actionTaken})`}).join("\n");return`You're analyzing my completed work to help me see patterns and progress.\n            ${PROMPT_FRAGMENTS.userStyle}\n            ${PROMPT_FRAGMENTS.goalStatusContext}\n            ## Completed Tasks:\n            ${taskList}\n            ## What I Need\n            Provide a concise analysis (3-4 paragraphs max):\n            1. **Activity Overview**: What did I actually accomplish? Be specific.\n            2. **Focus Patterns**: Were tasks clustered around specific goals or scattered?\n            3. **Momentum Assessment**: Am I building on previous work or jumping around?\n            4. **Honest Observation**: One thing that stands out (good, concerning, or just interesting)\n            Be direct. If work seems scattered, say so. If focused, acknowledge it.\n            Format in Markdown.`}async function handleGenerateSummary(){const weeksInput=document.getElementById("summary-weeks-input");const generateBtn=document.getElementById("generate-summary-btn");const resultWrapper=document.getElementById("summary-result-wrapper");const resultContent=document.getElementById("summary-text-content");const nWeeks=parseInt(weeksInput.value,10);if(isNaN(nWeeks)||nWeeks<1){showToast("Please enter a valid number of weeks.","warning");return}generateBtn.textContent="Analyzing...";generateBtn.disabled=true;resultWrapper.style.display="none";try{const cutoffDate=Date.now()-nWeeks*7*24*60*60*1e3;const relevantTasks=doneTasks.filter(t=>new Date(t.doneAt).getTime()>=cutoffDate);const prompt=buildSummaryPrompt(relevantTasks);let summary;if(relevantTasks.length===0){summary="You haven't completed any tasks in the selected period."}else{summary=await callAIProvider(prompt);saveToLocalStorage(LS_KEYS.aiSummaryLast,summary)}resultContent.innerHTML=parseMarkdown(summary);resultWrapper.style.display="block";const copyBtn=document.getElementById("copy-summary-btn");if(copyBtn){copyBtn.onclick=()=>{navigator.clipboard.writeText(summary);const originalText=copyBtn.innerText;copyBtn.innerText="Copied!";setTimeout(()=>copyBtn.innerText=originalText,2e3)}}}catch(error){resultContent.innerHTML=`An error occurred: ${error.message}`;resultWrapper.style.display="block"}finally{generateBtn.textContent="Generate";generateBtn.disabled=false}}function buildFallenThroughPrompt(context){const contextString=JSON.stringify({currentGoal:context.currentGoal,allGoals:context.allGoals,pendingTasks:context.pendingTasks,taskBowl:context.taskBowl.map(t=>({...t,ageInDays:Math.floor((Date.now()-new Date(t.createdAt))/(1e3*60*60*24))}))},null,2);return`You're helping me identify important tasks that have genuinely fallen through the cracks.\n            ${PROMPT_FRAGMENTS.userStyle}\n            ${PROMPT_FRAGMENTS.goalStatusContext}\n            ${PROMPT_FRAGMENTS.dataContext}\n            ## My Data:\n            ${contextString}\n            ## What "Forgotten" Means\n            A task is likely forgotten if:\n            ‚úÖ Created 2+ weeks ago\n            ‚úÖ Linked to active or focused goal\n            ‚úÖ Appears to be a standalone task (not part of a pre-planned series)\n            ‚úÖ Seems important based on description\n            A task is NOT forgotten if:\n            ‚ùå Part of an obvious series (e.g., "Blog post 1", "Blog post 2"...)\n            ‚ùå Linked to on-hold or completed goals\n            ‚ùå Vague/placeholder text suggesting it was brainstormed not committed\n            ## What I Need\n            Identify 2-4 tasks that seem genuinely forgotten. For each:\n            - Task text\n            - Why it seems forgotten (not just "it's old")\n            - Why it matters (based on goal or content)\n            - Suggested action (revive, reframe, or explicitly drop)\n            If nothing seems forgotten, say so directly - don't force findings.\n            Format in Markdown.`}async function handleAnalyzeFallen(){const analyzeBtn=document.getElementById("analyze-fallen-btn");const wrapper=document.getElementById("fallen-result-wrapper");const contentDiv=document.getElementById("fallen-text-content");analyzeBtn.textContent="Analyzing...";analyzeBtn.disabled=true;wrapper.style.display="none";try{const context=getFullAppContextForAI();const prompt=buildFallenThroughPrompt(context);const analysis=await callAIProvider(prompt);saveToLocalStorage(LS_KEYS.aiForgottenLast,analysis);renderAIResultWithCopy("fallen-result-wrapper","fallen-text-content","copy-fallen-btn",analysis)}catch(error){wrapper.style.display="block";contentDiv.innerHTML=`An error occurred: ${error.message}`}finally{analyzeBtn.textContent="Analyze Now";analyzeBtn.disabled=false}}function buildGeneralQuestionPrompt(context,currentQuestion,prevQ,prevA){const contextString=JSON.stringify(context,null,2);let conversationContext="";if(prevQ&&prevA){conversationContext=`\n            ## Previous Context\n            I previously asked: "${prevQ}"\n            You answered: "${prevA}"\n            The current question may be:\n            - A follow-up building on that answer\n            - A related but new angle\n            - A completely new topic\n            Use your judgment. Don't force continuity if I've clearly moved on.\n            `}return`You're my productivity assistant with full access to my data.\n            ${PROMPT_FRAGMENTS.userStyle}\n            ${PROMPT_FRAGMENTS.goalStatusContext}\n            ${PROMPT_FRAGMENTS.dataContext}\n            ## My Complete Data:\n            ${contextString}\n            ${conversationContext}\n            ## Current Question:\n            "${currentQuestion}"\n            ## How to Answer\n            - For simple queries: Be concise and direct\n            - For complex analysis: Dig into patterns and give honest assessment\n            - If data doesn't support an answer: Say so\n            - If question is vague: Ask for clarification\n            Answer in Markdown.`}async function handleAskGeneralQuestion(){const questionInput=document.getElementById("ai-question-input");const askBtn=document.getElementById("submit-ai-question-btn");const wrapper=document.getElementById("ai-question-result-wrapper");const contentDiv=document.getElementById("ai-question-text-content");const question=questionInput.value.trim();if(!question){showToast("Please enter a question.","warning");return}askBtn.textContent="Thinking...";askBtn.disabled=true;if(wrapper.style.display==="block")contentDiv.style.opacity="0.5";try{const context=getFullAppContextForAI();const prompt=buildGeneralQuestionPrompt(context,question,previousAiQ,previousAiA);const answer=await callAIProvider(prompt);previousAiQ=question;previousAiA=answer;saveToLocalStorage(LS_KEYS.aiChatLast,{q:previousAiQ,a:previousAiA});contentDiv.style.opacity="1";renderAIResultWithCopy("ai-question-result-wrapper","ai-question-text-content","copy-question-btn",answer);questionInput.value=""}catch(error){wrapper.style.display="block";contentDiv.style.opacity="1";contentDiv.innerHTML=`An error occurred: ${error.message}`}finally{askBtn.textContent="Ask AI";askBtn.disabled=false}}function buildAssistPrompt(context){const pendingList=context.pendingTasks.length>0?context.pendingTasks.map(t=>`- "${t.text}"${t.goalId?" [goal-linked]":""}`).join("\n"):"(Empty)";const bowlList=context.taskBowl.length>0?context.taskBowl.slice(0,15).map(t=>`- "${t.text}"${t.goalId?" [goal-linked]":""}`).join("\n"):"(Empty)";const recentDoneList=context.recentDone.length>0?context.recentDone.slice(0,10).map(t=>`- "${t.text}" (${t.actionTaken})`).join("\n"):"(None recently)";const goalsByStatus=context.goals.reduce((acc,g)=>{const status=g.status||"active";if(!acc[status])acc[status]=[];acc[status].push(g);return acc},{});let goalsInfo="";if(goalsByStatus.focused&&goalsByStatus.focused.length>0){const fg=goalsByStatus.focused[0];goalsInfo+=`üéØ FOCUSED: "${fg.text}" (until ${formatDate(fg.focusEndDate)})\n`}if(goalsByStatus.active&&goalsByStatus.active.length>0){goalsInfo+=`üìã ACTIVE: ${goalsByStatus.active.map(g=>`"${g.text}"`).join(", ")}\n`}if(goalsByStatus.on_hold&&goalsByStatus.on_hold.length>0){goalsInfo+=`‚è∏Ô∏è  ON HOLD: ${goalsByStatus.on_hold.length} goal(s)\n`}return`You are my productivity strategist helping me decide what to work on RIGHT NOW.\n            ${PROMPT_FRAGMENTS.userStyle}\n            ${PROMPT_FRAGMENTS.goalStatusContext}\n            ${PROMPT_FRAGMENTS.taskPreferences}\n            ${PROMPT_FRAGMENTS.dataContext}\n            ---\n            ## MY CURRENT STATE (${context.todayDate})\n            ### Goals:\n            ${goalsInfo||"No goals defined"}\n            ### Today's Pending (${context.pendingTasks.length}/3 slots):\n            ${pendingList}\n            ### Recent Progress (last 7 days):\n            ${recentDoneList}\n            ### Backlog (${context.taskBowl.length} total, showing first 15):\n            ${bowlList}\n            ---\n            ## WHAT I NEED\n            Tell me what to work on RIGHT NOW. Consider focused goal progress, momentum from recent completions, Available pending slots, and high-value items in the bowl.\n            Provide 3-5 recommendations in this EXACT format:\n            **Task name** ‚Üí One-line reason\n            *Source: pending/bowl/new*\n            Example:\n            **Ship payment link** ‚Üí Only monetization test ready; 5 days left in focus\n            *Source: bowl, "Learn to earn without salary" goal*\n            **Do "100 Asks" for this week** ‚Üí Got momentum from goals post; need asking data\n            *Source: bowl, "100 Asks in 90 Days" goal*\n            Rules:\n            - Use my exact task text when possible\n            - Keep reason to ONE line (10-15 words max)\n            - Be direct, no fluff\n            - Source must be: pending, bowl, or new`}function showAssistResults(response){const modalBodyDiv=document.createElement("div");let html=response.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>");html=html.split("\n\n").map(para=>{if(para.trim().startsWith("#"))return para;if(para.trim().length===0)return"";return`<p style="margin-bottom: 12px; line-height: 1.6;">${para.replace(/\n/g,"<br>")}</p>`}).join("\n");modalBodyDiv.innerHTML=`\n                    <div style="font-size: 0.95em;">\n                        ${html}\n                    </div>\n                    <hr style="margin: 15px 0;">\n                    <p style="font-size: 0.9em; color: var(--color-text-secondary); margin: 0;">\n                        ${pendingTasks.length>=3?"üí° Pending is full. Complete or delete tasks first.":`üí° You have ${3-pendingTasks.length} pending slot${3-pendingTasks.length>1?"s":""} available.`}\n                    </p>\n                `;showModal("What to Focus On",modalBodyDiv,null,"Got it")}function initializeApp(){if(loadFromLocalStorage(LS_KEYS.blockedTips)===null){saveToLocalStorage(LS_KEYS.blockedTips,defaultProductivityTips)}if(loadFromLocalStorage(LS_KEYS.stressedTips)===null){saveToLocalStorage(LS_KEYS.stressedTips,defaultAllTipsStressed)}if(loadFromLocalStorage(LS_KEYS.boredActions)===null){saveToLocalStorage(LS_KEYS.boredActions,defaultActionsBored)}goals=loadFromLocalStorage(LS_KEYS.goals,[]);currentGoal=loadFromLocalStorage(LS_KEYS.currentGoal,null);const wasMigrated=migrateGoalsToV2();if(wasMigrated){showToast("Goals updated to new lifecycle format!","info",3e3)}if(currentGoal&&currentGoal.id){const freshGoal=goals.find(g=>g.id===currentGoal.id);if(freshGoal&&freshGoal.status===GOAL_STATUS.FOCUSED){currentGoal={id:freshGoal.id,text:freshGoal.text,focusEndDate:freshGoal.focusEndDate}}else{currentGoal=null}saveToLocalStorage(LS_KEYS.currentGoal,currentGoal)}pendingTasks=loadFromLocalStorage(LS_KEYS.pending,[]);doneTasks=loadFromLocalStorage(LS_KEYS.done,[]);taskBowl=loadFromLocalStorage(LS_KEYS.bowl,[]);boredModeState=loadFromLocalStorage(LS_KEYS.boredState,{userActions:[]});routines=loadFromLocalStorage(LS_KEYS.routines,[]);const savedApiKey=loadFromLocalStorage(LS_KEYS.geminiApiKey,null);if(savedApiKey){GEMINI_API_KEY=savedApiKey;console.log("Loaded Gemini API Key from localStorage.")}if(!Array.isArray(goals))goals=[];if(!Array.isArray(pendingTasks))pendingTasks=[];if(!Array.isArray(doneTasks))doneTasks=[];if(!Array.isArray(taskBowl))taskBowl=[];if(!boredModeState||typeof boredModeState!=="object")boredModeState={};if(!Array.isArray(boredModeState.userActions))boredModeState.userActions=[];if(!Array.isArray(routines))routines=[];doneTasks.sort((a,b)=>new Date(b.doneAt)-new Date(a.doneAt));taskBowl.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));const savedSummary=loadFromLocalStorage(LS_KEYS.aiSummaryLast,null);if(savedSummary){document.getElementById("summary-text-content").innerHTML=parseMarkdown(savedSummary);document.getElementById("summary-result-wrapper").style.display="block"}const savedFallen=loadFromLocalStorage(LS_KEYS.aiForgottenLast,null);if(savedFallen){const wrapper=document.getElementById("fallen-result-wrapper");const content=document.getElementById("fallen-text-content");const btn=document.getElementById("copy-fallen-btn");if(wrapper&&content){content.innerHTML=parseMarkdown(savedFallen);wrapper.style.display="block"}}const savedChat=loadFromLocalStorage(LS_KEYS.aiChatLast,null);if(savedChat&&savedChat.q&&savedChat.a){previousAiQ=savedChat.q;previousAiA=savedChat.a;const wrapper=document.getElementById("ai-question-result-wrapper");const content=document.getElementById("ai-question-text-content");if(wrapper&&content){content.innerHTML=parseMarkdown(savedChat.a);wrapper.style.display="block"}}pendingTasksList=document.getElementById("pending-tasks-list");addTaskBtn=document.getElementById("add-task-btn");addTaskForm=document.getElementById("add-task-form");newTaskInput=document.getElementById("new-task-input");tagWithGoalCheckbox=document.getElementById("tag-with-goal-checkbox");submitAddTaskBtn=document.getElementById("submit-add-task");autoAddTaskBtn=document.getElementById("auto-add-task");cancelAddTaskBtn=document.getElementById("cancel-add-task");emptyPendingMessage=document.getElementById("empty-pending-message");goalsList=document.getElementById("goals-list");addNewGoalBtn=document.getElementById("add-new-goal-btn");addGoalForm=document.getElementById("add-goal-form");newGoalInput=document.getElementById("new-goal-input");submitAddGoalBtn=document.getElementById("submit-add-goal");cancelAddGoalBtn=document.getElementById("cancel-add-goal");emptyGoalsMessage=document.getElementById("empty-goals-message");doneListContainer=document.getElementById("done-list");doneTimeFilter=document.getElementById("done-time-filter");doneGoalFilter=document.getElementById("done-goal-filter");emptyDoneMessage=document.getElementById("empty-done-message");taskBowlListContainer=document.getElementById("task-bowl-list");emptyTaskBowlMessage=document.getElementById("empty-task-bowl-message");referencesView=document.getElementById("references-view");remindersView=document.getElementById("reminders-view");copyGoalsBtn=document.getElementById("copy-goals-btn");copyDoneBtn=document.getElementById("copy-done-btn");copyBowlBtn=document.getElementById("copy-bowl-btn");copyRefsBtn=document.getElementById("copy-refs-btn");copyRemindersBtn=document.getElementById("copy-reminders-btn");resetAppBtn=document.getElementById("reset-app-btn");copySummaryBtn=document.getElementById("copy-summary-btn");loadRoutineBtn=document.getElementById("load-routine-btn");routineLoaderArea=document.getElementById("routine-loader-area");routinesView=document.getElementById("routines-view");routinesList=document.getElementById("routines-list");addNewRoutineBtn=document.getElementById("add-new-routine-btn");addRoutineForm=document.getElementById("add-routine-form");newRoutineNameInput=document.getElementById("new-routine-name");newRoutineTasksInput=document.getElementById("new-routine-tasks");submitAddRoutineBtn=document.getElementById("submit-add-routine");cancelAddRoutineBtn=document.getElementById("cancel-add-routine");emptyRoutinesMessage=document.getElementById("empty-routines-message");editRoutineIdInput=document.getElementById("edit-routine-id");goalGuideBtn=document.getElementById("goal-guide-btn");processBrainDumpBtn=document.getElementById("process-braindump-btn");onboardingTriggerWrapper=document.getElementById("onboarding-trigger-wrapper");startOnboardingBtn=document.getElementById("start-onboarding-btn");updateCurrentGoalDisplay();renderPendingTasks();updateAllGoalFilters();BlockedMode.setup(loadFromLocalStorage(LS_KEYS.blockedTips,[]));const boredActions=loadFromLocalStorage(LS_KEYS.boredActions,[]);BoredMode.setup(boredActions,boredModeState);const stressedTips=loadFromLocalStorage(LS_KEYS.stressedTips,{});const stressedQuotes=stressedTips.generic||[];StressedMode.setup(stressedTips,stressedQuotes);const savedTheme=loadFromLocalStorage(LS_KEYS.theme,"light");applyTheme(savedTheme);if(!shouldShowOnboarding()){checkDailyReset()}else{saveToLocalStorage(LS_KEYS.lastOpenedDate,getTodayDateString())}blitzWorker=createBlitzWorker();blitzWorker.onmessage=function(e){const{event:event,taskId:taskId,time:time}=e.data;switch(event){case"tick":handleBlitzTick(taskId,time);break;case"done":handleBlitzDone(taskId);break}};addEventListeners();setupDataManagement();if(shouldShowOnboarding()){initOnboarding();showView("onboarding-view");console.log("Guide App Initialized - Showing Onboarding")}else{showView("main-view");console.log("Guide App Initialized (v47 - minor-fixes pre-publishing)")}}function addEventListeners(){backButton.addEventListener("click",()=>showView("main-view"));document.getElementById("flow-skip-btn").addEventListener("click",()=>closeFlowMode(false));document.getElementById("flow-finish-btn").addEventListener("click",()=>closeFlowMode(true));seeAllGoalsLink.addEventListener("click",e=>{e.preventDefault();showView("goals-view")});document.getElementById("nav-ai-insights").addEventListener("click",()=>showView("ai-insights-view"));document.getElementById("nav-blocked").addEventListener("click",()=>showView("blocked-view"));document.getElementById("nav-bored").addEventListener("click",()=>showView("bored-view"));document.getElementById("nav-stressed").addEventListener("click",()=>showView("stressed-view"));document.getElementById("nav-done").addEventListener("click",()=>showView("done-list-view"));document.getElementById("nav-bowl").addEventListener("click",()=>showView("task-bowl-view"));document.getElementById("nav-refs").addEventListener("click",()=>showView("references-view"));document.getElementById("nav-reminders").addEventListener("click",()=>showView("reminders-view"));document.getElementById("nav-routines").addEventListener("click",()=>showView("routines-view"));document.getElementById("nav-settings").addEventListener("click",()=>showView("settings-view"));document.getElementById("theme-toggle").addEventListener("click",toggleTheme);mainContentArea.addEventListener("click",e=>{if(e.target&&e.target.classList.contains("edit-task-goal-link")){e.preventDefault();const taskId=e.target.dataset.taskId;const listName=e.target.dataset.listName;promptEditTaskGoal(taskId,listName)}});addNewGoalBtn.addEventListener("click",()=>{addGoalForm.classList.remove("hidden");addNewGoalBtn.classList.add("hidden");newGoalInput.focus()});cancelAddGoalBtn.addEventListener("click",()=>{addGoalForm.classList.add("hidden");addNewGoalBtn.classList.remove("hidden");newGoalInput.value=""});submitAddGoalBtn.addEventListener("click",handleAddGoal);newGoalInput.addEventListener("keypress",e=>{if(e.key==="Enter")handleAddGoal()});doneTimeFilter.addEventListener("change",renderDoneList);const bowlGoalFilter=document.getElementById("bowl-goal-filter");doneGoalFilter.addEventListener("change",renderDoneList);bowlGoalFilter.addEventListener("change",()=>{renderTaskBowl(false);updateGuideButtonVisibility()});goalGuideBtn.addEventListener("click",startGoalGuide);if(copyGoalsBtn)copyGoalsBtn.addEventListener("click",()=>copyToClipboard(formatGoalsAsMarkdown()));if(copyDoneBtn)copyDoneBtn.addEventListener("click",()=>copyToClipboard(formatDoneListAsMarkdown()));if(copyBowlBtn)copyBowlBtn.addEventListener("click",()=>copyToClipboard(formatTaskBowlAsMarkdown()));if(copyRefsBtn)copyRefsBtn.addEventListener("click",()=>copyToClipboard(loadFromLocalStorage(LS_KEYS.references,"")));if(copyRemindersBtn)copyRemindersBtn.addEventListener("click",()=>copyToClipboard(loadFromLocalStorage(LS_KEYS.reminders,"")));if(resetAppBtn)resetAppBtn.addEventListener("click",confirmResetApp);const resetOnboardingBtn=document.getElementById("reset-onboarding-btn");if(resetOnboardingBtn){resetOnboardingBtn.addEventListener("click",()=>{showModal("Reset Onboarding?","This will clear all your current tasks and goals so you can see the onboarding flow again.",()=>{localStorage.removeItem(LS_PREFIX+"onboardingCompleted");Object.values(LS_KEYS).forEach(key=>{localStorage.removeItem(key)});showToast("Onboarding reset. Reloading...","info",2e3);setTimeout(()=>location.reload(),1500)},"Reset & Reload")})}if(copySummaryBtn){copySummaryBtn.addEventListener("click",()=>{const lastSummary=loadFromLocalStorage(LS_KEYS.aiSummaryLast,"");copyToClipboard(lastSummary)})}if(processBrainDumpBtn)processBrainDumpBtn.addEventListener("click",handleProcessBrainDump);document.getElementById("save-ai-settings-btn").addEventListener("click",saveAiSettings);document.getElementById("ai-provider-select").addEventListener("change",e=>{const provider=e.target.value;const settings=loadFromLocalStorage(LS_KEYS.aiSettings,{activeProvider:"gemini",keys:{},selectedModels:DEFAULT_MODELS});updateModelDropdown(provider,settings.selectedModels);updateKeyFieldVisibility(provider)});loadRoutineBtn.addEventListener("click",()=>showView("routines-view"));addNewRoutineBtn.addEventListener("click",()=>{editRoutineIdInput.value="";newRoutineNameInput.value="";newRoutineTasksInput.value="";addRoutineForm.classList.remove("hidden");addNewRoutineBtn.classList.add("hidden");newRoutineNameInput.focus()});cancelAddRoutineBtn.addEventListener("click",()=>{addRoutineForm.classList.add("hidden");addNewRoutineBtn.classList.remove("hidden")});submitAddRoutineBtn.addEventListener("click",handleAddOrUpdateRoutine);if(startOnboardingBtn)startOnboardingBtn.addEventListener("click",showOnboardingModal);const settingsOnboardingBtn=document.getElementById("settings-onboarding-btn");if(settingsOnboardingBtn){settingsOnboardingBtn.addEventListener("click",showOnboardingModal)}document.getElementById("reset-chat-btn").addEventListener("click",()=>{previousAiQ=null;previousAiA=null;document.getElementById("ai-question-input").value="";document.getElementById("ai-question-result-wrapper").style.display="none";showToast("Chat context cleared.","info")});BlockedMode.addListeners();BoredMode.addListeners();StressedMode.addListeners();const addTaskBtnPending=document.getElementById("add-task-btn");const addTaskBtnBowl=document.getElementById("add-task-to-bowl-btn");addTaskBtnPending.addEventListener("click",()=>{const pendingTasksListEl=document.getElementById("pending-tasks-list");pendingTasksListEl.before(addTaskForm);addTaskForm.classList.remove("hidden");addTaskBtnPending.classList.add("hidden");updateAddTaskPlaceholder();newTaskInput.focus()});addTaskBtnBowl.addEventListener("click",()=>{const taskBowlList=document.getElementById("task-bowl-list");taskBowlList.before(addTaskForm);addTaskForm.classList.remove("hidden");addTaskBtnBowl.classList.add("hidden");updateAddTaskPlaceholder();newTaskInput.focus()});cancelAddTaskBtn.addEventListener("click",()=>{addTaskForm.classList.add("hidden");addTaskBtnPending.classList.remove("hidden");addTaskBtnBowl.classList.remove("hidden");newTaskInput.value=""});const performAddTask=(isAuto=false)=>{const forceToBowl=addTaskForm.parentElement.id==="task-bowl-view";if(isAuto){addAutoTask(forceToBowl)}else{handleAddTask(forceToBowl)}};submitAddTaskBtn.addEventListener("click",()=>performAddTask(false));autoAddTaskBtn.addEventListener("click",()=>performAddTask(true));newTaskInput.addEventListener("keypress",e=>{if(e.key==="Enter"){performAddTask(false)}});document.getElementById("generate-summary-btn").addEventListener("click",handleGenerateSummary);document.getElementById("analyze-fallen-btn").addEventListener("click",handleAnalyzeFallen);document.getElementById("submit-ai-question-btn").addEventListener("click",handleAskGeneralQuestion);document.getElementById("ai-question-input").addEventListener("keypress",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();handleAskGeneralQuestion()}});document.getElementById("ai-assist-btn").addEventListener("click",runAIAssist);document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.key==="/"){e.preventDefault();if(document.getElementById("main-view").classList.contains("active")){runAIAssist()}}})}const BlockedMode=function(){let tipsData=[];let navBtns={};let subViews={};let randomDisplay,newRandomBtn;let diagnosticOptionsDiv,diagnosticResultsDiv,diagnosticTipsDiv,diagnosticTitle,resetDiagnosticBtn;let aiInput,aiGetBtn,aiResultDiv;let allPrinciplesDiv,allFrameworkDiv,allManagementDiv;function getRandomItem(array){if(!array||array.length===0)return{text:"No strategies found.",category:"System"};return array[Math.floor(Math.random()*array.length)]}function switchMode(mode){Object.values(subViews).forEach(el=>el&&el.classList.add("hidden"));Object.values(navBtns).forEach(btn=>btn&&btn.classList.remove("btn-primary"));Object.values(navBtns).forEach(btn=>btn&&btn.classList.add("btn"));if(subViews[mode])subViews[mode].classList.remove("hidden");if(navBtns[mode]){navBtns[mode].classList.add("btn-primary")}if(mode==="random")displayRandom();if(mode==="all")displayAll();if(mode==="interactive"&&diagnosticResultsDiv){diagnosticOptionsDiv.classList.remove("hidden");diagnosticResultsDiv.classList.add("hidden")}}function displayRandom(){if(!randomDisplay)return;const tip=getRandomItem(tipsData);randomDisplay.innerHTML=`\n                        <div style="font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; color: var(--color-primary); margin-bottom: 10px;">${tip.category}</div>\n                        <div style="font-size: 1.3em; font-weight: 500; line-height: 1.4;">"${tip.text}"</div>\n                    `}function displayDiagnosticResult(issue){if(!diagnosticTipsDiv)return;const filtered=tipsData.filter(t=>t.issues&&t.issues.includes(issue));const names={overwhelm:"Overwhelm",starting:"Starting",focus:"Focus",decision:"Making Decisions",shipping:"Shipping",motivation:"Motivation"};if(diagnosticTitle)diagnosticTitle.textContent=`Strategies for: ${names[issue]||issue}`;if(filtered.length===0){diagnosticTipsDiv.innerHTML='<p class="text-secondary">No specific tips found for this issue.</p>'}else{diagnosticTipsDiv.innerHTML=filtered.map(tip=>`\n                            <div class="task-card" style="margin-bottom: 10px; border-left: 4px solid var(--color-primary);">\n                                <div style="font-size: 0.8em; color: var(--color-text-secondary);">${tip.category}</div>\n                                <div style="font-weight: 500;">${tip.text}</div>\n                            </div>\n                        `).join("")}diagnosticOptionsDiv.classList.add("hidden");diagnosticResultsDiv.classList.remove("hidden")}function displayAll(){if(!allPrinciplesDiv)return;allPrinciplesDiv.innerHTML="";allFrameworkDiv.innerHTML="";allManagementDiv.innerHTML="";const createItem=tip=>`\n                        <div class="list-item" style="margin-bottom: 8px; padding: 10px;">\n                            <span>${tip.text}</span>\n                        </div>`;tipsData.forEach(tip=>{const html=createItem(tip);if(tip.section==="Core Principles"&&allPrinciplesDiv)allPrinciplesDiv.innerHTML+=html;else if(tip.section==="Action Framework"&&allFrameworkDiv)allFrameworkDiv.innerHTML+=html;else if(tip.section==="Task Management"&&allManagementDiv)allManagementDiv.innerHTML+=html})}async function handleAiRequest(){if(!aiInput||!aiResultDiv)return;const userInput=aiInput.value.trim();if(!navigator.onLine){showToast("Offline.","warning");return}aiGetBtn.textContent="Thinking...";aiGetBtn.disabled=true;try{const context=getFullAppContextForAI();const prompt=buildBlockedAIPrompt(userInput,context);const response=await callAIProvider(prompt);aiResultDiv.innerHTML=parseMarkdown(response);aiResultDiv.classList.remove("hidden")}catch(error){showToast(error.message,"error")}finally{aiGetBtn.textContent="Get Guidance";aiGetBtn.disabled=false}}return{setup:tips=>{tipsData=tips},initDisplay:()=>{switchMode("random");if(aiInput)aiInput.value="";if(aiResultDiv)aiResultDiv.classList.add("hidden")},addListeners:()=>{navBtns={random:document.getElementById("blocked-mode-random"),interactive:document.getElementById("blocked-mode-interactive"),ai:document.getElementById("blocked-mode-ai"),all:document.getElementById("blocked-mode-all")};subViews={random:document.getElementById("blocked-subview-random"),interactive:document.getElementById("blocked-subview-interactive"),ai:document.getElementById("blocked-subview-ai"),all:document.getElementById("blocked-subview-all")};if(navBtns.random)navBtns.random.addEventListener("click",()=>switchMode("random"));if(navBtns.interactive)navBtns.interactive.addEventListener("click",()=>switchMode("interactive"));if(navBtns.ai)navBtns.ai.addEventListener("click",()=>switchMode("ai"));if(navBtns.all)navBtns.all.addEventListener("click",()=>switchMode("all"));randomDisplay=document.getElementById("blocked-random-display");newRandomBtn=document.getElementById("blocked-btn-new-random");if(newRandomBtn)newRandomBtn.addEventListener("click",displayRandom);diagnosticOptionsDiv=document.getElementById("blocked-diagnostic-options");diagnosticResultsDiv=document.getElementById("blocked-diagnostic-results");diagnosticTipsDiv=document.getElementById("blocked-diagnostic-tips");diagnosticTitle=document.getElementById("blocked-diagnostic-title");resetDiagnosticBtn=document.getElementById("blocked-btn-reset-diagnostic");const optionBtns=document.querySelectorAll(".blocked-option-btn");optionBtns.forEach(btn=>{btn.addEventListener("click",()=>displayDiagnosticResult(btn.dataset.issue))});if(resetDiagnosticBtn)resetDiagnosticBtn.addEventListener("click",()=>{diagnosticResultsDiv.classList.add("hidden");diagnosticOptionsDiv.classList.remove("hidden")});aiInput=document.getElementById("blocked-ai-input");aiGetBtn=document.getElementById("blocked-btn-get-ai");aiResultDiv=document.getElementById("blocked-ai-result");if(aiGetBtn)aiGetBtn.addEventListener("click",handleAiRequest);allPrinciplesDiv=document.getElementById("blocked-all-principles");allFrameworkDiv=document.getElementById("blocked-all-framework");allManagementDiv=document.getElementById("blocked-all-management")}}}();const defaultProductivityTips=[{text:"Focus on the bigger picture",category:"Mindset",section:"Core Principles",issues:["overwhelm","focus"]},{text:"Have faith in your ideas",category:"Mindset",section:"Core Principles",issues:["motivation","shipping"]},{text:"Don't let fear of asking hold you back",category:"Mindset",section:"Core Principles",issues:["starting","decision"]},{text:"No perfect plan exists, start with good enough",category:"Mindset",section:"Core Principles",issues:["starting","decision"]},{text:"Deliver four iterations in short loops - bad to great - instead of a single perfect one.",category:"Mindset",section:"Core Principles",issues:["starting","decision"]},{text:"If stuck for 5+ minutes, take a call and move on; Most decisions are cheap. And reversible.",category:"Mindset",section:"Core Principles",issues:["starting","decision"]},{text:"Be careful sharing incomplete thoughts",category:"Mindset",section:"Core Principles",issues:["decision"]},{text:"Everyone has their niche",category:"Mindset",section:"Core Principles",issues:["motivation","focus"]},{text:"Tell your story",category:"Mindset",section:"Core Principles",issues:["motivation"]},{text:"Document weekly summaries",category:"Mindset",section:"Core Principles",issues:["focus","motivation"]},{text:"Write detailed pieces",category:"Mindset",section:"Core Principles",issues:["focus"]},{text:"Take more leaps",category:"Productivity Philosophy",section:"Core Principles",issues:["starting","decision"]},{text:"Work best one thing at a time",category:"Productivity Philosophy",section:"Core Principles",issues:["overwhelm","focus"]},{text:"Small forward momentum helps",category:"Productivity Philosophy",section:"Core Principles",issues:["focus","motivation","starting"]},{text:"Avoid uncategorized lists",category:"Productivity Philosophy",section:"Core Principles",issues:["overwhelm","focus"]},{text:"Quantity over quality initially",category:"Getting Started",section:"Action Framework",issues:["starting","overwhelm"]},{text:"Tasks as 'creative plays'",category:"Getting Started",section:"Action Framework",issues:["starting","motivation"]},{text:"Remove self-imposed timelines",category:"Getting Started",section:"Action Framework",issues:["starting","overwhelm"]},{text:"Break down into small steps",category:"Getting Started",section:"Action Framework",issues:["starting","overwhelm"]},{text:"Delegate",category:"Getting Started",section:"Action Framework",issues:["overwhelm"]},{text:"Get into flow",category:"Getting Started",section:"Action Framework",issues:["focus","starting","motivation"]},{text:"Difficult phases strategy",category:"Getting Started",section:"Action Framework",issues:["motivation","focus"]},{text:"Tasks get done, projects postponed",category:"Execution Strategies",section:"Action Framework",issues:["overwhelm","starting"]},{text:"'Done begets done'",category:"Execution Strategies",section:"Action Framework",issues:["motivation","shipping"]},{text:"Multiple iterations > perfection",category:"Execution Strategies",section:"Action Framework",issues:["shipping","starting"]},{text:"Time-boxing > scope estimation",category:"Execution Strategies",section:"Action Framework",issues:["focus","shipping","overwhelm"]},{text:"Make faster decisions",category:"Execution Strategies",section:"Action Framework",issues:["decision","focus"]},{text:"Planning to doing quickly",category:"Execution Strategies",section:"Action Framework",issues:["starting","decision"]},{text:"Rapid feedback cycles (2-2-2)",category:"Shipping Framework",section:"Action Framework",issues:["shipping","overwhelm"]},{text:"Keys to shipping",category:"Shipping Framework",section:"Action Framework",issues:["shipping"]},{text:"Share progress updates",category:"Shipping Framework",section:"Action Framework",issues:["shipping","motivation"]},{text:"Challenges: remembering & acting",category:"Task Management",section:"Task Management",issues:["focus","overwhelm"]},{text:"Maintain clear priorities",category:"Task Management",section:"Task Management",issues:["overwhelm","focus"]},{text:"Sustained energy factors",category:"Task Management",section:"Task Management",issues:["motivation","focus"]}];const BoredMode=function(){const COOLDOWN=60*60*1e3;const ELSE_WINDOW=10*60*1e3;const MAX_ELSE=3;let defaultActions=[];let state={};let timerInterval=null;let surpriseBtn,elseBtn,suggestionDiv,timerTextDiv,progressBarContainer,progressBarFill,customActionInput,addActionBtn;function getRandomSuggestion(){const all=[...defaultActions,...state.userActions||[]];if(all.length===0)return"Add custom actions in Settings!";return all[Math.floor(Math.random()*all.length)]}function displayCurrentState(){if(!suggestionDiv)return;if(state.currentSuggestion&&state.lastClick){suggestionDiv.innerText=state.currentSuggestion;const now=Date.now();elseBtn.style.display=now-state.suggestionTime<ELSE_WINDOW&&state.elseCount<MAX_ELSE&&now-state.lastClick<COOLDOWN?window.innerWidth<=600?"block":"inline-block":"none"}else{suggestionDiv.innerText="";elseBtn.style.display="none"}}function updateTimer(){if(!timerTextDiv||!progressBarContainer||!surpriseBtn)return;if(!state.lastClick){timerTextDiv.innerText="";progressBarContainer.style.display="none";progressBarFill.style.width="0%";surpriseBtn.disabled=false;return}const now=Date.now();const elapsed=now-state.lastClick;const remaining=COOLDOWN-elapsed;if(remaining>0){const m=Math.floor(remaining/6e4);const s=Math.floor(remaining%6e4/1e3);timerTextDiv.innerText=`Try again in ${m}m ${s}s`;progressBarFill.style.width=`${Math.min(elapsed/COOLDOWN*100,100)}%`;progressBarContainer.style.display="block";surpriseBtn.disabled=true}else{timerTextDiv.innerText="Ready for a new surprise!";progressBarContainer.style.display="none";progressBarFill.style.width="0%";surpriseBtn.disabled=false;if(state.currentSuggestion&&elseBtn)elseBtn.style.display="none"}}function resetBoredState(){state={lastClick:null,suggestionTime:null,elseCount:0,currentSuggestion:"",userActions:state.userActions||[]};saveToLocalStorage(LS_KEYS.boredState,state);if(elseBtn)elseBtn.style.display="none";if(suggestionDiv)suggestionDiv.innerText="";updateTimer()}function saveBoredState(){saveToLocalStorage(LS_KEYS.boredState,state)}return{setup:(defaults,loadedState)=>{defaultActions=defaults;state=loadedState||{userActions:[]};if(!Array.isArray(state.userActions))state.userActions=[]},initDisplay:()=>{if(!timerInterval){updateTimer();timerInterval=setInterval(updateTimer,1e3)}displayCurrentState()},cleanup:()=>{if(timerInterval){clearInterval(timerInterval);timerInterval=null}},addListeners:()=>{surpriseBtn=document.getElementById("surpriseBtn");elseBtn=document.getElementById("elseBtn");suggestionDiv=document.getElementById("suggestion");timerTextDiv=document.getElementById("timerText");progressBarContainer=document.getElementById("progressBarContainer");progressBarFill=document.getElementById("progressBarFill");customActionInput=document.getElementById("customActionInput");addActionBtn=document.getElementById("addActionBtn");if(surpriseBtn)surpriseBtn.addEventListener("click",()=>{const now=Date.now();if(surpriseBtn.disabled&&state.lastClick&&now-state.lastClick<COOLDOWN)return;if(state.lastClick&&now-state.lastClick>=COOLDOWN)resetBoredState();const suggestion=getRandomSuggestion();suggestionDiv.innerText=suggestion;state.lastClick=now;state.suggestionTime=now;state.elseCount=0;state.currentSuggestion=suggestion;progressBarFill.style.width="0%";saveBoredState();updateTimer();displayCurrentState()});if(elseBtn)elseBtn.addEventListener("click",()=>{const now=Date.now();if(!state.suggestionTime||now-state.suggestionTime>=ELSE_WINDOW||state.elseCount>=MAX_ELSE||!state.lastClick||now-state.lastClick<COOLDOWN){elseBtn.style.display="none";return}let newSuggestion;let attempts=0;const all=[...defaultActions,...state.userActions||[]];const maxAttempts=all.length>1?all.length*2:1;do{newSuggestion=getRandomSuggestion();attempts++}while(newSuggestion===state.currentSuggestion&&attempts<maxAttempts&&all.length>1);suggestionDiv.innerText=newSuggestion;state.elseCount++;state.currentSuggestion=newSuggestion;saveBoredState();if(state.elseCount>=MAX_ELSE)elseBtn.style.display="none"});if(addActionBtn)addActionBtn.addEventListener("click",()=>{const text=customActionInput.value.trim();if(!text){showToast("Enter action.","warning");return}if(!state.userActions)state.userActions=[];state.userActions.push(text);customActionInput.value="";saveBoredState();showToast(`Action added: "${text}"`,"success")})}}}();const defaultActionsBored=["üö∂‚Äç‚ôÇÔ∏è Take a 15-minute brisk walk outside","üìû Call or text a friend","üç≥ Try a new quick recipe","üìñ Read a chapter of a book","üßò Do a 5-10 minute meditation","üôè Write 3 things you're grateful for","üéß Listen to a new podcast episode","ü§∏ Do 10 minutes of stretching","üßπ Tidy up one small area","üé• Watch a short TED Talk","üé® Draw or doodle for 15 minutes","üçΩÔ∏è Plan meals for the next two days","üå± Water your plants","üéµ Listen to an album distraction-free","üó£Ô∏è Learn 5 phrases in a new language","‚ùì Do a quick online quiz","‚úçÔ∏è Write a short poem/paragraph","üëõ Declutter your wallet/purse","üå≥ Step outside & observe for 5 minutes","‚òÅÔ∏è Look up at the clouds/stars","üß© Do a simple puzzle","üíª Organize desktop files","üê∂ Watch funny animal videos","üé§ Sing along loudly","‚úàÔ∏è Browse a travel website"];const StressedMode=function(){let tipsData={};let quotesData=[];let modeSelector,modeContent,randomModeBtn,interactiveModeBtn,allTipsModeBtn,randomModeDiv,interactiveModeDiv,allTipsModeDiv,randomTipDiv,newRandomTipBtn,questionContainer,tipsResultDiv,feelingTypeSpan,feelingTipsDiv,backToFeelingsBtn,optionBtns;function getRandomItem(array){if(!array||array.length===0)return"No tips available. Add some in Settings.</div>";return array[Math.floor(Math.random()*array.length)]}function displayRandomTip(){if(!randomTipDiv)return;randomTipDiv.innerHTML=`<p>${getRandomItem(quotesData)}</p>`}function showFeelingTips(feeling){if(!questionContainer||!tipsResultDiv||!feelingTypeSpan||!feelingTipsDiv)return;questionContainer.classList.add("hidden");tipsResultDiv.classList.remove("hidden");const map={rudderless:"Rudderless",overwhelmed:"Overwhelmed",cluttered:"Cluttered",control:"Lacking Control",uncertain:"Uncertain"};feelingTypeSpan.textContent=map[feeling]||feeling;feelingTipsDiv.innerHTML="";if(tipsData[feeling]&&tipsData[feeling].length>0){tipsData[feeling].forEach(tip=>{const div=document.createElement("div");div.className="tip-item";div.textContent=tip;feelingTipsDiv.appendChild(div)})}else{feelingTipsDiv.innerHTML=`<p>No tips found for this feeling. You can add some in the Settings view.</p>`}}function populateAllTips(){if(!tipsData)return;for(const cat in tipsData){const list=document.getElementById(`all-${cat}`);if(list){list.innerHTML="";if(tipsData[cat]&&tipsData[cat].length>0){tipsData[cat].forEach(tip=>{const li=document.createElement("li");li.textContent=tip;list.appendChild(li)})}else{list.innerHTML=`<li>No tips defined.</li>`}}}}function switchMode(mode){if(!randomModeDiv||!interactiveModeDiv||!allTipsModeDiv)return;randomModeDiv.classList.add("hidden");interactiveModeDiv.classList.add("hidden");allTipsModeDiv.classList.add("hidden");if(mode==="random"){randomModeDiv.classList.remove("hidden");displayRandomTip()}else if(mode==="interactive"){interactiveModeDiv.classList.remove("hidden");if(questionContainer)questionContainer.classList.remove("hidden");if(tipsResultDiv)tipsResultDiv.classList.add("hidden")}else if(mode==="all-tips"){allTipsModeDiv.classList.remove("hidden");populateAllTips()}}return{setup:(tips,quotes)=>{tipsData=tips;quotesData=quotes},initDisplay:()=>{switchMode("random")},addListeners:()=>{modeSelector=document.querySelector("#stressed-view .mode-selector");modeContent=document.getElementById("stressed-mode-content");randomModeBtn=document.getElementById("random-mode-btn-stressed");interactiveModeBtn=document.getElementById("interactive-mode-btn-stressed");allTipsModeBtn=document.getElementById("all-tips-mode-btn-stressed");randomModeDiv=document.getElementById("random-mode-stressed");interactiveModeDiv=document.getElementById("interactive-mode-stressed");allTipsModeDiv=document.getElementById("all-tips-mode-stressed");randomTipDiv=document.getElementById("random-tip-stressed");newRandomTipBtn=document.getElementById("new-random-tip-stressed");questionContainer=document.getElementById("question-container-stressed");tipsResultDiv=document.getElementById("tips-result-stressed");feelingTypeSpan=document.getElementById("feeling-type-stressed");feelingTipsDiv=document.getElementById("feeling-tips-stressed");backToFeelingsBtn=document.getElementById("back-to-feelings-stressed");optionBtns=interactiveModeDiv?.querySelectorAll(".option-btn");if(randomModeBtn)randomModeBtn.addEventListener("click",()=>switchMode("random"));if(interactiveModeBtn)interactiveModeBtn.addEventListener("click",()=>switchMode("interactive"));if(allTipsModeBtn)allTipsModeBtn.addEventListener("click",()=>switchMode("all-tips"));if(newRandomTipBtn)newRandomTipBtn.addEventListener("click",displayRandomTip);if(backToFeelingsBtn)backToFeelingsBtn.addEventListener("click",()=>{if(questionContainer)questionContainer.classList.remove("hidden");if(tipsResultDiv)tipsResultDiv.classList.add("hidden")});if(optionBtns)optionBtns.forEach(btn=>btn.addEventListener("click",()=>showFeelingTips(btn.getAttribute("data-feeling"))));const stressedAiSection=document.getElementById("stressed-ai-section");const stressedAiInput=document.getElementById("stressed-ai-input");const getStressedAiBtn=document.getElementById("get-stressed-ai-help");const cancelStressedAiBtn=document.getElementById("cancel-stressed-ai");const stressedAiResult=document.getElementById("stressed-ai-result");const aiModeBtn=document.getElementById("ai-mode-btn-stressed");if(aiModeBtn){aiModeBtn.addEventListener("click",()=>{const aiSettings=loadFromLocalStorage(LS_KEYS.aiSettings,{activeProvider:"gemini",keys:{}});const hasApiKey=aiSettings.keys[aiSettings.activeProvider];if(!hasApiKey){showToast("AI not configured. Add API key in Settings.","warning");return}if(randomModeDiv)randomModeDiv.classList.add("hidden");if(interactiveModeDiv)interactiveModeDiv.classList.add("hidden");if(allTipsModeDiv)allTipsModeDiv.classList.add("hidden");if(stressedAiSection){stressedAiSection.classList.remove("hidden");if(stressedAiInput)stressedAiInput.focus()}})}if(cancelStressedAiBtn){cancelStressedAiBtn.addEventListener("click",()=>{if(stressedAiSection)stressedAiSection.classList.add("hidden");if(stressedAiInput)stressedAiInput.value="";if(stressedAiResult)stressedAiResult.classList.add("hidden");switchMode("random")})}if(getStressedAiBtn){getStressedAiBtn.addEventListener("click",async()=>{const userInput=stressedAiInput?.value.trim();if(!navigator.onLine){showToast("Offline. Cannot get AI support.","warning");return}getStressedAiBtn.textContent="Thinking...";getStressedAiBtn.disabled=true;try{const context=getFullAppContextForAI();const prompt=buildStressedAIPrompt(userInput,context);const response=await callAIProvider(prompt);if(response){stressedAiResult.innerHTML=parseMarkdown(response);stressedAiResult.classList.remove("hidden")}else{throw new Error("AI returned no response.")}}catch(error){console.error("Stressed AI failed:",error);showToast(`AI support failed: ${error.message}`,"error",4e3)}finally{getStressedAiBtn.textContent="Get AI Support";getStressedAiBtn.disabled=false}})}}}}();const defaultAllTipsStressed={rudderless:["Set weekly/daily priorities","Break down tasks","Execute and pivot plans","Focus on quantity over quality for momentum","Get small things 'done'"],overwhelmed:["List worries and see what's real vs. catastrophisation","Write it all down, brain dump, pick just any 1-2 items that matter today","Drop items until you're left with 2-3","You're doing better than you think; Step back and see what you've achieved.","Take a walk outside","Practice morning pages","Announce need for alone time","Remind yourself some commitments might be voluntary"],cluttered:["Drop non-essential items","Finish lingering tasks","Limit media consumption","Uninterrupted me-time (music/nature sounds)","Control your morning time","Write it all down, brain dump, pick just any 1-2 items that matter today","Take a walk outside"],control:["Remind yourself some commitments are voluntary","Reframe tasks as creative plays","Focus on tiny next steps","Walks in nature by yourself","Permit 2 hours free time daily. Priortize this slot first on your calendar. Everything else will need to move around."],uncertain:["Write down issues and actions","Check if making it bigger than necessary","Get small things 'done'","Plans don't need to be perfect","Magic of action","Permit 2 hours free time daily - Let your mind wander, it's essential"],generic:["Exercise","Uninterrupted me-time","Control morning time","Permit 2 hours free time","No drama","Magic of action","Plans don't need to be perfect, just execute and pivot.","Focus on quantity over quality to build momentum.","Set priorities to stay focused.","Break down tasks into smaller chunks.","Get small things 'done' to build momentum.","Commitments are voluntary.","Reframe tasks as creative plays.","Focus on tiny next steps.","Morning pages help center.","Walks help clear the mind.","Announce need for alone time."]};function confirmResetApp(){showModal("Reset Application Data","Are you sure you want to reset the app? All tasks, goals, notes, and settings stored in this browser will be permanently deleted.",resetApp,"Reset")}function resetApp(){console.log("Resetting application data...");Object.values(LS_KEYS).forEach(key=>{localStorage.removeItem(key);console.log(`Removed: ${key}`)});showToast("Application reset. Reloading...","info",2e3);setTimeout(()=>{location.reload()},1500)}async function saveFile(content,options){const{fileName:fileName,fileType:fileType,description:description}=options;if(window.showSaveFilePicker){try{const pickerOpts={suggestedName:fileName,types:[{description:description,accept:{[fileType]:[".json"]}}]};const handle=await window.showSaveFilePicker(pickerOpts);const writable=await handle.createWritable();await writable.write(content);await writable.close();showToast(`${fileName} saved successfully!`,"success");return}catch(error){console.error("File System Access API failed. Error:",error);if(error.name==="AbortError"){return}showToast("Save dialog failed. Using fallback download.","warning",2500)}}try{const blob=new Blob([content],{type:fileType});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=fileName;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}catch(fallbackError){console.error("Error with fallback file save:",fallbackError);showToast("File export failed completely.","error")}}function loadAiSettingsUI(){const settings=loadFromLocalStorage(LS_KEYS.aiSettings,{activeProvider:"gemini",keys:{},selectedModels:DEFAULT_MODELS});document.getElementById("ai-provider-select").value=settings.activeProvider||"gemini";updateModelDropdown(settings.activeProvider,settings.selectedModels);updateKeyFieldVisibility(settings.activeProvider);document.getElementById("gemini-key-input").value=settings.keys.gemini||"";document.getElementById("openai-key-input").value=settings.keys.openai||"";document.getElementById("claude-key-input").value=settings.keys.claude||"";document.getElementById("deepseek-key-input").value=settings.keys.deepseek||""}function updateModelDropdown(provider,selectedModels={}){const modelSelect=document.getElementById("ai-model-select");const models=AI_MODELS[provider]||[];modelSelect.innerHTML=models.map(m=>`<option value="${m.id}" ${selectedModels[provider]===m.id?"selected":""}>${m.label}</option>`).join("")}function updateKeyFieldVisibility(provider){document.querySelectorAll(".api-key-section").forEach(section=>{section.style.display="none"});const section=document.getElementById(`${provider}-key-section`);if(section)section.style.display="block"}function saveAiSettings(){const provider=document.getElementById("ai-provider-select").value;const selectedModel=document.getElementById("ai-model-select").value;const existingSettings=loadFromLocalStorage(LS_KEYS.aiSettings,{activeProvider:"gemini",keys:{},selectedModels:DEFAULT_MODELS});const settings={activeProvider:provider,keys:{gemini:document.getElementById("gemini-key-input").value.trim(),openai:document.getElementById("openai-key-input").value.trim(),claude:document.getElementById("claude-key-input").value.trim(),deepseek:document.getElementById("deepseek-key-input").value.trim()},selectedModels:{...existingSettings.selectedModels,[provider]:selectedModel}};saveToLocalStorage(LS_KEYS.aiSettings,settings);showToast("AI settings saved successfully!","success")}function setupDataManagement(){setupPlaybookControls("blocked","Blocked Playbook Data",LS_KEYS.blockedTips);setupPlaybookControls("stressed","Stressed Playbook Data",LS_KEYS.stressedTips);setupPlaybookControls("bored","Bored Actions Data",LS_KEYS.boredActions);document.getElementById("export-full-backup-btn").addEventListener("click",exportFullBackup);document.getElementById("import-full-backup-input").addEventListener("change",handleFullBackupImport);document.getElementById("edit-full-backup-btn").addEventListener("click",editFullBackupData);document.getElementById("import-backup-btn").addEventListener("click",()=>document.getElementById("import-full-backup-input").click())}function setupPlaybookControls(type,title,storageKey){document.getElementById(`edit-${type}-data-btn`).addEventListener("click",()=>editPlaybookData(title,storageKey));document.getElementById(`export-${type}-data-btn`).addEventListener("click",()=>exportDataAsJson(storageKey,`${type}-playbook.json`));document.getElementById(`import-${type}-data-input`).addEventListener("change",e=>handleJsonImport(e,storageKey,title));document.getElementById(`import-${type}-data-btn`).addEventListener("click",()=>document.getElementById(`import-${type}-data-input`).click())}function editPlaybookData(title,storageKey){const currentData=loadFromLocalStorage(storageKey,[]);const modalBodyDiv=document.createElement("div");modalBodyDiv.innerHTML=`<p>You can edit the raw JSON data for the playbook below.</p>\n                                         <label for="json-edit-textarea">JSON Data:</label>\n                                         <textarea id="json-edit-textarea" rows="15" style="width: 100%; font-family: monospace; margin-top: 5px;"></textarea>`;const textarea=modalBodyDiv.querySelector("#json-edit-textarea");textarea.value=JSON.stringify(currentData,null,2);const saveCallback=()=>{try{const newData=JSON.parse(textarea.value);saveToLocalStorage(storageKey,newData);showToast(`${title} updated successfully. Reloading app...`,"success");setTimeout(()=>location.reload(),1500)}catch(error){console.error("JSON parsing error:",error);showToast("Invalid JSON format. Please check your data.","error")}};showModal(`Edit ${title}`,modalBodyDiv,saveCallback,"Save Changes");setTimeout(()=>textarea.focus(),50)}function exportDataAsJson(storageKey,filename){const data=loadFromLocalStorage(storageKey,[]);const jsonString=JSON.stringify(data,null,2);saveFile(jsonString,{fileName:filename,fileType:"application/json",description:"JSON Playbook Data"})}function handleJsonImport(event,storageKey,title){const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=e=>{const confirmCallback=()=>{try{const data=JSON.parse(e.target.result);saveToLocalStorage(storageKey,data);showToast(`${title} imported successfully. Reloading app...`,"success");setTimeout(()=>location.reload(),1500)}catch(error){showToast("Import failed. Invalid JSON file.","error");console.error("Import error:",error)}finally{event.target.value=""}};showModal("Confirm Import",`This will overwrite your current ${title}. Are you sure?`,confirmCallback,"Overwrite")};reader.readAsText(file)}function generateBackupObject(){const backupData={};Object.values(LS_KEYS).forEach(key=>{if(key!==LS_KEYS.geminiApiKey){const keyName=key.replace(LS_PREFIX,"");backupData[keyName]=loadFromLocalStorage(key)}});return{version:"2.0-backup",exportedAt:getCurrentTimestamp(),data:backupData}}function exportFullBackup(){const backupObject=generateBackupObject();const jsonString=JSON.stringify(backupObject,null,2);const dateStamp=(new Date).toISOString().slice(0,10);saveFile(jsonString,{fileName:`guide-app-backup-${dateStamp}.json`,fileType:"application/json",description:"Guide App Full Backup"})}function handleFullBackupImport(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=e=>{const restoreCallback=()=>{try{const backup=JSON.parse(e.target.result);if(!backup.data||!backup.version.startsWith("2.0")){throw new Error("Invalid or incompatible backup file format.")}Object.entries(backup.data).forEach(([keyName,data])=>{const lsKey=LS_PREFIX+keyName;if(Object.values(LS_KEYS).includes(lsKey)){saveToLocalStorage(lsKey,data)}});showToast("Backup restored successfully! Reloading...","success");setTimeout(()=>location.reload(),1500)}catch(error){showToast(`Restore failed: ${error.message}`,"error",5e3);console.error("Restore error:",error)}finally{event.target.value=""}};showModal("Overwrite All Data?","Restoring from a backup will overwrite ALL current data in the app. This cannot be undone. Are you sure?",restoreCallback,"Yes, Overwrite All")};reader.readAsText(file)}function editFullBackupData(){const backupObject=generateBackupObject();const modalBodyDiv=document.createElement("div");modalBodyDiv.innerHTML=`<p><strong>Warning:</strong> Editing this data directly is powerful but risky. Invalid JSON or incorrect structure can cause the app to fail on restore. Always keep a safe copy of your last exported backup.</p>\n                                         <label for="json-edit-textarea">Full Backup JSON Data:</label>\n                                         <textarea id="json-edit-textarea" rows="15" style="width: 100%; font-family: monospace; margin-top: 5px;"></textarea>`;const textarea=modalBodyDiv.querySelector("#json-edit-textarea");textarea.value=JSON.stringify(backupObject,null,2);const saveCallback=()=>{try{const newBackupData=JSON.parse(textarea.value);if(!newBackupData.data||!newBackupData.version){throw new Error("Invalid backup format. Must contain 'version' and 'data' properties.")}Object.entries(newBackupData.data).forEach(([keyName,data])=>{const lsKey=LS_PREFIX+keyName;if(Object.values(LS_KEYS).includes(lsKey)){saveToLocalStorage(lsKey,data)}});showToast("Backup data updated successfully! Reloading...","success");setTimeout(()=>location.reload(),1500)}catch(error){showToast(`Save failed: ${error.message}`,"error",5e3);console.error("Error saving full backup data:",error)}};showModal("Edit Full Backup Data",modalBodyDiv,saveCallback,"Save All Changes");setTimeout(()=>textarea.focus(),50)}window.addEventListener("beforeunload",()=>{if(blitzWorker){blitzWorker.terminate()}if(Object.keys(activeBlitzes).length>0){saveToLocalStorage(LS_PREFIX+"activeBlitzes",activeBlitzes)}});function shouldShowOnboarding(){const completed=loadFromLocalStorage(LS_PREFIX+"onboardingCompleted",false);const isEmpty=pendingTasks.length===0&&goals.length===0&&taskBowl.length===0&&doneTasks.length===0;return!completed&&isEmpty}function renderCategoryCards(){const grid=document.getElementById("category-grid");if(!grid)return;grid.innerHTML=Object.values(CATEGORIES).map(cat=>`\n                    <div class="category-card" data-category="${cat.id}">\n                        <span class="icon">${cat.icon}</span>\n                        <div class="cat-title">${cat.title}</div>\n                        <div class="cat-subtitle">${cat.subtitle}</div>\n                    </div>\n                `).join("");grid.querySelectorAll(".category-card").forEach(card=>{card.addEventListener("click",()=>{const categoryId=card.dataset.category;showCategoryExamples(categoryId)})})}function showCategoryExamples(categoryId){const category=CATEGORIES[categoryId];if(!category)return;const examplesContainer=document.getElementById("examples-container");const titleElement=document.getElementById("example-category-title");if(titleElement){titleElement.textContent=`${category.icon} ${category.title}`}if(!examplesContainer)return;examplesContainer.innerHTML=category.packs.map(packId=>{const pack=STARTER_PACKS[packId];if(!pack)return"";return`\n                        <div class="example-card">\n                            <h3>${pack.goal.text}</h3>\n                            <div class="example-tasks">\n                                <strong>Today's Focus (3 max):</strong>\n                                <ul>\n                                    ${pack.pending.slice(0,3).map(task=>`<li>${task}</li>`).join("")}\n                                </ul>\n                            </div>\n                            <div class="example-tasks">\n                                <strong>Task Bowl (your backlog):</strong>\n                                <ul>\n                                    ${pack.bowl.slice(0,5).map(task=>`<li>${task}</li>`).join("")}\n                                    ${pack.bowl.length>5?`<li style="color: var(--color-text-secondary); font-style: italic;">+ ${pack.bowl.length-5} more tasks...</li>`:""}\n                                </ul>\n                            </div>\n                            <button class="btn btn-primary" data-pack="${packId}">\n                                Use This Example\n                            </button>\n                        </div>\n                    `}).join("");examplesContainer.querySelectorAll("button[data-pack]").forEach(btn=>{btn.addEventListener("click",()=>{const packId=btn.dataset.pack;applyStarterPack(packId)})});document.getElementById("onboarding-category").classList.remove("active");document.getElementById("onboarding-example").classList.add("active")}function applyStarterPack(packId){const pack=STARTER_PACKS[packId];if(!pack)return;const newGoal={id:generateId(),text:pack.goal.text,createdAt:getCurrentTimestamp(),status:GOAL_STATUS.ACTIVE,focusStartDate:null,focusEndDate:null,closedAt:null,closedReason:null};goals.push(newGoal);pack.pending.forEach(taskText=>{pendingTasks.push({id:generateId(),text:taskText,createdAt:getCurrentTimestamp(),goalId:newGoal.id,aiHelpText:null})});pack.bowl.forEach(taskText=>{taskBowl.push({id:generateId(),text:taskText,createdAt:getCurrentTimestamp(),goalId:newGoal.id,aiHelpText:null})});saveToLocalStorage(LS_KEYS.goals,goals);saveToLocalStorage(LS_KEYS.pending,pendingTasks);saveToLocalStorage(LS_KEYS.bowl,taskBowl);completeOnboarding();setTimeout(()=>{showToast(`Great! Start with any of the 3 tasks. Each one builds momentum.`,"success",5e3)},500)}function completeOnboarding(){saveToLocalStorage(LS_PREFIX+"onboardingCompleted",true);showView("main-view");renderPendingTasks();renderGoals();updateCurrentGoalDisplay()}function initOnboarding(){renderCategoryCards();const understandBtn=document.getElementById("understand-btn");const skipPhilosophyBtn=document.getElementById("skip-philosophy-btn");if(understandBtn){understandBtn.addEventListener("click",()=>{document.getElementById("onboarding-philosophy").classList.remove("active");document.getElementById("onboarding-category").classList.add("active")})}if(skipPhilosophyBtn){skipPhilosophyBtn.addEventListener("click",()=>{document.getElementById("onboarding-philosophy").classList.remove("active");document.getElementById("onboarding-category").classList.add("active")})}const exploreDemoBtn=document.getElementById("explore-demo-btn");if(exploreDemoBtn){exploreDemoBtn.addEventListener("click",()=>{loadDemoDataFromConstant();completeOnboarding()})}const backBtn=document.getElementById("back-to-categories");if(backBtn){backBtn.addEventListener("click",()=>{document.getElementById("onboarding-example").classList.remove("active");document.getElementById("onboarding-category").classList.add("active")})}const startFreshBtn=document.getElementById("start-fresh-btn");if(startFreshBtn){startFreshBtn.addEventListener("click",()=>{completeOnboarding();showToast("Start by adding your first goal or task!","info",4e3)})}}function loadDemoDataFromConstant(){Object.entries(DEMO_DATA.data).forEach(([keyName,data])=>{const lsKey=LS_PREFIX+keyName;if(Object.values(LS_KEYS).includes(lsKey)){saveToLocalStorage(lsKey,data)}})}document.addEventListener("DOMContentLoaded",initializeApp)})();
    </script>
</body>
</html>
